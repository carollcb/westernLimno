---
title: "001_LAGOS-US_explore"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir='..')
knitr::opts_chunk$set(out.width = '50%',fig.height=10) 

```


# Load necessary packages
```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#Load appropriate libraries



library(here)
# install.packages(c("cowplot", "googleway", "ggplot2", "ggrepel", 
# "ggspatial", "libwgeom", "sf", "rnaturalearth", "rnaturalearthdata"))
if (!require('ggplot2')) install.packages('ggplot2'); library('ggplot2')
if (!require('patchwork')) install.packages('patchwork'); library('patchwork')
if (!require('ggpubr')) install.packages('ggpubr'); library('ggpubr')
if (!require('colorspace')) install.packages('colorspace'); library('colorspace')#Borrowed some code from their minimum working example: 
theme_set(theme_classic())
library(tidyverse)
library(lubridate)
library(data.table) #for faster data summaries than dplyr

library(GGally)

if (!require('glmnet')) install.packages('glmnet'); library('glmnet')#For LASSO: https://www.statology.org/lasso-regression-in-r/
if (!require('susieR')) install.packages('susieR'); library('susieR')#Borrowed some code from their minimum working example: #https://stephenslab.github.io/susieR/articles/mwe.html



#packages for extreme gradient boosting
if (!require('xgboost')) install.packages('xgboost'); library('xgboost')
if (!require('caret')) install.packages('caret'); library('caret')
if (!require('DiagrammeR')) install.packages('DiagrammeR');
library('DiagrammeR')
if (!require('nhdplusTools')) install.packages('nhdplusTools'); library('nhdplusTools')
if (!require('purrr')) install.packages('purrr'); library('purrr')




#For summary
if (!require('huxtable')) install.packages('huxtable'); library('huxtable')
if (!require('officer')) install.packages('officer'); library('officer')
if (!require('flextable')) install.packages('flextable'); library('flextable')

#Mapping

library("sf")
library("rnaturalearth")
library("rnaturalearthdata")
library("ggspatial")
library(raster)
library(tidytext)
if (!require('nhdplusTools')) install.packages('nhdplusTools'); library('nhdplusTools')
if (!require('maps')) install.packages('maps'); library('maps')


#For sen slopes
library(trend)
library(zyp)

#XG Boost
if (!require('xgboost')) install.packages('xgboost'); library('xgboost')
if (!require('caret')) install.packages('caret'); library('caret')
if (!require('DiagrammeR')) install.packages('DiagrammeR'); library('DiagrammeR')


```

## Functions
```{r}
give.n <- function(x){
  return(c(y = 0.5, label = length(x))) 
  # experiment with the multiplier to find the perfect position
}

#By DCR
#Function: slope differences####
#Calculates all pairwise slope differnces
#Used in Theil sen slope function: sensSlope
slope.differences <- function(i, xx, yy, n){ (yy[1:(n - i)] - yy[(i + 1):n])/(xx[1:(n - i)] - xx[(i + 1):n])}

#Function: Theil Sen's slope (non-parametric slope)####
#Can deal with NAs in the data frame
#Includes output of p-value, slope and intercept
#based on a combination of zyp:zyp.sen and trend:sens.slope
#Implentation:
#sensSlope(testDF.na$Year,testDF.na$Response)
sensSlope<-function (x,y) 
{
  #Figure out the length of the data
  n <- length(x)
  #Get all the pairwise slopes
  slopes <- unlist(lapply(1:(n - 1), slope.differences, x, y, n))
  #Figure out which ones are finite
  sni <- which(is.finite(slopes))
  #Get the median slope of only the finite ones
  slope <- median(slopes[sni])
  #Calculate all the possible intercepts
  intercepts <- y - slope * x
  #Get the median intercept - this is different from zyp.sen because it has na.rm=T
  intercept <- median(intercepts,na.rm=TRUE)
  #Make the y variables into a table
  table <- table(y)
  names(table) <- NULL
  #Adjust table values?
  tadjs <- sum(table * (table - 1) * (2 * table + 5))
  #Not sure what varS signifies
  varS <- (n * (n - 1) * (2 * n + 5) - tadjs)/18
  #Find some boundaries for significance?
  C <- qnorm(1 - (1 -0.95)/2) * sqrt(varS)
  rank.up <- round(((n-1) + C)/2 + 1)
  rank.lo <- round(((n-1) - C)/2)
  rank.d <- sort(slopes[sni])
  lo <- rank.d[rank.lo]
  up <- rank.d[rank.up]
  #mkScore
  S <- 0
  for (j in 1:n) {
    S <- S + sum(sign(y[j] - y[1:j]),na.rm=TRUE)
  }
  
  sg <- sign(S)
  z <- sg * (abs(S) - 1)/sqrt(varS)
  pval <- 2 * min(0.5, pnorm(abs(z), lower.tail = FALSE))
  
  #Compile a list for export
  res <- list(coefficients = c(intercept, slope), 
              residuals = (y - slope * x + intercept), 
              pval=pval,z_stat=z,n=n)
  names(res$coefficients) = c("Intercept", "year")
  return(res)
} 



```

# Compile data

### EDI
```{r}
#Pull from EDI
# https://portal.edirepository.org/nis/mapbrowse?packageid=edi.854.1

# Package ID: edi.854.1 Cataloging System:https://pasta.edirepository.org.
# Data set title: LAGOS-US LOCUS v1.0: Data module of location, identifiers, and physical characteristics of lakes and their watersheds in the conterminous U.S..
# Data set creator:  Nicole Smith - Michigan State University 
# Data set creator:  Katherine Webster - Michigan State University 
# Data set creator:  Lauren Rodriguez - Michigan State University 
# Data set creator:  Kendra Cheruvelil - Michigan State University 
# Data set creator:  Patricia Soranno - Michigan State University 
# Contact:  Kendra Cheruvelil -  Michigan State University  - ksc@msu.edu
# Stylesheet for metadata conversion into program: John H. Porter, Univ. Virginia, jporter@Virginia.edu 
#
#install package tidyverse if not already installed
if(!require(tidyverse)){ install.packages("tidyverse") }  
library("tidyverse") 
infile1 <- trimws("https://pasta.lternet.edu/package/data/eml/edi/854/1/007ca4f5ec02bb5809fc661dcfa7a903") 
infile1 <-sub("^https","http",infile1)
# This creates a tibble named: lakeinformation 
	lakeinformation <-read_delim(infile1  
                ,delim=","   
                ,skip=1 
                    ,quote='"'  
                    , col_names=c( 
                        "lagoslakeid",   
                        "lake_nhdid",   
                        "lake_nhdfcode",   
                        "lake_nhdftype",   
                        "lake_reachcode",   
                        "lake_namegnis",   
                        "lake_namelagos",   
                        "lake_onlandborder",   
                        "lake_ismultipart",   
                        "lake_missingws",   
                        "lake_shapeflag",   
                        "lake_lat_decdeg",   
                        "lake_lon_decdeg",   
                        "lake_elevation_m",   
                        "lake_centroidstate",   
                        "lake_states",   
                        "lake_county",   
                        "lake_countyfips",   
                        "lake_huc12",   
                        "buff100_zoneid",   
                        "buff500_zoneid",   
                        "ws_zoneid",   
                        "nws_zoneid",   
                        "hu12_zoneid",   
                        "hu8_zoneid",   
                        "hu4_zoneid",   
                        "county_zoneid",   
                        "state_zoneid",   
                        "epanutr_zoneid",   
                        "omernik3_zoneid",   
                        "wwf_zoneid",   
                        "mlra_zoneid",   
                        "bailey_zoneid",   
                        "neon_zoneid"   ), 
                    col_types=list(
                        col_number() ,  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(), 
                        col_number() , 
                        col_number() , 
                        col_number() ,  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character()), 
                        na=c(" ",".","NA")  )
                        
                    
# Convert Missing Values to NA for individual vectors 
lakeinformation$lagoslakeid <- ifelse((trimws(as.character(lakeinformation$lagoslakeid))==trimws("NA")),NA,lakeinformation$lagoslakeid)               
suppressWarnings(lakeinformation$lagoslakeid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$lagoslakeid))==as.character(as.numeric("NA"))),NA,lakeinformation$lagoslakeid))
lakeinformation$lake_nhdid <- ifelse((trimws(as.character(lakeinformation$lake_nhdid))==trimws("NA")),NA,lakeinformation$lake_nhdid)               
suppressWarnings(lakeinformation$lake_nhdid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$lake_nhdid))==as.character(as.numeric("NA"))),NA,lakeinformation$lake_nhdid))
lakeinformation$lake_nhdfcode <- ifelse((trimws(as.character(lakeinformation$lake_nhdfcode))==trimws("NA")),NA,lakeinformation$lake_nhdfcode)               
suppressWarnings(lakeinformation$lake_nhdfcode <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$lake_nhdfcode))==as.character(as.numeric("NA"))),NA,lakeinformation$lake_nhdfcode))
lakeinformation$lake_nhdftype <- ifelse((trimws(as.character(lakeinformation$lake_nhdftype))==trimws("NA")),NA,lakeinformation$lake_nhdftype)               
suppressWarnings(lakeinformation$lake_nhdftype <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$lake_nhdftype))==as.character(as.numeric("NA"))),NA,lakeinformation$lake_nhdftype))
lakeinformation$lake_reachcode <- ifelse((trimws(as.character(lakeinformation$lake_reachcode))==trimws("NA")),NA,lakeinformation$lake_reachcode)               
suppressWarnings(lakeinformation$lake_reachcode <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$lake_reachcode))==as.character(as.numeric("NA"))),NA,lakeinformation$lake_reachcode))
lakeinformation$lake_namegnis <- ifelse((trimws(as.character(lakeinformation$lake_namegnis))==trimws("NA")),NA,lakeinformation$lake_namegnis)               
suppressWarnings(lakeinformation$lake_namegnis <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$lake_namegnis))==as.character(as.numeric("NA"))),NA,lakeinformation$lake_namegnis))
lakeinformation$lake_namelagos <- ifelse((trimws(as.character(lakeinformation$lake_namelagos))==trimws("NA")),NA,lakeinformation$lake_namelagos)               
suppressWarnings(lakeinformation$lake_namelagos <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$lake_namelagos))==as.character(as.numeric("NA"))),NA,lakeinformation$lake_namelagos))
lakeinformation$lake_onlandborder <- ifelse((trimws(as.character(lakeinformation$lake_onlandborder))==trimws("NA")),NA,lakeinformation$lake_onlandborder)               
suppressWarnings(lakeinformation$lake_onlandborder <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$lake_onlandborder))==as.character(as.numeric("NA"))),NA,lakeinformation$lake_onlandborder))
lakeinformation$lake_ismultipart <- ifelse((trimws(as.character(lakeinformation$lake_ismultipart))==trimws("NA")),NA,lakeinformation$lake_ismultipart)               
suppressWarnings(lakeinformation$lake_ismultipart <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$lake_ismultipart))==as.character(as.numeric("NA"))),NA,lakeinformation$lake_ismultipart))
lakeinformation$lake_missingws <- ifelse((trimws(as.character(lakeinformation$lake_missingws))==trimws("NA")),NA,lakeinformation$lake_missingws)               
suppressWarnings(lakeinformation$lake_missingws <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$lake_missingws))==as.character(as.numeric("NA"))),NA,lakeinformation$lake_missingws))
lakeinformation$lake_shapeflag <- ifelse((trimws(as.character(lakeinformation$lake_shapeflag))==trimws("NA")),NA,lakeinformation$lake_shapeflag)               
suppressWarnings(lakeinformation$lake_shapeflag <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$lake_shapeflag))==as.character(as.numeric("NA"))),NA,lakeinformation$lake_shapeflag))
lakeinformation$lake_lat_decdeg <- ifelse((trimws(as.character(lakeinformation$lake_lat_decdeg))==trimws("NA")),NA,lakeinformation$lake_lat_decdeg)               
suppressWarnings(lakeinformation$lake_lat_decdeg <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$lake_lat_decdeg))==as.character(as.numeric("NA"))),NA,lakeinformation$lake_lat_decdeg))
lakeinformation$lake_lon_decdeg <- ifelse((trimws(as.character(lakeinformation$lake_lon_decdeg))==trimws("NA")),NA,lakeinformation$lake_lon_decdeg)               
suppressWarnings(lakeinformation$lake_lon_decdeg <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$lake_lon_decdeg))==as.character(as.numeric("NA"))),NA,lakeinformation$lake_lon_decdeg))
lakeinformation$lake_elevation_m <- ifelse((trimws(as.character(lakeinformation$lake_elevation_m))==trimws("NA")),NA,lakeinformation$lake_elevation_m)               
suppressWarnings(lakeinformation$lake_elevation_m <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$lake_elevation_m))==as.character(as.numeric("NA"))),NA,lakeinformation$lake_elevation_m))
lakeinformation$lake_centroidstate <- ifelse((trimws(as.character(lakeinformation$lake_centroidstate))==trimws("NA")),NA,lakeinformation$lake_centroidstate)               
suppressWarnings(lakeinformation$lake_centroidstate <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$lake_centroidstate))==as.character(as.numeric("NA"))),NA,lakeinformation$lake_centroidstate))
lakeinformation$lake_states <- ifelse((trimws(as.character(lakeinformation$lake_states))==trimws("NA")),NA,lakeinformation$lake_states)               
suppressWarnings(lakeinformation$lake_states <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$lake_states))==as.character(as.numeric("NA"))),NA,lakeinformation$lake_states))
lakeinformation$lake_county <- ifelse((trimws(as.character(lakeinformation$lake_county))==trimws("NA")),NA,lakeinformation$lake_county)               
suppressWarnings(lakeinformation$lake_county <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$lake_county))==as.character(as.numeric("NA"))),NA,lakeinformation$lake_county))
lakeinformation$lake_countyfips <- ifelse((trimws(as.character(lakeinformation$lake_countyfips))==trimws("NA")),NA,lakeinformation$lake_countyfips)               
suppressWarnings(lakeinformation$lake_countyfips <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$lake_countyfips))==as.character(as.numeric("NA"))),NA,lakeinformation$lake_countyfips))
lakeinformation$lake_huc12 <- ifelse((trimws(as.character(lakeinformation$lake_huc12))==trimws("NA")),NA,lakeinformation$lake_huc12)               
suppressWarnings(lakeinformation$lake_huc12 <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$lake_huc12))==as.character(as.numeric("NA"))),NA,lakeinformation$lake_huc12))
lakeinformation$buff100_zoneid <- ifelse((trimws(as.character(lakeinformation$buff100_zoneid))==trimws("NA")),NA,lakeinformation$buff100_zoneid)               
suppressWarnings(lakeinformation$buff100_zoneid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$buff100_zoneid))==as.character(as.numeric("NA"))),NA,lakeinformation$buff100_zoneid))
lakeinformation$buff500_zoneid <- ifelse((trimws(as.character(lakeinformation$buff500_zoneid))==trimws("NA")),NA,lakeinformation$buff500_zoneid)               
suppressWarnings(lakeinformation$buff500_zoneid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$buff500_zoneid))==as.character(as.numeric("NA"))),NA,lakeinformation$buff500_zoneid))
lakeinformation$ws_zoneid <- ifelse((trimws(as.character(lakeinformation$ws_zoneid))==trimws("NA")),NA,lakeinformation$ws_zoneid)               
suppressWarnings(lakeinformation$ws_zoneid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$ws_zoneid))==as.character(as.numeric("NA"))),NA,lakeinformation$ws_zoneid))
lakeinformation$nws_zoneid <- ifelse((trimws(as.character(lakeinformation$nws_zoneid))==trimws("NA")),NA,lakeinformation$nws_zoneid)               
suppressWarnings(lakeinformation$nws_zoneid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$nws_zoneid))==as.character(as.numeric("NA"))),NA,lakeinformation$nws_zoneid))
lakeinformation$hu12_zoneid <- ifelse((trimws(as.character(lakeinformation$hu12_zoneid))==trimws("NA")),NA,lakeinformation$hu12_zoneid)               
suppressWarnings(lakeinformation$hu12_zoneid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$hu12_zoneid))==as.character(as.numeric("NA"))),NA,lakeinformation$hu12_zoneid))
lakeinformation$hu8_zoneid <- ifelse((trimws(as.character(lakeinformation$hu8_zoneid))==trimws("NA")),NA,lakeinformation$hu8_zoneid)               
suppressWarnings(lakeinformation$hu8_zoneid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$hu8_zoneid))==as.character(as.numeric("NA"))),NA,lakeinformation$hu8_zoneid))
lakeinformation$hu4_zoneid <- ifelse((trimws(as.character(lakeinformation$hu4_zoneid))==trimws("NA")),NA,lakeinformation$hu4_zoneid)               
suppressWarnings(lakeinformation$hu4_zoneid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$hu4_zoneid))==as.character(as.numeric("NA"))),NA,lakeinformation$hu4_zoneid))
lakeinformation$county_zoneid <- ifelse((trimws(as.character(lakeinformation$county_zoneid))==trimws("NA")),NA,lakeinformation$county_zoneid)               
suppressWarnings(lakeinformation$county_zoneid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$county_zoneid))==as.character(as.numeric("NA"))),NA,lakeinformation$county_zoneid))
lakeinformation$state_zoneid <- ifelse((trimws(as.character(lakeinformation$state_zoneid))==trimws("NA")),NA,lakeinformation$state_zoneid)               
suppressWarnings(lakeinformation$state_zoneid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$state_zoneid))==as.character(as.numeric("NA"))),NA,lakeinformation$state_zoneid))
lakeinformation$epanutr_zoneid <- ifelse((trimws(as.character(lakeinformation$epanutr_zoneid))==trimws("NA")),NA,lakeinformation$epanutr_zoneid)               
suppressWarnings(lakeinformation$epanutr_zoneid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$epanutr_zoneid))==as.character(as.numeric("NA"))),NA,lakeinformation$epanutr_zoneid))
lakeinformation$omernik3_zoneid <- ifelse((trimws(as.character(lakeinformation$omernik3_zoneid))==trimws("NA")),NA,lakeinformation$omernik3_zoneid)               
suppressWarnings(lakeinformation$omernik3_zoneid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$omernik3_zoneid))==as.character(as.numeric("NA"))),NA,lakeinformation$omernik3_zoneid))
lakeinformation$wwf_zoneid <- ifelse((trimws(as.character(lakeinformation$wwf_zoneid))==trimws("NA")),NA,lakeinformation$wwf_zoneid)               
suppressWarnings(lakeinformation$wwf_zoneid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$wwf_zoneid))==as.character(as.numeric("NA"))),NA,lakeinformation$wwf_zoneid))
lakeinformation$mlra_zoneid <- ifelse((trimws(as.character(lakeinformation$mlra_zoneid))==trimws("NA")),NA,lakeinformation$mlra_zoneid)               
suppressWarnings(lakeinformation$mlra_zoneid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$mlra_zoneid))==as.character(as.numeric("NA"))),NA,lakeinformation$mlra_zoneid))
lakeinformation$bailey_zoneid <- ifelse((trimws(as.character(lakeinformation$bailey_zoneid))==trimws("NA")),NA,lakeinformation$bailey_zoneid)               
suppressWarnings(lakeinformation$bailey_zoneid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$bailey_zoneid))==as.character(as.numeric("NA"))),NA,lakeinformation$bailey_zoneid))
lakeinformation$neon_zoneid <- ifelse((trimws(as.character(lakeinformation$neon_zoneid))==trimws("NA")),NA,lakeinformation$neon_zoneid)               
suppressWarnings(lakeinformation$neon_zoneid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakeinformation$neon_zoneid))==as.character(as.numeric("NA"))),NA,lakeinformation$neon_zoneid))
                    
                
# Observed issues when reading the data. An empty list is good!
problems(lakeinformation) 
# Here is the structure of the input data tibble: 
glimpse(lakeinformation) 
# And some statistical summaries of the data 
summary(lakeinformation) 
# Get more details on character variables
                     
summary(as.factor(lakeinformation$lake_nhdid)) 
summary(as.factor(lakeinformation$lake_nhdfcode)) 
summary(as.factor(lakeinformation$lake_nhdftype)) 
summary(as.factor(lakeinformation$lake_reachcode)) 
summary(as.factor(lakeinformation$lake_namegnis)) 
summary(as.factor(lakeinformation$lake_namelagos)) 
summary(as.factor(lakeinformation$lake_onlandborder)) 
summary(as.factor(lakeinformation$lake_ismultipart)) 
summary(as.factor(lakeinformation$lake_missingws)) 
summary(as.factor(lakeinformation$lake_shapeflag)) 
summary(as.factor(lakeinformation$lake_centroidstate)) 
summary(as.factor(lakeinformation$lake_states)) 
summary(as.factor(lakeinformation$lake_county)) 
summary(as.factor(lakeinformation$lake_countyfips)) 
summary(as.factor(lakeinformation$lake_huc12)) 
summary(as.factor(lakeinformation$buff100_zoneid)) 
summary(as.factor(lakeinformation$buff500_zoneid)) 
summary(as.factor(lakeinformation$ws_zoneid)) 
summary(as.factor(lakeinformation$nws_zoneid)) 
summary(as.factor(lakeinformation$hu12_zoneid)) 
summary(as.factor(lakeinformation$hu8_zoneid)) 
summary(as.factor(lakeinformation$hu4_zoneid)) 
summary(as.factor(lakeinformation$county_zoneid)) 
summary(as.factor(lakeinformation$state_zoneid)) 
summary(as.factor(lakeinformation$epanutr_zoneid)) 
summary(as.factor(lakeinformation$omernik3_zoneid)) 
summary(as.factor(lakeinformation$wwf_zoneid)) 
summary(as.factor(lakeinformation$mlra_zoneid)) 
summary(as.factor(lakeinformation$bailey_zoneid)) 
summary(as.factor(lakeinformation$neon_zoneid)) 


infile2 <- trimws("https://pasta.lternet.edu/package/data/eml/edi/854/1/fd7fe936d290a12bc6dbf5c41047849e") 
infile2 <-sub("^https","http",infile2)
# This creates a tibble named: lakecharacteristics 
	lakecharacteristics <-read_delim(infile2  
                ,delim=","   
                ,skip=1 
                    ,quote='"'  
                    , col_names=c( 
                        "lagoslakeid",   
                        "lake_waterarea_ha",   
                        "lake_totalarea_ha",   
                        "lake_islandarea_ha",   
                        "lake_perimeter_m",   
                        "lake_islandperimeter_m",   
                        "lake_shorelinedevfactor",   
                        "lake_mbgconhull_length_m",   
                        "lake_mbgconhull_width_m",   
                        "lake_mbgconhull_orientation_deg",   
                        "lake_mbgrect_length_m",   
                        "lake_mbgrect_width_m",   
                        "lake_mbgrect_arearatio",   
                        "lake_meanwidth_m",   
                        "lake_connectivity_class",   
                        "lake_connectivity_fluctuates",   
                        "lake_connectivity_permanent",   
                        "lake_lakes4ha_upstream_ha",   
                        "lake_lakes4ha_upstream_n",   
                        "lake_lakes1ha_upstream_ha",   
                        "lake_lakes1ha_upstream_n",   
                        "lake_lakes10ha_upstream_n",   
                        "lake_lakes10ha_upstream_ha",   
                        "lake_glaciatedlatewisc"   ), 
                    col_types=list(
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() ,  
                        col_character(),  
                        col_character(),  
                        col_character(), 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() ,  
                        col_character()), 
                        na=c(" ",".","NA")  )
                        
                    
# Convert Missing Values to NA for individual vectors 
lakecharacteristics$lagoslakeid <- ifelse((trimws(as.character(lakecharacteristics$lagoslakeid))==trimws("NA")),NA,lakecharacteristics$lagoslakeid)               
suppressWarnings(lakecharacteristics$lagoslakeid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lagoslakeid))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lagoslakeid))
lakecharacteristics$lake_waterarea_ha <- ifelse((trimws(as.character(lakecharacteristics$lake_waterarea_ha))==trimws("NA")),NA,lakecharacteristics$lake_waterarea_ha)               
suppressWarnings(lakecharacteristics$lake_waterarea_ha <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_waterarea_ha))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_waterarea_ha))
lakecharacteristics$lake_totalarea_ha <- ifelse((trimws(as.character(lakecharacteristics$lake_totalarea_ha))==trimws("NA")),NA,lakecharacteristics$lake_totalarea_ha)               
suppressWarnings(lakecharacteristics$lake_totalarea_ha <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_totalarea_ha))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_totalarea_ha))
lakecharacteristics$lake_islandarea_ha <- ifelse((trimws(as.character(lakecharacteristics$lake_islandarea_ha))==trimws("NA")),NA,lakecharacteristics$lake_islandarea_ha)               
suppressWarnings(lakecharacteristics$lake_islandarea_ha <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_islandarea_ha))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_islandarea_ha))
lakecharacteristics$lake_perimeter_m <- ifelse((trimws(as.character(lakecharacteristics$lake_perimeter_m))==trimws("NA")),NA,lakecharacteristics$lake_perimeter_m)               
suppressWarnings(lakecharacteristics$lake_perimeter_m <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_perimeter_m))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_perimeter_m))
lakecharacteristics$lake_islandperimeter_m <- ifelse((trimws(as.character(lakecharacteristics$lake_islandperimeter_m))==trimws("NA")),NA,lakecharacteristics$lake_islandperimeter_m)               
suppressWarnings(lakecharacteristics$lake_islandperimeter_m <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_islandperimeter_m))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_islandperimeter_m))
lakecharacteristics$lake_shorelinedevfactor <- ifelse((trimws(as.character(lakecharacteristics$lake_shorelinedevfactor))==trimws("NA")),NA,lakecharacteristics$lake_shorelinedevfactor)               
suppressWarnings(lakecharacteristics$lake_shorelinedevfactor <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_shorelinedevfactor))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_shorelinedevfactor))
lakecharacteristics$lake_mbgconhull_length_m <- ifelse((trimws(as.character(lakecharacteristics$lake_mbgconhull_length_m))==trimws("NA")),NA,lakecharacteristics$lake_mbgconhull_length_m)               
suppressWarnings(lakecharacteristics$lake_mbgconhull_length_m <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_mbgconhull_length_m))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_mbgconhull_length_m))
lakecharacteristics$lake_mbgconhull_width_m <- ifelse((trimws(as.character(lakecharacteristics$lake_mbgconhull_width_m))==trimws("NA")),NA,lakecharacteristics$lake_mbgconhull_width_m)               
suppressWarnings(lakecharacteristics$lake_mbgconhull_width_m <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_mbgconhull_width_m))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_mbgconhull_width_m))
lakecharacteristics$lake_mbgconhull_orientation_deg <- ifelse((trimws(as.character(lakecharacteristics$lake_mbgconhull_orientation_deg))==trimws("NA")),NA,lakecharacteristics$lake_mbgconhull_orientation_deg)               
suppressWarnings(lakecharacteristics$lake_mbgconhull_orientation_deg <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_mbgconhull_orientation_deg))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_mbgconhull_orientation_deg))
lakecharacteristics$lake_mbgrect_length_m <- ifelse((trimws(as.character(lakecharacteristics$lake_mbgrect_length_m))==trimws("NA")),NA,lakecharacteristics$lake_mbgrect_length_m)               
suppressWarnings(lakecharacteristics$lake_mbgrect_length_m <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_mbgrect_length_m))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_mbgrect_length_m))
lakecharacteristics$lake_mbgrect_width_m <- ifelse((trimws(as.character(lakecharacteristics$lake_mbgrect_width_m))==trimws("NA")),NA,lakecharacteristics$lake_mbgrect_width_m)               
suppressWarnings(lakecharacteristics$lake_mbgrect_width_m <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_mbgrect_width_m))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_mbgrect_width_m))
lakecharacteristics$lake_mbgrect_arearatio <- ifelse((trimws(as.character(lakecharacteristics$lake_mbgrect_arearatio))==trimws("NA")),NA,lakecharacteristics$lake_mbgrect_arearatio)               
suppressWarnings(lakecharacteristics$lake_mbgrect_arearatio <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_mbgrect_arearatio))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_mbgrect_arearatio))
lakecharacteristics$lake_meanwidth_m <- ifelse((trimws(as.character(lakecharacteristics$lake_meanwidth_m))==trimws("NA")),NA,lakecharacteristics$lake_meanwidth_m)               
suppressWarnings(lakecharacteristics$lake_meanwidth_m <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_meanwidth_m))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_meanwidth_m))
lakecharacteristics$lake_connectivity_class <- ifelse((trimws(as.character(lakecharacteristics$lake_connectivity_class))==trimws("NA")),NA,lakecharacteristics$lake_connectivity_class)               
suppressWarnings(lakecharacteristics$lake_connectivity_class <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_connectivity_class))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_connectivity_class))
lakecharacteristics$lake_connectivity_fluctuates <- ifelse((trimws(as.character(lakecharacteristics$lake_connectivity_fluctuates))==trimws("NA")),NA,lakecharacteristics$lake_connectivity_fluctuates)               
suppressWarnings(lakecharacteristics$lake_connectivity_fluctuates <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_connectivity_fluctuates))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_connectivity_fluctuates))
lakecharacteristics$lake_connectivity_permanent <- ifelse((trimws(as.character(lakecharacteristics$lake_connectivity_permanent))==trimws("NA")),NA,lakecharacteristics$lake_connectivity_permanent)               
suppressWarnings(lakecharacteristics$lake_connectivity_permanent <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_connectivity_permanent))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_connectivity_permanent))
lakecharacteristics$lake_lakes4ha_upstream_ha <- ifelse((trimws(as.character(lakecharacteristics$lake_lakes4ha_upstream_ha))==trimws("NA")),NA,lakecharacteristics$lake_lakes4ha_upstream_ha)               
suppressWarnings(lakecharacteristics$lake_lakes4ha_upstream_ha <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_lakes4ha_upstream_ha))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_lakes4ha_upstream_ha))
lakecharacteristics$lake_lakes4ha_upstream_n <- ifelse((trimws(as.character(lakecharacteristics$lake_lakes4ha_upstream_n))==trimws("NA")),NA,lakecharacteristics$lake_lakes4ha_upstream_n)               
suppressWarnings(lakecharacteristics$lake_lakes4ha_upstream_n <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_lakes4ha_upstream_n))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_lakes4ha_upstream_n))
lakecharacteristics$lake_lakes1ha_upstream_ha <- ifelse((trimws(as.character(lakecharacteristics$lake_lakes1ha_upstream_ha))==trimws("NA")),NA,lakecharacteristics$lake_lakes1ha_upstream_ha)               
suppressWarnings(lakecharacteristics$lake_lakes1ha_upstream_ha <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_lakes1ha_upstream_ha))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_lakes1ha_upstream_ha))
lakecharacteristics$lake_lakes1ha_upstream_n <- ifelse((trimws(as.character(lakecharacteristics$lake_lakes1ha_upstream_n))==trimws("NA")),NA,lakecharacteristics$lake_lakes1ha_upstream_n)               
suppressWarnings(lakecharacteristics$lake_lakes1ha_upstream_n <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_lakes1ha_upstream_n))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_lakes1ha_upstream_n))
lakecharacteristics$lake_lakes10ha_upstream_n <- ifelse((trimws(as.character(lakecharacteristics$lake_lakes10ha_upstream_n))==trimws("NA")),NA,lakecharacteristics$lake_lakes10ha_upstream_n)               
suppressWarnings(lakecharacteristics$lake_lakes10ha_upstream_n <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_lakes10ha_upstream_n))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_lakes10ha_upstream_n))
lakecharacteristics$lake_lakes10ha_upstream_ha <- ifelse((trimws(as.character(lakecharacteristics$lake_lakes10ha_upstream_ha))==trimws("NA")),NA,lakecharacteristics$lake_lakes10ha_upstream_ha)               
suppressWarnings(lakecharacteristics$lake_lakes10ha_upstream_ha <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_lakes10ha_upstream_ha))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_lakes10ha_upstream_ha))
lakecharacteristics$lake_glaciatedlatewisc <- ifelse((trimws(as.character(lakecharacteristics$lake_glaciatedlatewisc))==trimws("NA")),NA,lakecharacteristics$lake_glaciatedlatewisc)               
suppressWarnings(lakecharacteristics$lake_glaciatedlatewisc <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakecharacteristics$lake_glaciatedlatewisc))==as.character(as.numeric("NA"))),NA,lakecharacteristics$lake_glaciatedlatewisc))
                    
                
# Observed issues when reading the data. An empty list is good!
problems(lakecharacteristics) 
# Here is the structure of the input data tibble: 
glimpse(lakecharacteristics) 
# And some statistical summaries of the data 
summary(lakecharacteristics) 
# Get more details on character variables
                     
summary(as.factor(lakecharacteristics$lake_connectivity_class)) 
summary(as.factor(lakecharacteristics$lake_connectivity_fluctuates)) 
summary(as.factor(lakecharacteristics$lake_connectivity_permanent)) 
summary(as.factor(lakecharacteristics$lake_glaciatedlatewisc)) 


infile3 <- trimws("https://pasta.lternet.edu/package/data/eml/edi/854/1/8bd86b94234a21a74991eca7bd9ab883") 
infile3 <-sub("^https","http",infile3)
# This creates a tibble named: lakewatersheds 
	lakewatersheds <-read_delim(infile3  
                ,delim=","   
                ,skip=1 
                    ,quote='"'  
                    , col_names=c( 
                        "lagoslakeid",   
                        "ws_zoneid",   
                        "nws_zoneid",   
                        "ws_subtype",   
                        "ws_equalsnws",   
                        "ws_onlandborder",   
                        "ws_oncoast",   
                        "ws_inusa_pct",   
                        "ws_includeshu4inlet",   
                        "ws_ismultipart",   
                        "ws_sliverflag",   
                        "nws_onlandborder",   
                        "nws_oncoast",   
                        "nws_inusa_pct",   
                        "nws_includeshu4inlet",   
                        "nws_ismultipart",   
                        "ws_states",   
                        "ws_focallakewaterarea_ha",   
                        "ws_area_ha",   
                        "ws_perimeter_m",   
                        "ws_lake_arearatio",   
                        "ws_mbgconhull_length_m",   
                        "ws_mbgconhull_width_m",   
                        "ws_mbgconhull_orientation_deg",   
                        "ws_meanwidth_m",   
                        "ws_lat_decdeg",   
                        "ws_lon_decdeg",   
                        "nws_states",   
                        "nws_focallakewaterarea_ha",   
                        "nws_area_ha",   
                        "nws_perimeter_m",   
                        "nws_lake_arearatio",   
                        "nws_mbgconhull_length_m",   
                        "nws_mbgconhull_width_m",   
                        "nws_mbgconhull_orientation_deg",   
                        "nws_meanwidth_m",   
                        "nws_lat_decdeg",   
                        "nws_lon_decdeg"   ), 
                    col_types=list(
                        col_number() ,  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(), 
                        col_number() ,  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(), 
                        col_number() ,  
                        col_character(),  
                        col_character(),  
                        col_character(), 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() ,  
                        col_character(), 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() ), 
                        na=c(" ",".","NA")  )
                        
                    
# Convert Missing Values to NA for individual vectors 
lakewatersheds$lagoslakeid <- ifelse((trimws(as.character(lakewatersheds$lagoslakeid))==trimws("NA")),NA,lakewatersheds$lagoslakeid)               
suppressWarnings(lakewatersheds$lagoslakeid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$lagoslakeid))==as.character(as.numeric("NA"))),NA,lakewatersheds$lagoslakeid))
lakewatersheds$ws_zoneid <- ifelse((trimws(as.character(lakewatersheds$ws_zoneid))==trimws("NA")),NA,lakewatersheds$ws_zoneid)               
suppressWarnings(lakewatersheds$ws_zoneid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_zoneid))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_zoneid))
lakewatersheds$nws_zoneid <- ifelse((trimws(as.character(lakewatersheds$nws_zoneid))==trimws("NA")),NA,lakewatersheds$nws_zoneid)               
suppressWarnings(lakewatersheds$nws_zoneid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$nws_zoneid))==as.character(as.numeric("NA"))),NA,lakewatersheds$nws_zoneid))
lakewatersheds$ws_subtype <- ifelse((trimws(as.character(lakewatersheds$ws_subtype))==trimws("NA")),NA,lakewatersheds$ws_subtype)               
suppressWarnings(lakewatersheds$ws_subtype <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_subtype))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_subtype))
lakewatersheds$ws_equalsnws <- ifelse((trimws(as.character(lakewatersheds$ws_equalsnws))==trimws("NA")),NA,lakewatersheds$ws_equalsnws)               
suppressWarnings(lakewatersheds$ws_equalsnws <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_equalsnws))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_equalsnws))
lakewatersheds$ws_onlandborder <- ifelse((trimws(as.character(lakewatersheds$ws_onlandborder))==trimws("NA")),NA,lakewatersheds$ws_onlandborder)               
suppressWarnings(lakewatersheds$ws_onlandborder <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_onlandborder))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_onlandborder))
lakewatersheds$ws_oncoast <- ifelse((trimws(as.character(lakewatersheds$ws_oncoast))==trimws("NA")),NA,lakewatersheds$ws_oncoast)               
suppressWarnings(lakewatersheds$ws_oncoast <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_oncoast))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_oncoast))
lakewatersheds$ws_inusa_pct <- ifelse((trimws(as.character(lakewatersheds$ws_inusa_pct))==trimws("NA")),NA,lakewatersheds$ws_inusa_pct)               
suppressWarnings(lakewatersheds$ws_inusa_pct <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_inusa_pct))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_inusa_pct))
lakewatersheds$ws_includeshu4inlet <- ifelse((trimws(as.character(lakewatersheds$ws_includeshu4inlet))==trimws("NA")),NA,lakewatersheds$ws_includeshu4inlet)               
suppressWarnings(lakewatersheds$ws_includeshu4inlet <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_includeshu4inlet))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_includeshu4inlet))
lakewatersheds$ws_ismultipart <- ifelse((trimws(as.character(lakewatersheds$ws_ismultipart))==trimws("NA")),NA,lakewatersheds$ws_ismultipart)               
suppressWarnings(lakewatersheds$ws_ismultipart <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_ismultipart))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_ismultipart))
lakewatersheds$ws_sliverflag <- ifelse((trimws(as.character(lakewatersheds$ws_sliverflag))==trimws("NA")),NA,lakewatersheds$ws_sliverflag)               
suppressWarnings(lakewatersheds$ws_sliverflag <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_sliverflag))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_sliverflag))
lakewatersheds$nws_onlandborder <- ifelse((trimws(as.character(lakewatersheds$nws_onlandborder))==trimws("NA")),NA,lakewatersheds$nws_onlandborder)               
suppressWarnings(lakewatersheds$nws_onlandborder <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$nws_onlandborder))==as.character(as.numeric("NA"))),NA,lakewatersheds$nws_onlandborder))
lakewatersheds$nws_oncoast <- ifelse((trimws(as.character(lakewatersheds$nws_oncoast))==trimws("NA")),NA,lakewatersheds$nws_oncoast)               
suppressWarnings(lakewatersheds$nws_oncoast <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$nws_oncoast))==as.character(as.numeric("NA"))),NA,lakewatersheds$nws_oncoast))
lakewatersheds$nws_inusa_pct <- ifelse((trimws(as.character(lakewatersheds$nws_inusa_pct))==trimws("NA")),NA,lakewatersheds$nws_inusa_pct)               
suppressWarnings(lakewatersheds$nws_inusa_pct <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$nws_inusa_pct))==as.character(as.numeric("NA"))),NA,lakewatersheds$nws_inusa_pct))
lakewatersheds$nws_includeshu4inlet <- ifelse((trimws(as.character(lakewatersheds$nws_includeshu4inlet))==trimws("NA")),NA,lakewatersheds$nws_includeshu4inlet)               
suppressWarnings(lakewatersheds$nws_includeshu4inlet <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$nws_includeshu4inlet))==as.character(as.numeric("NA"))),NA,lakewatersheds$nws_includeshu4inlet))
lakewatersheds$nws_ismultipart <- ifelse((trimws(as.character(lakewatersheds$nws_ismultipart))==trimws("NA")),NA,lakewatersheds$nws_ismultipart)               
suppressWarnings(lakewatersheds$nws_ismultipart <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$nws_ismultipart))==as.character(as.numeric("NA"))),NA,lakewatersheds$nws_ismultipart))
lakewatersheds$ws_states <- ifelse((trimws(as.character(lakewatersheds$ws_states))==trimws("NA")),NA,lakewatersheds$ws_states)               
suppressWarnings(lakewatersheds$ws_states <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_states))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_states))
lakewatersheds$ws_focallakewaterarea_ha <- ifelse((trimws(as.character(lakewatersheds$ws_focallakewaterarea_ha))==trimws("NA")),NA,lakewatersheds$ws_focallakewaterarea_ha)               
suppressWarnings(lakewatersheds$ws_focallakewaterarea_ha <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_focallakewaterarea_ha))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_focallakewaterarea_ha))
lakewatersheds$ws_area_ha <- ifelse((trimws(as.character(lakewatersheds$ws_area_ha))==trimws("NA")),NA,lakewatersheds$ws_area_ha)               
suppressWarnings(lakewatersheds$ws_area_ha <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_area_ha))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_area_ha))
lakewatersheds$ws_perimeter_m <- ifelse((trimws(as.character(lakewatersheds$ws_perimeter_m))==trimws("NA")),NA,lakewatersheds$ws_perimeter_m)               
suppressWarnings(lakewatersheds$ws_perimeter_m <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_perimeter_m))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_perimeter_m))
lakewatersheds$ws_lake_arearatio <- ifelse((trimws(as.character(lakewatersheds$ws_lake_arearatio))==trimws("NA")),NA,lakewatersheds$ws_lake_arearatio)               
suppressWarnings(lakewatersheds$ws_lake_arearatio <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_lake_arearatio))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_lake_arearatio))
lakewatersheds$ws_mbgconhull_length_m <- ifelse((trimws(as.character(lakewatersheds$ws_mbgconhull_length_m))==trimws("NA")),NA,lakewatersheds$ws_mbgconhull_length_m)               
suppressWarnings(lakewatersheds$ws_mbgconhull_length_m <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_mbgconhull_length_m))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_mbgconhull_length_m))
lakewatersheds$ws_mbgconhull_width_m <- ifelse((trimws(as.character(lakewatersheds$ws_mbgconhull_width_m))==trimws("NA")),NA,lakewatersheds$ws_mbgconhull_width_m)               
suppressWarnings(lakewatersheds$ws_mbgconhull_width_m <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_mbgconhull_width_m))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_mbgconhull_width_m))
lakewatersheds$ws_mbgconhull_orientation_deg <- ifelse((trimws(as.character(lakewatersheds$ws_mbgconhull_orientation_deg))==trimws("NA")),NA,lakewatersheds$ws_mbgconhull_orientation_deg)               
suppressWarnings(lakewatersheds$ws_mbgconhull_orientation_deg <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_mbgconhull_orientation_deg))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_mbgconhull_orientation_deg))
lakewatersheds$ws_meanwidth_m <- ifelse((trimws(as.character(lakewatersheds$ws_meanwidth_m))==trimws("NA")),NA,lakewatersheds$ws_meanwidth_m)               
suppressWarnings(lakewatersheds$ws_meanwidth_m <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_meanwidth_m))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_meanwidth_m))
lakewatersheds$ws_lat_decdeg <- ifelse((trimws(as.character(lakewatersheds$ws_lat_decdeg))==trimws("NA")),NA,lakewatersheds$ws_lat_decdeg)               
suppressWarnings(lakewatersheds$ws_lat_decdeg <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_lat_decdeg))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_lat_decdeg))
lakewatersheds$ws_lon_decdeg <- ifelse((trimws(as.character(lakewatersheds$ws_lon_decdeg))==trimws("NA")),NA,lakewatersheds$ws_lon_decdeg)               
suppressWarnings(lakewatersheds$ws_lon_decdeg <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$ws_lon_decdeg))==as.character(as.numeric("NA"))),NA,lakewatersheds$ws_lon_decdeg))
lakewatersheds$nws_states <- ifelse((trimws(as.character(lakewatersheds$nws_states))==trimws("NA")),NA,lakewatersheds$nws_states)               
suppressWarnings(lakewatersheds$nws_states <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$nws_states))==as.character(as.numeric("NA"))),NA,lakewatersheds$nws_states))
lakewatersheds$nws_focallakewaterarea_ha <- ifelse((trimws(as.character(lakewatersheds$nws_focallakewaterarea_ha))==trimws("NA")),NA,lakewatersheds$nws_focallakewaterarea_ha)               
suppressWarnings(lakewatersheds$nws_focallakewaterarea_ha <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$nws_focallakewaterarea_ha))==as.character(as.numeric("NA"))),NA,lakewatersheds$nws_focallakewaterarea_ha))
lakewatersheds$nws_area_ha <- ifelse((trimws(as.character(lakewatersheds$nws_area_ha))==trimws("NA")),NA,lakewatersheds$nws_area_ha)               
suppressWarnings(lakewatersheds$nws_area_ha <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$nws_area_ha))==as.character(as.numeric("NA"))),NA,lakewatersheds$nws_area_ha))
lakewatersheds$nws_perimeter_m <- ifelse((trimws(as.character(lakewatersheds$nws_perimeter_m))==trimws("NA")),NA,lakewatersheds$nws_perimeter_m)               
suppressWarnings(lakewatersheds$nws_perimeter_m <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$nws_perimeter_m))==as.character(as.numeric("NA"))),NA,lakewatersheds$nws_perimeter_m))
lakewatersheds$nws_lake_arearatio <- ifelse((trimws(as.character(lakewatersheds$nws_lake_arearatio))==trimws("NA")),NA,lakewatersheds$nws_lake_arearatio)               
suppressWarnings(lakewatersheds$nws_lake_arearatio <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$nws_lake_arearatio))==as.character(as.numeric("NA"))),NA,lakewatersheds$nws_lake_arearatio))
lakewatersheds$nws_mbgconhull_length_m <- ifelse((trimws(as.character(lakewatersheds$nws_mbgconhull_length_m))==trimws("NA")),NA,lakewatersheds$nws_mbgconhull_length_m)               
suppressWarnings(lakewatersheds$nws_mbgconhull_length_m <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$nws_mbgconhull_length_m))==as.character(as.numeric("NA"))),NA,lakewatersheds$nws_mbgconhull_length_m))
lakewatersheds$nws_mbgconhull_width_m <- ifelse((trimws(as.character(lakewatersheds$nws_mbgconhull_width_m))==trimws("NA")),NA,lakewatersheds$nws_mbgconhull_width_m)               
suppressWarnings(lakewatersheds$nws_mbgconhull_width_m <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$nws_mbgconhull_width_m))==as.character(as.numeric("NA"))),NA,lakewatersheds$nws_mbgconhull_width_m))
lakewatersheds$nws_mbgconhull_orientation_deg <- ifelse((trimws(as.character(lakewatersheds$nws_mbgconhull_orientation_deg))==trimws("NA")),NA,lakewatersheds$nws_mbgconhull_orientation_deg)               
suppressWarnings(lakewatersheds$nws_mbgconhull_orientation_deg <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$nws_mbgconhull_orientation_deg))==as.character(as.numeric("NA"))),NA,lakewatersheds$nws_mbgconhull_orientation_deg))
lakewatersheds$nws_meanwidth_m <- ifelse((trimws(as.character(lakewatersheds$nws_meanwidth_m))==trimws("NA")),NA,lakewatersheds$nws_meanwidth_m)               
suppressWarnings(lakewatersheds$nws_meanwidth_m <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$nws_meanwidth_m))==as.character(as.numeric("NA"))),NA,lakewatersheds$nws_meanwidth_m))
lakewatersheds$nws_lat_decdeg <- ifelse((trimws(as.character(lakewatersheds$nws_lat_decdeg))==trimws("NA")),NA,lakewatersheds$nws_lat_decdeg)               
suppressWarnings(lakewatersheds$nws_lat_decdeg <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$nws_lat_decdeg))==as.character(as.numeric("NA"))),NA,lakewatersheds$nws_lat_decdeg))
lakewatersheds$nws_lon_decdeg <- ifelse((trimws(as.character(lakewatersheds$nws_lon_decdeg))==trimws("NA")),NA,lakewatersheds$nws_lon_decdeg)               
suppressWarnings(lakewatersheds$nws_lon_decdeg <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(lakewatersheds$nws_lon_decdeg))==as.character(as.numeric("NA"))),NA,lakewatersheds$nws_lon_decdeg))
                    
                
# Observed issues when reading the data. An empty list is good!
problems(lakewatersheds) 
# Here is the structure of the input data tibble: 
glimpse(lakewatersheds) 
# And some statistical summaries of the data 
summary(lakewatersheds) 
# Get more details on character variables
                     
summary(as.factor(lakewatersheds$ws_zoneid)) 
summary(as.factor(lakewatersheds$nws_zoneid)) 
summary(as.factor(lakewatersheds$ws_subtype)) 
summary(as.factor(lakewatersheds$ws_equalsnws)) 
summary(as.factor(lakewatersheds$ws_onlandborder)) 
summary(as.factor(lakewatersheds$ws_oncoast)) 
summary(as.factor(lakewatersheds$ws_includeshu4inlet)) 
summary(as.factor(lakewatersheds$ws_ismultipart)) 
summary(as.factor(lakewatersheds$ws_sliverflag)) 
summary(as.factor(lakewatersheds$nws_onlandborder)) 
summary(as.factor(lakewatersheds$nws_oncoast)) 
summary(as.factor(lakewatersheds$nws_includeshu4inlet)) 
summary(as.factor(lakewatersheds$nws_ismultipart)) 
summary(as.factor(lakewatersheds$ws_states)) 
summary(as.factor(lakewatersheds$nws_states)) 
# 
infile4 <- trimws("https://pasta.lternet.edu/package/data/eml/edi/854/1/5488e333ce818597fa3dbfc9b4e0c131")
infile4 <-sub("^https","http",infile4)
# This creates a tibble named: dt4
	dt4 <-read_delim(infile4
                ,delim=","
                ,skip=1
                    ,quote='"'
                    , col_names=c(
                        "lagoslakeid",
                        "lake_nhdid",
                        "lake_reachcode",
                        "lake_namegnis",
                        "lake_namelagos",
                        "lake_county",
                        "lake_countyfips",
                        "lake_lat_decdeg",
                        "lake_lon_decdeg",
                        "lake_centroidstate",
                        "nhdhr_area_sqkm",
                        "nhdhr_fdate",
                        "nhdhr_gnisid",
                        "lagosus_legacysiteid",
                        "lagosus_legacysitelabel",
                        "lagosus_legacyprogram",
                        "wqp_monitoringlocationidentifier",
                        "wqp_monitoringlocationname",
                        "wqp_providername",
                        "nhdplusv2_comid",
                        "nhdplusv2_reachcode",
                        "nhdplusv2_area_sqkm",
                        "lagosne_lagoslakeid",
                        "lagosne_legacysiteid",
                        "nla2007_siteid",
                        "nla2012_siteid",
                        "nhdplusv2_lakes_n",
                        "lagosne_lakes_n",
                        "wqp_sites_n",
                        "lagosus_legacyids_n"   ),
                    col_types=list(
                        col_number() ,
                        col_character(),
                        col_character(),
                        col_character(),
                        col_character(),
                        col_character(),
                        col_character(),
                        col_number() ,
                        col_number() ,
                        col_character(),
                        col_number() ,
                        col_character(),
                        col_character(),
                        col_character(),
                        col_character(),
                        col_character(),
                        col_character(),
                        col_character(),
                        col_character(),
                        col_character(),
                        col_character(),
                        col_number() ,
                        col_number() ,
                        col_character(),
                        col_character(),
                        col_character(),
                        col_number() ,
                        col_number() ,
                        col_number() ,
                        col_number() ),
                        na=c(" ",".","NA")  )


# Convert Missing Values to NA for individual vectors
dt4$lagoslakeid <- ifelse((trimws(as.character(dt4$lagoslakeid))==trimws("NA")),NA,dt4$lagoslakeid)
suppressWarnings(dt4$lagoslakeid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$lagoslakeid))==as.character(as.numeric("NA"))),NA,dt4$lagoslakeid))
dt4$lake_nhdid <- ifelse((trimws(as.character(dt4$lake_nhdid))==trimws("NA")),NA,dt4$lake_nhdid)
suppressWarnings(dt4$lake_nhdid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$lake_nhdid))==as.character(as.numeric("NA"))),NA,dt4$lake_nhdid))
dt4$lake_reachcode <- ifelse((trimws(as.character(dt4$lake_reachcode))==trimws("NA")),NA,dt4$lake_reachcode)
suppressWarnings(dt4$lake_reachcode <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$lake_reachcode))==as.character(as.numeric("NA"))),NA,dt4$lake_reachcode))
dt4$lake_namegnis <- ifelse((trimws(as.character(dt4$lake_namegnis))==trimws("NA")),NA,dt4$lake_namegnis)
suppressWarnings(dt4$lake_namegnis <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$lake_namegnis))==as.character(as.numeric("NA"))),NA,dt4$lake_namegnis))
dt4$lake_namelagos <- ifelse((trimws(as.character(dt4$lake_namelagos))==trimws("NA")),NA,dt4$lake_namelagos)
suppressWarnings(dt4$lake_namelagos <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$lake_namelagos))==as.character(as.numeric("NA"))),NA,dt4$lake_namelagos))
dt4$lake_county <- ifelse((trimws(as.character(dt4$lake_county))==trimws("NA")),NA,dt4$lake_county)
suppressWarnings(dt4$lake_county <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$lake_county))==as.character(as.numeric("NA"))),NA,dt4$lake_county))
dt4$lake_countyfips <- ifelse((trimws(as.character(dt4$lake_countyfips))==trimws("NA")),NA,dt4$lake_countyfips)
suppressWarnings(dt4$lake_countyfips <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$lake_countyfips))==as.character(as.numeric("NA"))),NA,dt4$lake_countyfips))
dt4$lake_lat_decdeg <- ifelse((trimws(as.character(dt4$lake_lat_decdeg))==trimws("NA")),NA,dt4$lake_lat_decdeg)
suppressWarnings(dt4$lake_lat_decdeg <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$lake_lat_decdeg))==as.character(as.numeric("NA"))),NA,dt4$lake_lat_decdeg))
dt4$lake_lon_decdeg <- ifelse((trimws(as.character(dt4$lake_lon_decdeg))==trimws("NA")),NA,dt4$lake_lon_decdeg)
suppressWarnings(dt4$lake_lon_decdeg <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$lake_lon_decdeg))==as.character(as.numeric("NA"))),NA,dt4$lake_lon_decdeg))
dt4$lake_centroidstate <- ifelse((trimws(as.character(dt4$lake_centroidstate))==trimws("NA")),NA,dt4$lake_centroidstate)
suppressWarnings(dt4$lake_centroidstate <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$lake_centroidstate))==as.character(as.numeric("NA"))),NA,dt4$lake_centroidstate))
dt4$nhdhr_area_sqkm <- ifelse((trimws(as.character(dt4$nhdhr_area_sqkm))==trimws("NA")),NA,dt4$nhdhr_area_sqkm)
suppressWarnings(dt4$nhdhr_area_sqkm <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$nhdhr_area_sqkm))==as.character(as.numeric("NA"))),NA,dt4$nhdhr_area_sqkm))
dt4$nhdhr_fdate <- ifelse((trimws(as.character(dt4$nhdhr_fdate))==trimws("NA")),NA,dt4$nhdhr_fdate)
suppressWarnings(dt4$nhdhr_fdate <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$nhdhr_fdate))==as.character(as.numeric("NA"))),NA,dt4$nhdhr_fdate))
dt4$nhdhr_gnisid <- ifelse((trimws(as.character(dt4$nhdhr_gnisid))==trimws("NA")),NA,dt4$nhdhr_gnisid)
suppressWarnings(dt4$nhdhr_gnisid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$nhdhr_gnisid))==as.character(as.numeric("NA"))),NA,dt4$nhdhr_gnisid))
dt4$lagosus_legacysiteid <- ifelse((trimws(as.character(dt4$lagosus_legacysiteid))==trimws("NA")),NA,dt4$lagosus_legacysiteid)
suppressWarnings(dt4$lagosus_legacysiteid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$lagosus_legacysiteid))==as.character(as.numeric("NA"))),NA,dt4$lagosus_legacysiteid))
dt4$lagosus_legacysitelabel <- ifelse((trimws(as.character(dt4$lagosus_legacysitelabel))==trimws("NA")),NA,dt4$lagosus_legacysitelabel)
suppressWarnings(dt4$lagosus_legacysitelabel <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$lagosus_legacysitelabel))==as.character(as.numeric("NA"))),NA,dt4$lagosus_legacysitelabel))
dt4$lagosus_legacyprogram <- ifelse((trimws(as.character(dt4$lagosus_legacyprogram))==trimws("NA")),NA,dt4$lagosus_legacyprogram)
suppressWarnings(dt4$lagosus_legacyprogram <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$lagosus_legacyprogram))==as.character(as.numeric("NA"))),NA,dt4$lagosus_legacyprogram))
dt4$wqp_monitoringlocationidentifier <- ifelse((trimws(as.character(dt4$wqp_monitoringlocationidentifier))==trimws("NA")),NA,dt4$wqp_monitoringlocationidentifier)
suppressWarnings(dt4$wqp_monitoringlocationidentifier <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$wqp_monitoringlocationidentifier))==as.character(as.numeric("NA"))),NA,dt4$wqp_monitoringlocationidentifier))
dt4$wqp_monitoringlocationname <- ifelse((trimws(as.character(dt4$wqp_monitoringlocationname))==trimws("NA")),NA,dt4$wqp_monitoringlocationname)
suppressWarnings(dt4$wqp_monitoringlocationname <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$wqp_monitoringlocationname))==as.character(as.numeric("NA"))),NA,dt4$wqp_monitoringlocationname))
dt4$wqp_providername <- ifelse((trimws(as.character(dt4$wqp_providername))==trimws("NA")),NA,dt4$wqp_providername)
suppressWarnings(dt4$wqp_providername <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$wqp_providername))==as.character(as.numeric("NA"))),NA,dt4$wqp_providername))
dt4$nhdplusv2_comid <- ifelse((trimws(as.character(dt4$nhdplusv2_comid))==trimws("NA")),NA,dt4$nhdplusv2_comid)
suppressWarnings(dt4$nhdplusv2_comid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$nhdplusv2_comid))==as.character(as.numeric("NA"))),NA,dt4$nhdplusv2_comid))
dt4$nhdplusv2_reachcode <- ifelse((trimws(as.character(dt4$nhdplusv2_reachcode))==trimws("NA")),NA,dt4$nhdplusv2_reachcode)
suppressWarnings(dt4$nhdplusv2_reachcode <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$nhdplusv2_reachcode))==as.character(as.numeric("NA"))),NA,dt4$nhdplusv2_reachcode))
dt4$nhdplusv2_area_sqkm <- ifelse((trimws(as.character(dt4$nhdplusv2_area_sqkm))==trimws("NA")),NA,dt4$nhdplusv2_area_sqkm)
suppressWarnings(dt4$nhdplusv2_area_sqkm <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$nhdplusv2_area_sqkm))==as.character(as.numeric("NA"))),NA,dt4$nhdplusv2_area_sqkm))
dt4$lagosne_lagoslakeid <- ifelse((trimws(as.character(dt4$lagosne_lagoslakeid))==trimws("NA")),NA,dt4$lagosne_lagoslakeid)
suppressWarnings(dt4$lagosne_lagoslakeid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$lagosne_lagoslakeid))==as.character(as.numeric("NA"))),NA,dt4$lagosne_lagoslakeid))
dt4$lagosne_legacysiteid <- ifelse((trimws(as.character(dt4$lagosne_legacysiteid))==trimws("NA")),NA,dt4$lagosne_legacysiteid)
suppressWarnings(dt4$lagosne_legacysiteid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$lagosne_legacysiteid))==as.character(as.numeric("NA"))),NA,dt4$lagosne_legacysiteid))
dt4$nla2007_siteid <- ifelse((trimws(as.character(dt4$nla2007_siteid))==trimws("NA")),NA,dt4$nla2007_siteid)
suppressWarnings(dt4$nla2007_siteid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$nla2007_siteid))==as.character(as.numeric("NA"))),NA,dt4$nla2007_siteid))
dt4$nla2012_siteid <- ifelse((trimws(as.character(dt4$nla2012_siteid))==trimws("NA")),NA,dt4$nla2012_siteid)
suppressWarnings(dt4$nla2012_siteid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$nla2012_siteid))==as.character(as.numeric("NA"))),NA,dt4$nla2012_siteid))
dt4$nhdplusv2_lakes_n <- ifelse((trimws(as.character(dt4$nhdplusv2_lakes_n))==trimws("NA")),NA,dt4$nhdplusv2_lakes_n)
suppressWarnings(dt4$nhdplusv2_lakes_n <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$nhdplusv2_lakes_n))==as.character(as.numeric("NA"))),NA,dt4$nhdplusv2_lakes_n))
dt4$lagosne_lakes_n <- ifelse((trimws(as.character(dt4$lagosne_lakes_n))==trimws("NA")),NA,dt4$lagosne_lakes_n)
suppressWarnings(dt4$lagosne_lakes_n <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$lagosne_lakes_n))==as.character(as.numeric("NA"))),NA,dt4$lagosne_lakes_n))
dt4$wqp_sites_n <- ifelse((trimws(as.character(dt4$wqp_sites_n))==trimws("NA")),NA,dt4$wqp_sites_n)
suppressWarnings(dt4$wqp_sites_n <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$wqp_sites_n))==as.character(as.numeric("NA"))),NA,dt4$wqp_sites_n))
dt4$lagosus_legacyids_n <- ifelse((trimws(as.character(dt4$lagosus_legacyids_n))==trimws("NA")),NA,dt4$lagosus_legacyids_n)
suppressWarnings(dt4$lagosus_legacyids_n <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$lagosus_legacyids_n))==as.character(as.numeric("NA"))),NA,dt4$lagosus_legacyids_n))


# Observed issues when reading the data. An empty list is good!
problems(dt4)
# Here is the structure of the input data tibble:
glimpse(dt4)
# And some statistical summaries of the data
summary(dt4)
# Get more details on character variables

summary(as.factor(dt4$lake_nhdid))
summary(as.factor(dt4$lake_reachcode))
summary(as.factor(dt4$lake_namegnis))
summary(as.factor(dt4$lake_namelagos))
summary(as.factor(dt4$lake_county))
summary(as.factor(dt4$lake_countyfips))
summary(as.factor(dt4$lake_centroidstate))
summary(as.factor(dt4$nhdhr_fdate))
summary(as.factor(dt4$nhdhr_gnisid))
summary(as.factor(dt4$lagosus_legacysiteid))
summary(as.factor(dt4$lagosus_legacysitelabel))
summary(as.factor(dt4$lagosus_legacyprogram))
summary(as.factor(dt4$wqp_monitoringlocationidentifier))
summary(as.factor(dt4$wqp_monitoringlocationname))
summary(as.factor(dt4$wqp_providername))
summary(as.factor(dt4$nhdplusv2_comid))
summary(as.factor(dt4$nhdplusv2_reachcode))
summary(as.factor(dt4$lagosne_legacysiteid))
summary(as.factor(dt4$nla2007_siteid))
summary(as.factor(dt4$nla2012_siteid))






```


### In situ
```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
chemicalphysical<-read.csv(here("data/CL_LAGOSUS_exports/LAGOSUS_LIMNO/US/LIMNO_v2.1/Final_exports/site_chemicalphysical_epi.csv"))%>%
    mutate(event_date=lubridate::ymd(event_date),
         year=lubridate::year(event_date),
         year=factor(year),
         lagoslakeid=factor(lagoslakeid))
claritycarbon<-read.csv(here("data/CL_LAGOSUS_exports/LAGOSUS_LIMNO/US/LIMNO_v2.1/Final_exports/site_claritycarbon_epi.csv"))%>%
    mutate(event_date=lubridate::ymd(event_date),
         year=lubridate::year(event_date),
         year=factor(year),
         lagoslakeid=factor(lagoslakeid))
contaminants<-read.csv(here("data/CL_LAGOSUS_exports/LAGOSUS_LIMNO/US/LIMNO_v2.1/Final_exports/site_contaminants_epi.csv"))%>%
    mutate(event_date=lubridate::ymd(event_date),
         year=lubridate::year(event_date),
         year=factor(year),
         lagoslakeid=factor(lagoslakeid))

nutrientsalgae<-read.csv(here("data/CL_LAGOSUS_exports/LAGOSUS_LIMNO/US/LIMNO_v2.1/Final_exports/site_nutrientsalgae_epi.csv"))%>%
    mutate(event_date=lubridate::ymd(event_date),
         year=lubridate::year(event_date),
         year=factor(year),
         lagoslakeid=factor(lagoslakeid))
depth<-read.csv(here("data/CL_LAGOSUS_exports/LAGOSUS_DEPTH/DEPTH_v0.1/lake_depth.csv")) %>%
  mutate(lagoslakeid=factor(lagoslakeid))


##Now that LAGOS-US is getting published on EDI, we can forget about these old files
# lakeinformation<-read.csv(here("data/CL_LAGOSUS_exports/LAGOSUS_LOCUS/LOCUS_v1.0/lake_information.csv")) %>%
#   filter(lake_centroidstate %in% c("CA", "UT", "NV",
#                       "WA", "OR", "ID",
#                       "MT", "WY", "CO",
#                       "NM", "AZ")) %>%
#   mutate(lagoslakeid=factor(lagoslakeid))
# 
# lakewatersheds<-read.csv(here("data/CL_LAGOSUS_exports/LAGOSUS_LOCUS/LOCUS_v1.0/lake_watersheds.csv")) %>%
#   mutate(lagoslakeid=factor(lagoslakeid))
# 
# lakecharacteristics<-read.csv(here("data/CL_LAGOSUS_exports/LAGOSUS_LOCUS/LOCUS_v1.0/lake_characteristics.csv")) %>%
#   mutate(lagoslakeid=factor(lagoslakeid))

lakeinformation <- lakeinformation %>%
    filter(lake_centroidstate %in% c("CA", "UT", "NV",
                      "WA", "OR", "ID",
                      "MT", "WY", "CO",
                      "NM", "AZ")) %>%
  mutate(lagoslakeid=factor(lagoslakeid))

lakewatersheds <- lakewatersheds %>%
  mutate(lagoslakeid=factor(lagoslakeid))

lakecharacteristics <- lakecharacteristics %>%
  mutate(lagoslakeid=factor(lagoslakeid))


##SUMMARIZE IN SITU DATA

# names(chemicalphysical)
chemicalphysical <- chemicalphysical %>%
  group_by(lagoslakeid, year) %>%
  summarise_at(c("ca_mgl","alk_ueql","do_mgl","ph_eq",
                 "so4_mgl","temp_degc","salinity_mgl",
                 "mg_mgl","spcond_uscm"), list(median = function(x) median(x,na.rm=T),
                                           max = function(x) max(x,na.rm=T),
                                           n=length))
# names(claritycarbon)
claritycarbon <- claritycarbon %>%
  group_by(lagoslakeid, year) %>%
  summarize_at(c("colora_pcu","colort_pcu","doc_mgl","turb_ntu",
                 "secchi_m","tss"), list(median = function(x) median(x,na.rm=T),
                                           max = function(x) max(x,na.rm=T),
                                           n=length))

# names(contaminants)
contaminants <- contaminants %>%
  group_by(lagoslakeid, year) %>%
  summarize_at(c("al_tot_ugl","al_diss_ugl","as_diss_ugl",
                 "atz_tot_ugl","ecoli_cfu100ml","mehg_tot_ngl",
                 "se_diss_ugl","ecoli_mpn100ml"), list(median = function(x) median(x,na.rm=T),
                                           max = function(x) max(x,na.rm=T),
                                           n=length))

# names(nutrientsalgae)
nutrientsalgae <- nutrientsalgae %>%
  group_by(lagoslakeid, year) %>%
  summarize_at(c("chla_ugl","no2no3n_ugl","nh4n_ugl",
                 "tkn_ugl","tn_ugl","ton_ugl","tp_ugl",
                 "srpp_ugl","microcystin_ugl"), list(median = function(x) median(x,na.rm=T),
                                           max = function(x) max(x,na.rm=T),
                                           n=length))
#CONVERT FROM DF TO DATA.TABLE
# setDT(lakeinformation)
# setDT(chemicalphysical)
# setDT(claritycarbon)
# setDT(contaminants)
# setDT(depth)
# setDT(nutrientsalgae)

#ATTEMPT TO REDUCE THE FILE SIZE - data.table code
# chemicalphysical<-chemicalphysical[, lapply(.SD, median, na.rm=TRUE), .SDcols = is.numeric, keyby=c("lagoslakeid","year")  ]
# claritycarbon<-claritycarbon[, lapply(.SD, median, na.rm=TRUE), .SDcols = is.numeric, keyby=c("lagoslakeid","year")  ]
# contaminants<-contaminants[, lapply(.SD, median, na.rm=TRUE), .SDcols = is.numeric, keyby=c("lagoslakeid","year")  ]
# nutrientsalgae<-nutrientsalgae[, lapply(.SD, median, na.rm=TRUE), .SDcols = is.numeric, keyby=c("lagoslakeid","year")  ]

#Check for NAs in year
# sum(is.na(chemicalphysical$year))
# sum(is.na(claritycarbon$year))
# sum(is.na(contaminants$year))
# sum(is.na(nutrientsalgae$year))

#Take a glance at all the fancy ants
# glimpse(chemicalphysical)
# glimpse(claritycarbon)
# glimpse(contaminants)
# glimpse(siteinfo)
# glimpse(nutrientsalgae)
# glimpse(profiles)
# glimpse(lakeinformation)

#Joining each data.table to lakeinformation which only has western states
chemicalphysical<-merge(lakeinformation,chemicalphysical, no.dups=TRUE, by="lagoslakeid") 
claritycarbon<-merge(lakeinformation,claritycarbon, no.dups=TRUE, by="lagoslakeid")
contaminants<-merge(lakeinformation,contaminants, no.dups=TRUE, by="lagoslakeid")
nutrientsalgae<-merge(lakeinformation,nutrientsalgae,  no.dups=TRUE, by="lagoslakeid")
colnames<-(intersect( colnames(lakeinformation),  colnames(depth))) #identify common columns between data.tables
depth<-merge(lakeinformation,depth, all.x=TRUE,  no.dups=TRUE, by=colnames)
colnames<-(intersect( colnames(lakeinformation),  colnames(lakewatersheds))) #identify common columns between data.tables
lakewatersheds<-merge(lakeinformation,lakewatersheds,  no.dups=TRUE, by=colnames)
colnames<-(intersect( colnames(lakeinformation),  colnames(lakecharacteristics))) #identify common columns between data.tables
lakecharacteristics<-merge(lakeinformation,lakecharacteristics,  no.dups=TRUE, by=colnames)


#Check for NAs again
# sum(is.na(chemicalphysical$year))
# sum(is.na(claritycarbon$year))
# sum(is.na(contaminants$year))
# sum(is.na(nutrientsalgae$year))

# profiles<-merge(lakeinformation,profiles, all.x = TRUE,no.dups=TRUE, by="lagoslakeid")

#Make one big dataframe, and join by all of the common columns ("colnames")
colnames<-(intersect( colnames(chemicalphysical),  colnames(claritycarbon)))
dt_limno<- merge(chemicalphysical,claritycarbon, all=TRUE,by=colnames) 
colnames<-(intersect( colnames(dt_limno),  colnames(contaminants)))
dt_limno<- merge(dt_limno,contaminants, all=TRUE,by=colnames) 
colnames<-(intersect( colnames(dt_limno),  colnames(nutrientsalgae)))
dt_limno<- merge(dt_limno,nutrientsalgae, all=TRUE,by=colnames) 
colnames<-(intersect( colnames(dt_limno),  colnames(depth)))
dt_limno<- merge(dt_limno,depth,by=colnames) 

colnames<-(intersect( colnames(dt_limno),  colnames(lakewatersheds)))
dt_limno<- merge(dt_limno,lakewatersheds,all=TRUE,by=colnames) 

colnames<-(intersect( colnames(dt_limno), colnames(lakecharacteristics)))
dt_limno<- merge(dt_limno,lakecharacteristics,all=TRUE,by=colnames) 


```

### LakeCat data
```{r}

#Trim dt4 to only include lakes in the western US...
colnames<-(intersect( colnames(lakeinformation),  colnames(dt4)))
dt4_trim<-merge(lakeinformation,dt4, no.dups=TRUE, by=colnames) 

# MTBS_Severity_2018<-read.csv(here("data/lakecat/MTBS_Severity_2018.csv")) %>%
#   rename(nhdplusv2_comid=COMID)%>%
#   mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
# 
# MTBS_Severity_2018_trim<-semi_join(MTBS_Severity_2018,dt4,by="nhdplusv2_comid")# All rows in a that have a match in b

#Burn severity
MTBS<-read.csv(here("data/lakecat/MTBS.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
MTBS<-semi_join(MTBS,dt4,by="nhdplusv2_comid")# All rows in a that have a match in b

# MTBS_Severity_1984<-read.csv(here("data/lakecat/MTBS_Severity_1984.csv")) %>%
#   rename(nhdplusv2_comid=COMID)%>%
#   mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
# MTBS_Severity_1984<-semi_join(MTBS,dt4,by="nhdplusv2_comid")# All rows in a that have a match in b

#Fire perimenter - this might be better too use than MTBS?
FirePerimeters<-read.csv(here("data/lakecat/FirePerimeters.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
FirePerimeters<-semi_join(FirePerimeters,dt4,by="nhdplusv2_comid")# All rows in a that have a match in b

#Forest loss
ForestLoss<-read.csv(here("data/lakecat/ForestLossByYear0013.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
ForestLoss<-semi_join(ForestLoss,dt4,by="nhdplusv2_comid")# All rows in a that have a match in b

#Ag Nitrogen
AgN <-read.csv(here("data/lakecat/AgriculturalNitrogen.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
AgN<-semi_join(AgN,dt4,by="nhdplusv2_comid")# All rows in a that have a match in b

#NLCD
NLCD2001 <-read.csv(here("data/lakecat/NLCD2001.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
NLCD2004 <-read.csv(here("data/lakecat/NLCD2004.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
NLCD2006 <-read.csv(here("data/lakecat/NLCD2006.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
NLCD2008 <-read.csv(here("data/lakecat/NLCD2008.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
NLCD2011 <-read.csv(here("data/lakecat/NLCD2011.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
NLCD2013 <-read.csv(here("data/lakecat/NLCD2013.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
NLCD2016 <-read.csv(here("data/lakecat/NLCD2016.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))

colnames<-(intersect( colnames(NLCD2001),  colnames(NLCD2004))) #identify common columns between data.tables
NLCD<-left_join(NLCD2001,NLCD2004, by=colnames)
NLCD<-left_join(NLCD,NLCD2006, by=colnames)
NLCD<-left_join(NLCD,NLCD2008, by=colnames)
NLCD<-left_join(NLCD,NLCD2011, by=colnames)
NLCD<-left_join(NLCD,NLCD2013, by=colnames)
NLCD<-left_join(NLCD,NLCD2016, by=colnames)
NLCD<-semi_join(NLCD,dt4,by="nhdplusv2_comid")# All rows in a that have a match in b
names(NLCD)

#Runoff
Runoff <-read.csv(here("data/lakecat/Runoff.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
Runoff<-semi_join(Runoff,dt4,by="nhdplusv2_comid")# All rows in a that have a match in b


#NADP
NADP <-read.csv(here("data/lakecat/NADP.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
NADP<-semi_join(NADP,dt4,by="nhdplusv2_comid")# All rows in a that have a match in b

NADP_2014_2018<-read.csv(here("data/lakecat/NADP_2014_2018.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
NADP_2014_2018<-semi_join(NADP_2014_2018,dt4,by="nhdplusv2_comid")# All rows in a that have a match in b

colnames<-(intersect( colnames(NADP),  colnames(NADP_2014_2018))) #identify common columns between data.tables
NADP<-left_join(NADP,NADP_2014_2018, by=colnames)
rm(NADP_2014_2018)

#PRISM
PRISM_1981_2010<-read.csv(here("data/lakecat/PRISM_1981_2010.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
PRISM_1981_2010<-left_join(PRISM_1981_2010,dt4,by="nhdplusv2_comid")# All rows in a that have a match in b
PRISM_1981_2010 %>%
  drop_na(lagoslakeid)
#CTI
#Mean Composite Topographic Index (CTI)[Wetness Index]:, within the local catchment (Cat) and upslope watershed (Ws) 
CTI<-read.csv(here("data/lakecat/WetIndx.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
CTI<-semi_join(CTI,dt4,by="nhdplusv2_comid")# All rows in a that have a match in b

#Slope
Slope<-read.csv(here("data/lakecat/Slope.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
Slope<-semi_join(Slope,dt4,by="nhdplusv2_comid")# All rows in a that have a match in b

#Lithology
Lithology<-read.csv(here("data/lakecat/Lithology.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
Lithology<-semi_join(Lithology,dt4,by="nhdplusv2_comid")# All rows in a that have a match in b

#ImpSurf
ImpSurf<-read.csv(here("data/lakecat/ImperviousSurfaces2016.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
ImpSurf<-semi_join(ImpSurf,dt4,by="nhdplusv2_comid")# All rows in a that have a match in b

#GeoChemPhys
GeoChemPhys1<-read.csv(here("data/lakecat/GeoChemPhys1.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
GeoChemPhys2<-read.csv(here("data/lakecat/GeoChemPhys2.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
GeoChemPhys3<-read.csv(here("data/lakecat/GeoChemPhys3.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
GeoChemPhys4<-read.csv(here("data/lakecat/GeoChemPhys4.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
colnames<-(intersect( colnames(GeoChemPhys1),  colnames(GeoChemPhys2))) #identify common columns between data.tables
GeoChemPhys<-left_join(GeoChemPhys1,GeoChemPhys2, by=colnames)
GeoChemPhys<-left_join(GeoChemPhys,GeoChemPhys3, by=colnames)
GeoChemPhys<-left_join(GeoChemPhys,GeoChemPhys4, by=colnames)
GeoChemPhys<-semi_join(GeoChemPhys,dt4,by="nhdplusv2_comid")# All rows in a that have a match in b

#EPA_FRS
EPA_FRS<-read.csv(here("data/lakecat/EPA_FRS.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
EPA_FRS<-semi_join(EPA_FRS,dt4,by="nhdplusv2_comid")# All rows in a that have a match in b

#BFI
BFI<-read.csv(here("data/lakecat/BFI.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
BFI<-semi_join(BFI,dt4,by="nhdplusv2_comid")# All rows in a that have a match in b

#Census
Census<-read.csv(here("data/lakecat/USCensus2010.csv")) %>%
  rename(nhdplusv2_comid=COMID)%>%
  mutate(nhdplusv2_comid=as.character(nhdplusv2_comid))
Census<-semi_join(Census,dt4,by="nhdplusv2_comid")# All rows in a that have a match in b


LakeCat<- left_join(FirePerimeters, MTBS, by=colnames)
LakeCat<- left_join(LakeCat, ForestLoss, by=colnames)
LakeCat<- left_join(LakeCat, AgN, by=colnames)
LakeCat<- left_join(LakeCat, NLCD, by=colnames)
LakeCat<- left_join(LakeCat, MTBS, by=colnames)
LakeCat<- left_join(LakeCat, Runoff, by=colnames)
LakeCat<- left_join(LakeCat, NADP, by=colnames)
LakeCat<- left_join(LakeCat, PRISM_1981_2010, by=colnames)
LakeCat<- left_join(LakeCat, CTI, by=colnames)
LakeCat<- left_join(LakeCat, Slope, by=colnames)
LakeCat<- left_join(LakeCat, Lithology, by=colnames)
LakeCat<- left_join(LakeCat, ImpSurf, by=colnames)
LakeCat<- left_join(LakeCat, GeoChemPhys, by=colnames)
LakeCat<- left_join(LakeCat, EPA_FRS, by=colnames)
LakeCat<- left_join(LakeCat, BFI, by=colnames)
LakeCat<- left_join(LakeCat, Census, by=colnames)

#Exclude all the WS variables-- focus on the local catchment ("Cat") variables
LakeCat_trim<-LakeCat%>%
  dplyr::select(!contains("Ws"))

#Clean up 
rm(FirePerimeters, MTBS, ForestLoss, 
 AgN, NLCD, 
 MTBS, Runoff, 
 NADP, PRISM_1981_2010, 
 CTI,  Slope, 
 Lithology, 
 ImpSurf, GeoChemPhys, 
 EPA_FRS, BFI, 
 Census,
 GeoChemPhys1,GeoChemPhys2,GeoChemPhys3,GeoChemPhys4,
 NLCD2001, NLCD2004, NLCD2006, NLCD2008, NLCD2011, NLCD2013, NLCD2016)
```


### Connectivity df
```{r}

# Package ID: edi.879.1 Cataloging System:https://pasta.edirepository.org.
# Data set title: LAGOS-US NETWORKS v1.0: Data module of surface water networks characterizing connections among lakes, streams, and rivers in the conterminous U.S.
# Data set creator:  Katelyn King - Michigan State University 
# Data set creator:  Qi Wang - Michigan State University 
# Data set creator:  Lauren Rodriguez - Michigan State University 
# Data set creator:  Maggie Haite - Michigan State University 
# Data set creator:  Laura Danila - Michigan State University 
# Data set creator:  Pang-Ning Tan - Michigan State University 
# Data set creator:  Jiayu Zhou - Michigan State University 
# Data set creator:  Kendra Cheruvelil - Michigan State University 
# Contact:  Katelyn King -  Michigan State University  - kingka21@msu.edu
# Stylesheet for metadata conversion into program: John H. Porter, Univ. Virginia, jporter@Virginia.edu 
#
#install package tidyverse if not already installed
if(!require(tidyverse)){ install.packages("tidyverse") }  
library("tidyverse") 
infile1 <- trimws("https://pasta.lternet.edu/package/data/eml/edi/879/1/eb1c4a78df8140b89cbf053b0cef3976") 
infile1 <-sub("^https","http",infile1)
# This creates a tibble named: dt1 
	dt1 <-read_delim(infile1  
                ,delim=","   
                ,skip=1 
                    ,quote='"'  
                    , col_names=c( 
                        "lagoslakeid",   
                        "lake_nets_upstreamlake_km",   
                        "lake_nets_downstreamlake_km",   
                        "lake_nets_bidirectionallake_km",   
                        "lake_nets_upstreamlake_n",   
                        "lake_nets_downstreamlake_n",   
                        "lake_nets_lakeorder",   
                        "lake_nets_lnn",   
                        "net_id",   
                        "net_lakes_n",   
                        "net_averagelakedistance_km",   
                        "net_averagelakearea_ha",   
                        "lake_nets_nearestdamdown_km",   
                        "lake_nets_nearestdamdown_id",   
                        "lake_nets_totaldamdown_n",   
                        "lake_nets_nearestdamup_km",   
                        "lake_nets_nearestdamup_id",   
                        "lake_nets_totaldamup_n",   
                        "lake_nets_damonlake_flag",   
                        "lake_nets_multidam_flag",   
                        "net_dams_n",   
                        "nhdplusv2_comid"   ), 
                    col_types=list(
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() ,  
                        col_character(), 
                        col_number() , 
                        col_number() , 
                        col_number() , 
                        col_number() ,  
                        col_character(), 
                        col_number() , 
                        col_number() ,  
                        col_character(), 
                        col_number() ,  
                        col_character(),  
                        col_character(), 
                        col_number() ,  
                        col_character()), 
                        na=c(" ",".","NA")  )
                        
                    
# Convert Missing Values to NA for individual vectors 
dt1$lagoslakeid <- ifelse((trimws(as.character(dt1$lagoslakeid))==trimws("NA")),NA,dt1$lagoslakeid)               
suppressWarnings(dt1$lagoslakeid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt1$lagoslakeid))==as.character(as.numeric("NA"))),NA,dt1$lagoslakeid))
dt1$lake_nets_upstreamlake_km <- ifelse((trimws(as.character(dt1$lake_nets_upstreamlake_km))==trimws("NA")),NA,dt1$lake_nets_upstreamlake_km)               
suppressWarnings(dt1$lake_nets_upstreamlake_km <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt1$lake_nets_upstreamlake_km))==as.character(as.numeric("NA"))),NA,dt1$lake_nets_upstreamlake_km))
dt1$lake_nets_downstreamlake_km <- ifelse((trimws(as.character(dt1$lake_nets_downstreamlake_km))==trimws("NA")),NA,dt1$lake_nets_downstreamlake_km)               
suppressWarnings(dt1$lake_nets_downstreamlake_km <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt1$lake_nets_downstreamlake_km))==as.character(as.numeric("NA"))),NA,dt1$lake_nets_downstreamlake_km))
dt1$lake_nets_bidirectionallake_km <- ifelse((trimws(as.character(dt1$lake_nets_bidirectionallake_km))==trimws("NA")),NA,dt1$lake_nets_bidirectionallake_km)               
suppressWarnings(dt1$lake_nets_bidirectionallake_km <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt1$lake_nets_bidirectionallake_km))==as.character(as.numeric("NA"))),NA,dt1$lake_nets_bidirectionallake_km))
dt1$lake_nets_upstreamlake_n <- ifelse((trimws(as.character(dt1$lake_nets_upstreamlake_n))==trimws("NA")),NA,dt1$lake_nets_upstreamlake_n)               
suppressWarnings(dt1$lake_nets_upstreamlake_n <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt1$lake_nets_upstreamlake_n))==as.character(as.numeric("NA"))),NA,dt1$lake_nets_upstreamlake_n))
dt1$lake_nets_downstreamlake_n <- ifelse((trimws(as.character(dt1$lake_nets_downstreamlake_n))==trimws("NA")),NA,dt1$lake_nets_downstreamlake_n)               
suppressWarnings(dt1$lake_nets_downstreamlake_n <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt1$lake_nets_downstreamlake_n))==as.character(as.numeric("NA"))),NA,dt1$lake_nets_downstreamlake_n))
dt1$lake_nets_lakeorder <- ifelse((trimws(as.character(dt1$lake_nets_lakeorder))==trimws("NA")),NA,dt1$lake_nets_lakeorder)               
suppressWarnings(dt1$lake_nets_lakeorder <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt1$lake_nets_lakeorder))==as.character(as.numeric("NA"))),NA,dt1$lake_nets_lakeorder))
dt1$lake_nets_lnn <- ifelse((trimws(as.character(dt1$lake_nets_lnn))==trimws("NA")),NA,dt1$lake_nets_lnn)               
suppressWarnings(dt1$lake_nets_lnn <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt1$lake_nets_lnn))==as.character(as.numeric("NA"))),NA,dt1$lake_nets_lnn))
dt1$net_lakes_n <- ifelse((trimws(as.character(dt1$net_lakes_n))==trimws("NA")),NA,dt1$net_lakes_n)               
suppressWarnings(dt1$net_lakes_n <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt1$net_lakes_n))==as.character(as.numeric("NA"))),NA,dt1$net_lakes_n))
dt1$net_averagelakedistance_km <- ifelse((trimws(as.character(dt1$net_averagelakedistance_km))==trimws("NA")),NA,dt1$net_averagelakedistance_km)               
suppressWarnings(dt1$net_averagelakedistance_km <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt1$net_averagelakedistance_km))==as.character(as.numeric("NA"))),NA,dt1$net_averagelakedistance_km))
dt1$net_averagelakearea_ha <- ifelse((trimws(as.character(dt1$net_averagelakearea_ha))==trimws("NA")),NA,dt1$net_averagelakearea_ha)               
suppressWarnings(dt1$net_averagelakearea_ha <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt1$net_averagelakearea_ha))==as.character(as.numeric("NA"))),NA,dt1$net_averagelakearea_ha))
dt1$lake_nets_nearestdamdown_km <- ifelse((trimws(as.character(dt1$lake_nets_nearestdamdown_km))==trimws("NA")),NA,dt1$lake_nets_nearestdamdown_km)               
suppressWarnings(dt1$lake_nets_nearestdamdown_km <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt1$lake_nets_nearestdamdown_km))==as.character(as.numeric("NA"))),NA,dt1$lake_nets_nearestdamdown_km))
dt1$lake_nets_totaldamdown_n <- ifelse((trimws(as.character(dt1$lake_nets_totaldamdown_n))==trimws("NA")),NA,dt1$lake_nets_totaldamdown_n)               
suppressWarnings(dt1$lake_nets_totaldamdown_n <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt1$lake_nets_totaldamdown_n))==as.character(as.numeric("NA"))),NA,dt1$lake_nets_totaldamdown_n))
dt1$lake_nets_nearestdamup_km <- ifelse((trimws(as.character(dt1$lake_nets_nearestdamup_km))==trimws("NA")),NA,dt1$lake_nets_nearestdamup_km)               
suppressWarnings(dt1$lake_nets_nearestdamup_km <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt1$lake_nets_nearestdamup_km))==as.character(as.numeric("NA"))),NA,dt1$lake_nets_nearestdamup_km))
dt1$lake_nets_totaldamup_n <- ifelse((trimws(as.character(dt1$lake_nets_totaldamup_n))==trimws("NA")),NA,dt1$lake_nets_totaldamup_n)               
suppressWarnings(dt1$lake_nets_totaldamup_n <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt1$lake_nets_totaldamup_n))==as.character(as.numeric("NA"))),NA,dt1$lake_nets_totaldamup_n))
dt1$lake_nets_damonlake_flag <- ifelse((trimws(as.character(dt1$lake_nets_damonlake_flag))==trimws("NA")),NA,dt1$lake_nets_damonlake_flag)               
suppressWarnings(dt1$lake_nets_damonlake_flag <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt1$lake_nets_damonlake_flag))==as.character(as.numeric("NA"))),NA,dt1$lake_nets_damonlake_flag))
dt1$lake_nets_multidam_flag <- ifelse((trimws(as.character(dt1$lake_nets_multidam_flag))==trimws("NA")),NA,dt1$lake_nets_multidam_flag)               
suppressWarnings(dt1$lake_nets_multidam_flag <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt1$lake_nets_multidam_flag))==as.character(as.numeric("NA"))),NA,dt1$lake_nets_multidam_flag))
dt1$net_dams_n <- ifelse((trimws(as.character(dt1$net_dams_n))==trimws("NA")),NA,dt1$net_dams_n)               
suppressWarnings(dt1$net_dams_n <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt1$net_dams_n))==as.character(as.numeric("NA"))),NA,dt1$net_dams_n))
dt1$nhdplusv2_comid <- ifelse((trimws(as.character(dt1$nhdplusv2_comid))==trimws("NA")),NA,dt1$nhdplusv2_comid)               
suppressWarnings(dt1$nhdplusv2_comid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt1$nhdplusv2_comid))==as.character(as.numeric("NA"))),NA,dt1$nhdplusv2_comid))
                    
                
# Observed issues when reading the data. An empty list is good!
problems(dt1) 
# Here is the structure of the input data tibble: 
glimpse(dt1) 
# And some statistical summaries of the data 
summary(dt1) 
# Get more details on character variables
                     
summary(as.factor(dt1$net_id)) 
summary(as.factor(dt1$lake_nets_nearestdamdown_id)) 
summary(as.factor(dt1$lake_nets_nearestdamup_id)) 
summary(as.factor(dt1$lake_nets_damonlake_flag)) 
summary(as.factor(dt1$lake_nets_multidam_flag)) 
summary(as.factor(dt1$nhdplusv2_comid)) 


dt1$lagoslakeid<-factor(dt1$lagoslakeid)

#Where are these lakes and what network are they in?
#Joining  to lakeinformation which only has western states
colnames<-(intersect( colnames(lakeinformation),  colnames(dt1)))
dt1_western<-merge(lakeinformation,dt1, all.x=TRUE, no.dups=TRUE, by="lagoslakeid") %>%
      mutate(connectivity_type = case_when(net_id >= 1 ~ 'yes network',
                                  TRUE ~ 'no network')) 

colnames<-(intersect( colnames(dt1_western),  colnames(dt_limno))) #Find common column names
dt1_western<-left_join(dt1_western,dt_limno, by=colnames)
sum(is.na(dt_limno$year))
sum(is.na(dt1_western$year))




infile2 <- trimws("https://pasta.lternet.edu/package/data/eml/edi/879/1/7ec02af96e1ef066455cf41caebf59d2") 
infile2 <-sub("^https","http",infile2)
# This creates a tibble named: dt2
	dt2 <-read_delim(infile2
                ,delim=","
                ,skip=1
                    ,quote='"'
                    , col_names=c(
                        "lagoslakeid",
                        "to_lagoslakeid",
                        "streamlength_down_km"   ),
                    col_types=list(
                        col_number() ,
                        col_number() ,
                        col_number() ),
                        na=c(" ",".","NA")  )


# Convert Missing Values to NA for individual vectors
dt2$lagoslakeid <- ifelse((trimws(as.character(dt2$lagoslakeid))==trimws("NA")),NA,dt2$lagoslakeid)
suppressWarnings(dt2$lagoslakeid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt2$lagoslakeid))==as.character(as.numeric("NA"))),NA,dt2$lagoslakeid))
dt2$to_lagoslakeid <- ifelse((trimws(as.character(dt2$to_lagoslakeid))==trimws("NA")),NA,dt2$to_lagoslakeid)
suppressWarnings(dt2$to_lagoslakeid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt2$to_lagoslakeid))==as.character(as.numeric("NA"))),NA,dt2$to_lagoslakeid))
dt2$streamlength_down_km <- ifelse((trimws(as.character(dt2$streamlength_down_km))==trimws("NA")),NA,dt2$streamlength_down_km)
suppressWarnings(dt2$streamlength_down_km <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt2$streamlength_down_km))==as.character(as.numeric("NA"))),NA,dt2$streamlength_down_km))


# Observed issues when reading the data. An empty list is good!
problems(dt2)
# Here is the structure of the input data tibble:
glimpse(dt2)
# And some statistical summaries of the data
summary(dt2)
# Get more details on character variables
#                      
infile3 <- trimws("https://pasta.lternet.edu/package/data/eml/edi/879/1/20d37c3f72ffb78945f1d85b4806f975")
infile3 <-sub("^https","http",infile3)
# This creates a tibble named: dt3
	dt3 <-read_delim(infile3
                ,delim=","
                ,skip=1
                    ,quote='"'
                    , col_names=c(
                        "V1",
                        "lagoslakeid",
                        "to_lagoslakeid",
                        "streamlength_total_km",
                        "streamlength_up_km",
                        "streamlength_down_km"   ),
                    col_types=list(
                        col_number() ,
                        col_number() ,
                        col_number() ,
                        col_number() ,
                        col_number() ,
                        col_number() ),
                        na=c(" ",".","NA")  )


# Convert Missing Values to NA for individual vectors
dt3$V1 <- ifelse((trimws(as.character(dt3$V1))==trimws("NA")),NA,dt3$V1)
suppressWarnings(dt3$V1 <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt3$V1))==as.character(as.numeric("NA"))),NA,dt3$V1))
dt3$lagoslakeid <- ifelse((trimws(as.character(dt3$lagoslakeid))==trimws("NA")),NA,dt3$lagoslakeid)
suppressWarnings(dt3$lagoslakeid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt3$lagoslakeid))==as.character(as.numeric("NA"))),NA,dt3$lagoslakeid))
dt3$to_lagoslakeid <- ifelse((trimws(as.character(dt3$to_lagoslakeid))==trimws("NA")),NA,dt3$to_lagoslakeid)
suppressWarnings(dt3$to_lagoslakeid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt3$to_lagoslakeid))==as.character(as.numeric("NA"))),NA,dt3$to_lagoslakeid))
dt3$streamlength_total_km <- ifelse((trimws(as.character(dt3$streamlength_total_km))==trimws("NA")),NA,dt3$streamlength_total_km)
suppressWarnings(dt3$streamlength_total_km <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt3$streamlength_total_km))==as.character(as.numeric("NA"))),NA,dt3$streamlength_total_km))
dt3$streamlength_up_km <- ifelse((trimws(as.character(dt3$streamlength_up_km))==trimws("NA")),NA,dt3$streamlength_up_km)
suppressWarnings(dt3$streamlength_up_km <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt3$streamlength_up_km))==as.character(as.numeric("NA"))),NA,dt3$streamlength_up_km))
dt3$streamlength_down_km <- ifelse((trimws(as.character(dt3$streamlength_down_km))==trimws("NA")),NA,dt3$streamlength_down_km)
suppressWarnings(dt3$streamlength_down_km <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt3$streamlength_down_km))==as.character(as.numeric("NA"))),NA,dt3$streamlength_down_km))


# Observed issues when reading the data. An empty list is good!
problems(dt3)
# Here is the structure of the input data tibble:
glimpse(dt3)
# And some statistical summaries of the data
summary(dt3)
# Get more details on character variables

infile4 <- trimws("https://pasta.lternet.edu/package/data/eml/edi/879/1/d9cf897fd7461d565a9c506575262fc4")
infile4 <-sub("^https","http",infile4)
# This creates a tibble named: dt4
	dt4 <-read_delim(infile4
                ,delim=","
                ,skip=1
                    ,quote='"'
                    , col_names=c(
                        "from_comid",
                        "to_comid",
                        "from_lagoslakeid",
                        "to_lagoslakeid"   ),
                    col_types=list(
                        col_character(),
                        col_character(),
                        col_number() ,
                        col_number() ),
                        na=c(" ",".","NA")  )


# Convert Missing Values to NA for individual vectors
dt4$from_lagoslakeid <- ifelse((trimws(as.character(dt4$from_lagoslakeid))==trimws("NA")),NA,dt4$from_lagoslakeid)
suppressWarnings(dt4$from_lagoslakeid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$from_lagoslakeid))==as.character(as.numeric("NA"))),NA,dt4$from_lagoslakeid))
dt4$to_lagoslakeid <- ifelse((trimws(as.character(dt4$to_lagoslakeid))==trimws("NA")),NA,dt4$to_lagoslakeid)
suppressWarnings(dt4$to_lagoslakeid <- ifelse(!is.na(as.numeric("NA")) & (trimws(as.character(dt4$to_lagoslakeid))==as.character(as.numeric("NA"))),NA,dt4$to_lagoslakeid))


# Observed issues when reading the data. An empty list is good!
problems(dt4)
# Here is the structure of the input data tibble:
glimpse(dt4)
# And some statistical summaries of the data
summary(dt4)
# Get more details on character variables

summary(as.factor(dt4$from_comid))
summary(as.factor(dt4$to_comid))
# 
# 



```
## Reservoir data
```{r}
reservoir<-read.csv("/Users/isabellaoleksy/Dropbox/CollinsLabShared/Data/LAGOS RSVR for Bella/LAGOSUS_RSVR_v1.1.csv") %>%
  dplyr::select(lagoslakeid, lake_rsvr_class, lake_rsvr_probnl, lake_rsvr_probrsvr,
                lake_rsvr_model,lake_rsvr_probdiff,lake_rsvr_classmethod,
                lake_rsvr_rsvrisolated_flag,lake_rsvr_nlneardam_flag) %>%
  mutate(lagoslakeid=factor(lagoslakeid))


colnames<-(intersect( colnames(dt1_western), colnames(reservoir)))
dt1_western<- left_join(dt1_western,reservoir,by=colnames) 

```


### Spatial df
```{r}
#median of the medians
#But prior to transformation I want to keep year as a number because I am curious when most of these lakes were sampled
dt1_western_yearasNUM<-dt1_western %>%
  mutate(year=as.numeric(as.character(year))) %>%
    dplyr::select(lagoslakeid, year, contains(c("_median")))
#Data.frame method
setDT(dt1_western_yearasNUM)
dt1_western_summary<-dt1_western_yearasNUM[, lapply(.SD, median, na.rm=TRUE), .SDcols = is.numeric, by=c("lagoslakeid")  ] 

dt1_western_summary <- dt1_western_summary %>%
  mutate(year=round(year,0))%>%
    mutate(decade_sampled=
           ifelse(year >1970 & year <=1979, "1970s", 
                  ifelse(year >=1980 & year <=1989, "1980s", 
                         ifelse(year >=1990 & year <=1999, "1990s", 
                                ifelse(year >=2000 & year <=2009, "2000s",
                                       ifelse(year >=2010 & year <=2020, "2010s",
                                          ifelse(year >=2020,  "> 2020", "error"))))))) %>%
  mutate(decade_sampled = factor(decade_sampled,
                                levels = c("1970s", "1980s", "1990s",
                                           "2000s","2010s"," > 2020"))) #Reorder factors for plotting


#We lost some variables in the summary, so adding them back in here
colnames<-(intersect( colnames(dt1_western_summary),  colnames(lakewatersheds))) #identify common columns between data.tables
dt1_western_summary<-merge(dt1_western_summary,lakewatersheds,  no.dups=TRUE, by=colnames)
colnames<-(intersect( colnames(dt1_western_summary),  colnames(dt1))) #identify common columns between data.tables
dt1_western_summary<-merge(dt1_western_summary,dt1,  no.dups=TRUE, by=colnames)
colnames<-(intersect( colnames(dt1_western_summary),  colnames(depth))) #identify common columns between data.tables
dt1_western_summary<-merge(dt1_western_summary,depth,  no.dups=TRUE, by=colnames)

lakecharacteristics_trim <- lakecharacteristics %>%
  dplyr::select(lagoslakeid, lake_perimeter_m, lake_totalarea_ha,
                lake_connectivity_class, lake_connectivity_fluctuates, lake_connectivity_permanent,
                lake_lakes4ha_upstream_ha, lake_lakes4ha_upstream_n, lake_lakes1ha_upstream_ha,
                lake_lakes1ha_upstream_n, lake_lakes10ha_upstream_n, lake_lakes10ha_upstream_ha, 
                lake_glaciatedlatewisc)
dt1_western_summary<-merge(dt1_western_summary,lakecharacteristics_trim,  no.dups=TRUE, by="lagoslakeid")


#double checks
dt1_western_summary$year
LakeCat_trim$lagoslakeid<-factor(LakeCat_trim$lagoslakeid)
colnames<-(intersect( colnames(dt1_western_summary),  colnames(LakeCat))) #identify common columns between data.tables
dt1_western_summary<-left_join(dt1_western_summary,LakeCat_trim,by=colnames)# All rows in a that have a match in b


#Where are the NAs? 
#There should be 1205 or so lakes with TP observations
num_NA<-dt1_western_summary %>%
  drop_na(tp_ugl_median)%>% #Include only the lakes where we have observations for TP
  dplyr::select(!ca_mgl_median:ton_ugl_median) %>%
  dplyr::select(!srpp_ugl_median:microcystin_ugl_median) %>%
  summarise_all(funs(sum(is.na(.)))) %>%
  pivot_longer(-1) %>%
  arrange(desc(value))

num_NA<-dt1_western %>%
  dplyr::select(lagoslakeid, year, contains(c("_median"))) %>%
  drop_na(tp_ugl_median)%>% #Include only the lakes where we have observations for TP
  # dplyr::select(!ca_mgl_median:ton_ugl_median) %>%
  # dplyr::select(!srpp_ugl_median:microcystin_ugl_median) %>%
  summarise_all(funs(sum(is.na(.)))) %>%
  pivot_longer(-1) %>%
  arrange(desc(value))
```

### TP spatial df
```{r}
tp_annual_yearasNUM<-dt1_western %>%
  mutate(year=as.numeric(as.character(year))) %>%
  dplyr::select(lagoslakeid, year, tp_ugl_median)
#Data.frame method
setDT(tp_annual_yearasNUM)
tp_spatial<-tp_annual_yearasNUM[, lapply(.SD, median, na.rm=TRUE), .SDcols = is.numeric, by=c("lagoslakeid")  ] 
tp_spatial<-tp_spatial %>%
  drop_na(tp_ugl_median) %>%
    mutate(year=round(year,0))%>% #In this case, year is the MEDIAN of the years sampled. 
    mutate(decade_sampled= #So we are calculating the median decade when these lakes were sampled. May or may not be useful? 
           ifelse(year >1970 & year <=1979, "1970s", 
                  ifelse(year >=1980 & year <=1989, "1980s", 
                         ifelse(year >=1990 & year <=1999, "1990s", 
                                ifelse(year >=2000 & year <=2009, "2000s",
                                       ifelse(year >=2010 & year <=2020, "2010s",
                                          ifelse(year >=2020,  "> 2020", "error"))))))) %>%
  mutate(decade_sampled = factor(decade_sampled,
                                levels = c("1970s", "1980s", "1990s",
                                           "2000s","2010s"," > 2020"))) #Reorder factors for plotting


#We lost some variables in the summary, so adding them back in here
colnames<-(intersect( colnames(tp_spatial),  colnames(lakewatersheds))) #identify common columns between data.tables
tp_spatial_summary<-left_join(tp_spatial,lakewatersheds,   by=colnames)
colnames<-(intersect( colnames(tp_spatial_summary),  colnames(dt1))) #identify common columns between data.tables
tp_spatial_summary<-left_join(tp_spatial,dt1,  by=colnames)
colnames<-(intersect( colnames(tp_spatial_summary),  colnames(depth))) #identify common columns between data.tables
tp_spatial_summary<-left_join(tp_spatial,depth,  by=colnames)

lakecharacteristics_trim <- lakecharacteristics %>%
  dplyr::select(lagoslakeid, lake_perimeter_m, lake_totalarea_ha,
                lake_connectivity_class, lake_connectivity_fluctuates, lake_connectivity_permanent,
                lake_lakes4ha_upstream_ha, lake_lakes4ha_upstream_n, lake_lakes1ha_upstream_ha,
                lake_lakes1ha_upstream_n, lake_lakes10ha_upstream_n, lake_lakes10ha_upstream_ha, 
                lake_glaciatedlatewisc)
colnames<-(intersect( colnames(tp_spatial_summary),  colnames(lakecharacteristics_trim))) #identify common columns between data.tables
tp_spatial_summary<-left_join(tp_spatial_summary,lakecharacteristics_trim,  by=colnames)

#We need the nhdplusv2_comid, so pull out that info and join
comid<-dt4 %>%
  dplyr::select(lagoslakeid, nhdplusv2_comid) %>%
  mutate(lagoslakeid=factor(lagoslakeid)) %>%
  drop_na(nhdplusv2_comid)
colnames<-(intersect( colnames(tp_spatial_summary),  colnames(comid))) #identify common columns between data.tables
tp_spatial_summary_test<-merge(tp_spatial_summary,comid,   no.dups=TRUE, by="lagoslakeid")

tp_spatial_summary_test<-inner_join(comid,tp_spatial_summary,by=colnames)# All rows in a that have a match in b
tp_spatial_summary_test <- tp_spatial_summary_test %>% drop_na(tp_ugl_median)
str(tp_spatial_summary_test$lake_nhdfcode)

#Join with LakeCat
colnames<-(intersect( colnames(tp_spatial_summary),  colnames(LakeCat))) #identify common columns between data.tables
tp_spatial_summary<-left_join(tp_spatial_summary,LakeCat,by=colnames)# All rows in a that have a match in b

head(tp_spatial_summary)

#Where are the NAs? 
num_NA<-tp_spatial_summary %>%
  summarise_all(funs(sum(is.na(.)))) %>%
  pivot_longer(-1) %>%
  arrange(desc(value))
```

#Explore LAGOS-US NETS
```{r}
names(dt3)
names(dt2)
names(dt1)

#Conditionally make category to describe whether or not the lake is in a network or not

#How many lake networks are there? 
dt1_western  %>%
  summarize(n_networks=length(unique(net_id)))
#208

#How many lakes in each network?
test<-tibble(dt1_western)  %>% 
  # slice_head(n = 100) %>%
  dplyr::select(lagoslakeid,net_id, net_lakes_n) %>%
  arrange(desc(net_lakes_n))

#How many LAGOS lakes are in the lake network?
test2 <- test %>%
  group_by(net_id,net_lakes_n) %>%
  summarize(n_lagos_lakes=length(unique(lagoslakeid)))

#Get a dataframe that summarizes the number of years each lake was sampled
dt_limno_yearcount<-dt_limno%>%
  group_by(lagoslakeid) %>%
  summarize(n_years_sampled=length(unique(year)))



```

#LAGOS-US GIS
```{r}
#This will be really cool once the LAGOS-US GIS module is published
devtools::install_git(
  "https://gitlab.msu.edu/stachel2/lagosus", dependencies = TRUE)
remotes::install_github("cont-limno/LAGOSUSgis")
# https://github.com/cont-limno/LAGOSUSgis
library(LAGOSUSgis)
library(sf)
# Until data is posted publicly, place the LAGOSUSgis geodatabase file in the location returned by lagosusgis_path()
Sys.setenv(
  LAGOSUSGIS_PATH = path.expand("data/CL_LAGOSUS_exports/LAGOSUS_LOCUS/LOCUS_v1.0 - GIS FILES/gis_locus_v1.0.gdb"))

# Sys.setenv(
  # LAGOSUSGIS_PATH = path.expand("data/CL_LAGOSUS_exports/LAGOSUS_LOCUS/LOCUS_v1.0 - GIS FILES/LAGOS_GIS_Toolbox-2.0-beta/TestData_0411.gdb"))

#List available GIS layers
sf::st_layers(LAGOSUSgis::lagosusgis_path())

```


#Explore fire patterns
Monitoring Trends in Burn Severity (MTBS) Program 
```{r}
likely_lakes <- st_read('~/Dropbox/dropbox Research/Western-Color-Fire/HydroLakes_DP.shp')

singular_fetch <- function(index = 1){
 
  wbd <- try(get_waterbodies(likely_lakes[index,]), silent = T)
 
  if(length(class(wbd)) == 1){
    wbd <- NULL
  } else {
    wbd <- wbd %>%
      dplyr::select(id:onoffnet,meandepth,maxdepth) %>%
      mutate(onoffnet = as.character(onoffnet),
             meandepth = as.numeric(meandepth),
             maxdepth = as.numeric(maxdepth))
  }
 
  return(wbd)
}

full_fetch <- purrr::map(1:nrow(likely_lakes),singular_fetch)

full_nhd <- do.call('rbind',full_fetch)


names(MTBS)

#Describes proportion of catchment / watershed within burn perimeters
#But I think I'm missing the burn severity numbers 
MTBS_long <- MTBS %>%
  # pivot_longer(-(1:6), names_sep = "_", names_to = c("variable","yearscale")) %>%
    pivot_longer(-(1:6), names_pattern = "(\\d+)([A-Za-z]+)", names_to = c("year","scale"))
    # "([A-Za-z]+)" matches only letters, so will pull out just "Ws" or "Cat". "(\\d+)" matches digits and will pull out the year.
  
names(MTBS_long)

MTBS_long %>%
  filter(value>0)%>%
  filter(scale=="Ws") %>%
  ggplot(aes(value)) +
  geom_histogram() +
  facet_wrap(~year, scales="free") +
  ggtitle("MTBS % area burned - Ws scale")

MTBS_long %>%
  filter(value>0)%>%
  filter(scale=="Cat") %>%
  ggplot(aes(value)) +
  geom_histogram() +
  facet_wrap(~year, scales="free") +
  ggtitle("MTBS % area burned - Cat scale (local)")

MTBS_long %>%
  filter(value>0)%>%
  filter(scale=="Cat") %>%
  mutate(year=as.numeric(year))%>%
  ggplot(aes(value, group=year)) +
  scale_fill_continuous_sequential(palette="YlGnBu")+
  geom_density(aes(fill=year), alpha=0.4) +
  facet_wrap(~year, scales="free") +
  ggtitle("MTBS % area burned - Cat scale (local)")



#Number of lakes that experienced forest loss due to fire within local catchment
MTBS_summary<- left_join(MTBS_long%>%
  filter(value>0)%>%
  filter(scale=="Cat") %>%
  group_by(year) %>%
  summarize(n_lakes_Cat=length(unique(nhdplusv2_comid))) ,

#Number of lakes that experienced forest loss due to fire 2000-2010 within larger watershed
MTBS_long%>%
  filter(value>0)%>%
  filter(scale=="Ws") %>%
  group_by(year) %>%
  summarize(n_lakes_Ws=length(unique(nhdplusv2_comid))) ,

by="year")


MTBS_summary %>%
  

#Does the number of small fires look like it's increasing?
MTBS_long %>%
  filter(value>0 & value<20)%>%
  filter(scale=="Cat") %>%
  mutate(year=as.numeric(year))%>%
  ggplot(aes(value, group=year)) +
  scale_color_continuous_sequential(palette="YlGnBu")+
  geom_density(aes(color=year)) +
  # facet_wrap(~year) +
  ggtitle("MTBS % area burned - Cat scale (local)")+
  theme_dark()


#Does the number of moderate fires look like it's increasing?
MTBS_long %>%
  filter(value>20 & value<80)%>%
  filter(scale=="Cat") %>%
  mutate(year=as.numeric(year))%>%
  ggplot(aes(value, group=year)) +
  scale_color_continuous_sequential(palette="YlGnBu")+
  geom_density(aes(color=year)) +
  # facet_wrap(~year) +
  ggtitle("MTBS % area burned - Cat scale (local)")+
  theme_dark()



names(FirePerimeters)

FirePeriments_long<- FirePerimeters %>%
      pivot_longer(-(1:6), names_pattern = "([A-Za-z]+)(\\d+)([A-Za-z]+)", names_to = c("units","year","scale"))

FirePeriments_long %>%
  filter(value>0 & value <25)%>%
  filter(scale=="Ws") %>%
  ggplot(aes(value)) +
  geom_histogram() +
  facet_wrap(~year, scales="free") +
  ggtitle("% Forest loss to fire - Ws scale")

FirePeriments_long %>%
  filter(value>0 & value <25)%>%
  filter(scale=="Cat") %>%
  ggplot(aes(value)) +
  geom_histogram() +
  facet_wrap(~year, scales="free") +
  ggtitle("% Forest loss to fire - local Cat scale")



#Number of lakes that experienced forest loss due to fire 2000-2010 within local catchment
FirePeriments_long%>%
  filter(value>0)%>%
  filter(scale=="Cat") %>%
  group_by(year) %>%
  summarize(n_lakes=length(unique(nhdplusv2_comid)))


#Number of lakes that experienced forest loss due to fire 2000-2010 within larger watershed
FirePeriments_long%>%
  filter(value>0)%>%
  filter(scale=="Ws") %>%
  group_by(year) %>%
  summarize(n_lakes=length(unique(nhdplusv2_comid)))



```

#Map the networks 
```{r}




#What are the lakes with NAs for years? Do they have ANY chemistry? And if so, how?
dt1_western_QAQC <- dt1_western[is.na(dt1_western$year),] #yeah, no chemistry
dt1_western_QAQC_chla <- dt1_western_QAQC[!is.na(dt1_western_QAQC$chla_ugl),]
dt1_western_QAQC_doc <- dt1_western_QAQC[!is.na(dt1_western_QAQC$doc_mgl),]

rivers50 <- ne_download(scale = "large", type = 'rivers_lake_centerlines', category = 'physical', returnclass = "sf")
sp::plot(rivers50)
us <- ne_countries(scale = "medium", country="united states of america",returnclass = "sf")

states<-(map_data("state", boundary = FALSE, interior = TRUE))
str(states)

#Crop to western US
us_crop <- st_crop(us
                    , xmin = -130, xmax = -100, ymin = 32, ymax = 49)

#Map all sites, color for whether or not they are in or out of network
ggplot()+
  geom_sf(data = us,color = "black")+
  geom_sf(data=rivers50, color="lightblue")+
  geom_sf(data=likely_lakes, color="purple")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -100), ylim = c(32, 49))

  # geom_point(data=dt1_western, aes(lake_lon_decdeg, lake_lat_decdeg, color=connectivity_type))

#How many of each type? 
dt1_western %>%
  group_by(lake_centroidstate, connectivity_type) %>%
  summarize(n=length(unique(lagoslakeid)))%>%
  ggplot(aes(x=connectivity_type, y=n, fill=connectivity_type))+
  geom_bar(stat="identity",  color="black")+
  scale_fill_viridis_d()+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=6))+
  facet_wrap(~lake_centroidstate)

#Do the lakes vary in some systematic way depending whether or not they are in a network?
#e.g., are in-network lakes more likely to be reservoirs? are out-of-network lakes more like to be higher elevation? 
dt1_western %>%
  dplyr::select(connectivity_type,  temp_degc_median,
                secchi_m_median, doc_mgl_median, lake_elevation_m, tn_ugl_median, tp_ugl_median) %>%
  pivot_longer(-1)%>%
  # mutate_if(is.numeric, log10, na.rm=TRUE)%>%
  ggplot(aes(x=value, fill=connectivity_type))+
  geom_density(alpha=0.25)+
  scale_fill_viridis_d()+
  facet_wrap(~name, scales="free")+
  scale_x_log10()
#Hard to say. There just tend to be more observations for the no network lakes in general. 


#Extract the IDs of the lakes where we have > 2 year of data 
lagosSamples<-dt_limno_yearcount %>%
  filter(n_years_sampled>2)%>%
  pivot_wider(names_from=lagoslakeid, values_from=n_years_sampled) %>%
  names()
lagosSamples


#Only plot lakes that were actually sampled 
ggplot()+
    geom_sf(data = us,color = "black")+
      geom_polygon(data=states, aes(x=long, y=lat, group=group),
               fill=NA, color="black",
               linetype="dashed")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -103), ylim = c(32, 49), expand=TRUE)+
  geom_point(data=dt1_western %>%
               filter(lagoslakeid %in% lagosSamples) %>%
               left_join(.,dt_limno_yearcount,by="lagoslakeid") %>%
               filter(!n_years_sampled=="NA" &
                        !lake_rsvr_class=="NA"), aes(lake_lon_decdeg, lake_lat_decdeg, color=n_years_sampled, shape=lake_rsvr_class), 
             alpha=0.5)+
  scale_color_gradientn(colors=c("blue","red"))

#Any lakes have over 5, 10 years of data? 
ggplot()+
    geom_sf(data = us,color = "black")+
      geom_polygon(data=states, aes(x=long, y=lat, group=group),
               fill=NA, color="black",
               linetype="dashed")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -103), ylim = c(32, 49), expand=TRUE)+
  geom_point(data=dt1_western %>%
               filter(lagoslakeid %in% lagosSamples) %>%
               left_join(.,dt_limno_yearcount,by="lagoslakeid") %>%
               filter(n_years_sampled>=10 &
                        !lake_rsvr_class=="NA"), aes(lake_lon_decdeg, lake_lat_decdeg, color=n_years_sampled, shape=lake_rsvr_class), 
             alpha=0.5)+
  scale_color_gradientn(colors=c("blue","red"))

```

## Zoom in on California
```{r}

#Zoom in on the California area
ggplot() + 
    geom_sf(data = us,color = "black")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-125, -118), ylim = c(36,42))+
  geom_point(data=dt1_western %>%
               filter(net_id %in% c("59")), aes(lake_lon_decdeg, lake_lat_decdeg, color=lake_elevation_m,shape=net_id))+
  scale_color_gradientn(colors=c("blue","red"))


#Make a map of the area with the lakes colored by # of samples
ggplot() + 
    geom_sf(data = us,color = "black")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-125, -118), ylim = c(36,42))+
  geom_point(data=dt1_western %>%
               filter(net_id %in% c("59")) %>%
               left_join(.,dt_limno_yearcount,by="lagoslakeid") %>%
               filter(!n_years_sampled=="NA"),
             aes(lake_lon_decdeg, lake_lat_decdeg,
                 color=n_years_sampled))+
  scale_color_gradientn(colors=c("blue","red"))

#Aw bummer. So it looks like we have so many IDs because of needing to spatially reference lakes for which we have no data.
#How many lakes in this region ACTUALLY have data?
testing<-dt1_western %>%
               filter(net_id %in% c("59")) %>%
               left_join(.,dt_limno_yearcount,by="lagoslakeid") %>%
  dplyr::select(lagoslakeid, n_years_sampled)%>%
  drop_na(n_years_sampled) %>%
  ungroup()%>%
  summarize(n_LAGOS_lakes=length(unique(lagoslakeid)))
#161
```

## How many lakes HAVE a network, and how many of those networks include multiple years of data?
```{r}

#For lakes in a lake network, how many lakes have > 5 years of data
n_5year_lakes<-dt1_western %>%
  filter(connectivity_type=="yes network") %>%
  group_by(lagoslakeid) %>%
  mutate(n_years_sampled=length(unique(year)))%>%
  filter(n_years_sampled>=5) %>%
  group_by(net_id)%>%
  summarize(n_lakes_pernetwork_withLTdata=length(unique(lagoslakeid))) 

#Total lakes
n_5year_lakes %>%
  summarize(total_lakes=sum(n_lakes_pernetwork_withLTdata))
#284

#For lakes in a lake network, how many lakes have > 10 years of data
n_10year_lakes<-dt1_western %>%
  filter(connectivity_type=="yes network") %>%
  group_by(lagoslakeid) %>%
  mutate(n_years_sampled=length(unique(year)))%>%
  filter(n_years_sampled>=10) %>%
  group_by(net_id)%>%
  summarize(n_lakes_pernetwork_withLTdata=length(unique(lagoslakeid))) 

#Total lakes
n_10year_lakes %>%
  summarize(total_lakes=sum(n_lakes_pernetwork_withLTdata))
#123

#Any lakes have over 5, 10 years of data? 
#Shape for network type
ggplot()+
  geom_sf(data = us,color = "black")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -100), ylim = c(32, 49), expand=TRUE)+
  geom_point(data=dt1_western %>%
               # filter(net_id %in% c("1","3","34","59")) %>%
               left_join(.,dt_limno_yearcount,by="lagoslakeid") %>%
               filter(n_years_sampled>=10), aes(lake_lon_decdeg, lake_lat_decdeg,
                                                color=n_years_sampled, shape=connectivity_type))+
  scale_color_gradientn(colors=c("blue","red")) 


#Map the networks with the highest number of lakes with LT data 
n_10year_lakes %>%
  filter(n_lakes_pernetwork_withLTdata>=4)

ggplot()+
  geom_sf(data = us,color = "black")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -100), ylim = c(32, 49), expand=TRUE)+
  geom_point(data=dt1_western %>%
               filter(net_id %in% c("1","3","34","119",
                                    "140","237","99")) %>%
               left_join(.,dt_limno_yearcount,by="lagoslakeid") %>%
               filter(n_years_sampled>=10), aes(lake_lon_decdeg, lake_lat_decdeg, fill=net_id),
             shape=21)+
  scale_fill_viridis_d()


#Regardless of network connectivity, how many lakes have > 10 years of data
n_lakes_over10years_data_inNetwork<-dt1_western %>%
  group_by(lagoslakeid) %>%
  mutate(n_years_sampled=length(unique(year))) %>%
  filter(n_years_sampled>=10)
nrow(n_lakes_over10years_data)
#178
n_lakes_over10years_data_inNetwork %>%
  ungroup()%>%
  summarize(sum=sum(n_years_sampled))
#representing 43811 lake-years 

#Group by network connectivity
n_lakes_over10years_data_ALL<- dt1_western %>%
  group_by(lagoslakeid, connectivity_type) %>%
  mutate(n_years_sampled=length(unique(year))) %>%
  filter(n_years_sampled>=10) %>%
  group_by(connectivity_type) %>%
  summarize(total_lakeyears=sum(n_years_sampled))
n_lakes_over10years_data_ALL
#2575


```

### Zoom in PNW
```{r}
ggplot()+
  geom_sf(data = us,color = "black")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-125, -109), ylim = c(40, 49), expand=TRUE)+
  geom_point(data=dt1_western %>%
               filter(net_id %in% c("34")) %>%
               left_join(.,dt_limno_yearcount,by="lagoslakeid") %>%
               filter(n_years_sampled>=10), aes(lake_lon_decdeg.x, lake_lat_decdeg.x, fill=net_id),
             shape=21)+
  scale_fill_viridis_d()



#Interactive map
#Query
library(mapview)

net_id_34_WS<-dt1_western %>%
  filter(net_id=="34") %>%
  left_join(.,dt_limno_yearcount,by="lagoslakeid") %>%
               filter(!n_years_sampled=="NA") %>%
  filter(n_years_sampled>=10)%>%
  dplyr::select(lagoslakeid,n_years_sampled)%>%
  pivot_wider(names_from=lagoslakeid, values_from=n_years_sampled) %>%
  names()
net_id_34_WS

res_iws_net_id_34<-query_gis(layer = "ws", 
                      id_name = "lagoslakeid",
                      ids = net_id_34_WS)
lakes_id_34<-query_gis(layer = "eligible_lakes", 
                      id_name = "lagoslakeid",
                      ids = net_id_34_WS)

mapview(res_iws_net_id_34, color = "black", col.regions = "green") + mapview(lakes_id_34, color = "black", col.regions = "blue")



```


### Zoom in Utah
```{r}

#Interactive map
#Query
library(mapview)
net_id_140_WS<-dt1_western %>%
  filter(net_id=="140") %>%
  left_join(.,dt_limno_yearcount,by="lagoslakeid") %>%
               filter(!n_years_sampled=="NA") %>%
  filter(n_years_sampled>=10)%>%
  dplyr::select(ws_zoneid) 
net_id_140_WS<-as.character(net_id_140_WS)
net_id_140_WS

res_iws_net_id_140<-query_gis(layer = "ws", 
                      id_name = "lagoslakeid",
                      ids = c(455748, 455860, 455973, 456254, 456264, 456333))
lakes_id_140<-query_gis(layer = "lake", 
                      id_name = "lagoslakeid",
                      ids = c(455748, 455860, 455973, 456254, 456264, 456333))
nws_id_140<-query_gis(layer = "nws", 
                      id_name = "lagoslakeid",
                      ids = c(455748, 455860, 455973, 456254, 456264, 456333))

mapview(res_iws_net_id_140, color = "black", col.regions = "green") + mapview(lakes_id_140, color = "black", col.regions = "blue") + 
  mapview(nws_id_140, color = "black", col.regions = "grey20")



```


#Long term data
### What exists?
```{r}
#Regardless of network connectivity, how many lakes have > 10 years of data
n_years_over10years_data<-dt_limno_yearcount %>%
  filter(n_years_sampled>=10)

dt_limno_LT<- dt_limno %>%
  left_join(.,dt_limno_yearcount, by="lagoslakeid") %>%
  filter(n_years_sampled>=10)

#How many unique lakes? 
dt_limno_LT %>%
  summarize(n_lagos_lakes=length(unique(lagoslakeid))) 

str(dt_limno_LT)

#How many lakes have long term observatiosn of secchi?
LT_secchi_IDs<-dt_limno%>%
  drop_na(secchi_m_median)%>%
  # drop_na(lake_centroidstate)%>%
  group_by(lagoslakeid) %>%
  summarize(n_years_sampled=length(unique(year))) %>%
  filter(n_years_sampled>=10)
#568, but only 95 have state IDs. What gives?




LT_secchi<-LT_secchi_IDs %>%
  inner_join(.,dt_limno, by="lagoslakeid") 

#Where are these sites? 
ggplot()+
  geom_sf(data = us,color = "black")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -104), ylim = c(25, 49))+
  geom_point(data=LT_secchi , aes(lake_lon_decdeg, lake_lat_decdeg, fill=(secchi_m_median)), shape=21)+
  scale_fill_viridis_c()

ggplot()+
  geom_sf(data = us,color = "black")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -70), ylim = c(25, 49))+
  geom_point(data=LT_secchi , aes(site_lon_decdeg, site_lat_decdeg, fill=(hu4_zoneid)), shape=21)+
  scale_fill_viridis_d()

#Plot long-term secchi by state
LT_secchi %>%
  filter(!lake_centroidstate=="NA")%>%
  ggplot(aes(x=year,y=secchi_m,group=lagoslakeid))+
  geom_point(size=2.5,shape=2.5)+
  geom_line()+
  facet_wrap(~lake_centroidstate)+
  theme_bw()
#Most data come from UT, CO, and WA

LT_secchi %>%
  filter(lake_centroidstate %in% c("CO"))%>%
  ggplot(aes(x=as.numeric(as.character(year)),y=secchi_m, fill=lake_elevation_m))+
  geom_point(size=2.5,shape=21)+
  scale_fill_viridis_c()+
  geom_smooth(method="lm",se=F)+
  facet_wrap(lagoslakeid~.)+
  theme_bw()
LT_secchi %>%
  filter(lake_centroidstate %in% c("UT"))%>%
  ggplot(aes(x=as.numeric(as.character(year)),y=secchi_m, fill=lake_elevation_m))+
  geom_point(size=2.5,shape=21)+
  scale_fill_viridis_c()+
  geom_smooth(method="lm",se=F)+
  facet_wrap(lagoslakeid~.)+
  theme_bw()
LT_secchi %>%
  filter(lake_centroidstate %in% c("WA"))%>%
  ggplot(aes(x=as.numeric(as.character(year)),y=secchi_m, fill=lake_elevation_m))+
  geom_point(size=2.5,shape=21)+
  geom_smooth(method="lm",se=F)+
  scale_fill_viridis_c()+
  facet_wrap(lagoslakeid~.)+
  theme_bw()

```

## Years with most data?
```{r}
dt1_western%>%
  dplyr::select(lagoslakeid, year)%>%
  drop_na(year) %>%
  group_by(year) %>%
  summarize(n_lakes_sampled=length(unique(lagoslakeid))) %>%
  arrange(desc(n_lakes_sampled)) 

dt1_western%>%
  dplyr::select(lagoslakeid, year)%>%
  drop_na(year) %>%
  group_by(year) %>%
  summarize(n_lakes_sampled=length(unique(lagoslakeid))) %>%
  arrange(desc(n_lakes_sampled)) %>%
  ggplot(aes(x=as.numeric(as.character(year)), y=n_lakes_sampled, fill=year))+
  geom_bar(stat="identity",  color="black")+
  scale_fill_viridis_d()+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=6))+
  ggtitle("Number of unique lakes sampled each year")+
    geom_text(aes(label = n_lakes_sampled),
              position=position_nudge(y=10), size=3)


#How many TOTAL lakes are there?

dt1_western%>%
  dplyr::select(lagoslakeid, year)%>%
  # drop_na(year) %>%
  # group_by(year) %>%
  summarize(n_lakes_sampled=length(unique(lagoslakeid))) %>%
  arrange(desc(n_lakes_sampled)) 
#So that's pretty abismal given that there are 54,000 water bodies identified in this dataset?!?!

#How many TOTAL lakes in each state?
n_lakes_BYSTATE<-dt1_western%>%
  dplyr::select(lagoslakeid, year,lake_centroidstate)%>%
  group_by(lake_centroidstate) %>%
  summarize(n_lakes_per_state=length(unique(lagoslakeid))) %>%
  arrange(desc(n_lakes_per_state)) 

n_lakes_BYSTATE%>%
  ggplot(aes(x=lake_centroidstate, y=n_lakes_per_state, fill=lake_centroidstate))+
  geom_bar(stat="identity",  color="black")+
  scale_fill_viridis_d()+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=10))+
  ggtitle("Number of unique lakes in each state (>1 ha, including unsampled)")+
  geom_text(aes(label = n_lakes_per_state),
              position = position_stack(vjust = .5))


#Number of lakes SAMPLED per state? 
n_lakes_sampled_BYSTATE<-dt1_western%>%
  dplyr::select(lagoslakeid, lake_centroidstate,year)%>%
  drop_na(year) %>%
  group_by(lake_centroidstate) %>%
  summarize(n_lakes_sampled_per_state=length(unique(lagoslakeid))) %>%
  arrange(desc(n_lakes_sampled_per_state)) 

n_lakes_sampled_BYSTATE%>%
  ggplot(aes(x=lake_centroidstate, y=n_lakes_sampled_per_state, fill=lake_centroidstate))+
  geom_bar(stat="identity",  color="black")+
  scale_fill_viridis_d()+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=10))+
  ggtitle("Number of unique lakes SAMPLED in each state (>1 ha, including unsampled)")+
  geom_text(aes(label = n_lakes_sampled_per_state),
              position = position_stack(vjust = .5))

#What proportion of all lakes in each state have been sampled?
left_join(n_lakes_BYSTATE,n_lakes_sampled_BYSTATE,
  by="lake_centroidstate") %>%
  mutate(perc_sampled=(n_lakes_sampled_per_state/n_lakes_per_state)*100) %>%
  ggplot(aes(x=reorder(lake_centroidstate, perc_sampled), y=perc_sampled, fill=lake_centroidstate))+
  geom_bar(stat="identity",  color="black")+
  scale_fill_viridis_d()+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=10))+
  ggtitle("Percentage of lakes >1ha in each state ever sampled")+
  geom_text(aes(label = round(perc_sampled,1)),
              position = position_stack(vjust = .5))


```

### Totals for EcoDAS
```{r}

# What is the difference between these two datasets?
NO3_LT_names<-dt1_western%>%
  dplyr::select(lagoslakeid, no2no3n_ugl_median, year)%>%
  drop_na(no2no3n_ugl_median) %>%
  group_by(lagoslakeid) %>%
  summarize(n_years_sampled=length(unique(year))) %>%
  arrange(desc(n_years_sampled)) %>%
  filter(n_years_sampled>=10) %>%
  pivot_wider(names_from=lagoslakeid, values_from=n_years_sampled) %>%
  names()

NO3_LT<-dt1_western%>%
  dplyr::select(lagoslakeid, no2no3n_ugl_median, year)%>%
  drop_na(no2no3n_ugl_median) %>% 
  filter(lagoslakeid %in% NO3_LT_names) %>%
  arrange(lagoslakeid,year)


TP_LT_names<-dt1_western%>%
  dplyr::select(lagoslakeid, tp_ugl_median, year)%>%
  drop_na(tp_ugl_median) %>%
  group_by(lagoslakeid) %>%
  summarize(n_years_sampled=length(unique(year))) %>%
  arrange(desc(n_years_sampled)) %>%
  filter(n_years_sampled>=10) %>%
  pivot_wider(names_from=lagoslakeid, values_from=n_years_sampled) %>%
  names()

TP_LT<-dt1_western%>%
  dplyr::select(lagoslakeid, tp_ugl_median, year)%>%
  drop_na(tp_ugl_median) %>% 
  filter(lagoslakeid %in% TP_LT_names) %>%
  arrange(lagoslakeid,year)

NH4_LT_names<-dt1_western%>%
  dplyr::select(lagoslakeid, nh4n_ugl_median, year)%>%
  drop_na(nh4n_ugl_median) %>%
  group_by(lagoslakeid) %>%
  summarize(n_years_sampled=length(unique(year))) %>%
  arrange(desc(n_years_sampled)) %>%
  filter(n_years_sampled>=10) %>%
  pivot_wider(names_from=lagoslakeid, values_from=n_years_sampled) %>%
  names()

NH4_LT<-dt1_western%>%
  dplyr::select(lagoslakeid, nh4n_ugl_median, year)%>%
  drop_na(nh4n_ugl_median) %>% 
  filter(lagoslakeid %in% NH4_LT_names) %>%
  arrange(lagoslakeid,year)

temperature_LT_names<-dt1_western%>%
  dplyr::select(lagoslakeid, temp_degc_median, year)%>%
  drop_na(temp_degc_median) %>%
  group_by(lagoslakeid) %>%
  summarize(n_years_sampled=length(unique(year))) %>%
  arrange(desc(n_years_sampled)) %>%
  filter(n_years_sampled>=10) %>%
  pivot_wider(names_from=lagoslakeid, values_from=n_years_sampled) %>%
  names()

temperature_LT<-dt1_western%>%
  dplyr::select(lagoslakeid, temp_degc_median, year)%>%
  drop_na(temp_degc_median) %>% 
  filter(lagoslakeid %in% temperature_LT_names) %>%
  arrange(lagoslakeid,year)

DOC_LT_names<-dt1_western%>%
  dplyr::select(lagoslakeid, doc_mgl_median, year)%>%
  drop_na(doc_mgl_median) %>%
  group_by(lagoslakeid) %>%
  summarize(n_years_sampled=length(unique(year))) %>%
  arrange(desc(n_years_sampled)) %>%
  filter(n_years_sampled>=10) %>%
  pivot_wider(names_from=lagoslakeid, values_from=n_years_sampled) %>%
  names()

DOC_LT<-dt1_western%>%
  dplyr::select(lagoslakeid, doc_mgl_median, year)%>%
  drop_na(doc_mgl_median) %>% 
  filter(lagoslakeid %in% DOC_LT_names) %>%
  arrange(lagoslakeid,year)

secchi_LT_names<-dt1_western%>%
  dplyr::select(lagoslakeid, secchi_m_median, year)%>%
  drop_na(secchi_m_median) %>%
  group_by(lagoslakeid) %>%
  summarize(n_years_sampled=length(unique(year))) %>%
  arrange(desc(n_years_sampled)) %>%
  filter(n_years_sampled>=10) %>%
  pivot_wider(names_from=lagoslakeid, values_from=n_years_sampled) %>%
  names()

secchi_LT<-dt1_western%>%
  dplyr::select(lagoslakeid, secchi_m_median, year)%>%
  drop_na(secchi_m_median) %>% 
  filter(lagoslakeid %in% secchi_LT_names) %>%
  arrange(lagoslakeid,year)

LT_master<-full_join(NO3_LT,TP_LT, by=c("lagoslakeid","year"))
LT_master<-full_join(LT_master,NH4_LT, by=c("lagoslakeid","year"))
LT_master<-full_join(LT_master,temperature_LT, by=c("lagoslakeid","year"))
LT_master<-full_join(LT_master,DOC_LT, by=c("lagoslakeid","year"))
LT_master<-full_join(LT_master,secchi_LT, by=c("lagoslakeid","year"))%>%
  arrange(lagoslakeid,year)

#Add lake_rsvr_class manually again
LT_master <- LT_master %>%
  left_join(., reservoir %>%
              dplyr::select(lagoslakeid, lake_rsvr_class), by="lagoslakeid")


```

#### Missing rsvr class
```{r}

#How many lakes are missing a rsvr classification?
LT_master %>%
  filter(is.na(lake_rsvr_class)) %>%
  group_by(lake_rsvr_class) %>%
  summarize(n=length(unique(lagoslakeid)))

NArsvrs<-LT_master %>%
  filter(is.na(lake_rsvr_class)) %>%
  dplyr::select(lagoslakeid)%>%
  unique()

##Manually add the classifications
NArsvrs<- NArsvrs %>%
  mutate(lake_rsvr_class="NL") %>%
  rename(lake_rsvr_class_update=lake_rsvr_class)
  # mutate(lake_rsvr_class = replace(lake_rsvr_class, lagoslakeid %in% c("453326"), 'RSVR?')) #THIS IS THE ONLY LAKE I THINK IS IFFY ON THE RESERVOIR FRONT. THERE IS ONE SIDE OF IT THAT LOOKS LIKE AN IMPOUNDMENT


#Add to the LT_master
LT_master<- LT_master %>%
  left_join(.,NArsvrs, by="lagoslakeid")%>%
  mutate(lake_rsvr_class_new=coalesce(lake_rsvr_class,lake_rsvr_class_update)) %>%
  dplyr::select(-lake_rsvr_class, -lake_rsvr_class_update) %>%
  rename(lake_rsvr_class=lake_rsvr_class_new)

#Add lat/long data
LT_master <- LT_master %>%
  left_join(., dt4, by="lagoslakeid")

LT_master_long <-  LT_master %>%
  dplyr::select(lake_lat_decdeg, lake_lon_decdeg, lagoslakeid:lake_rsvr_class) %>%
  pivot_longer(-c("lake_lat_decdeg","lake_lon_decdeg","lagoslakeid","year","lake_rsvr_class")) 
```


#### Tallies
```{r}

#How many lakes have long-term (>=10 years) of data of any sort?
length(unique(LT_master$lagoslakeid))

#Which lakes have the MOST observations?
nObs<-LT_master %>%
  group_by(lagoslakeid) %>%
  summarize(n_years_chem_data=length(unique(year))) %>%
  arrange(desc(n_years_chem_data))


#Group by reservoir class and parameter
LT_master %>%
  dplyr::select(lagoslakeid,lake_rsvr_class,no2no3n_ugl_median)%>%
  drop_na(no2no3n_ugl_median) %>%
  # group_by(lake_rsvr_class) %>%
  summarize(n=length(unique(lagoslakeid))) 


#How many lakes have long-term data on NO3?
LT_master %>%
  dplyr::select(lagoslakeid,no2no3n_ugl_median)%>%
  drop_na(no2no3n_ugl_median) %>%
  summarize(n=length(unique(lagoslakeid))) %>%
  pull()

#How many lakes have long-term data on NO3 & TP?
LT_master %>%
  dplyr::select(lagoslakeid,no2no3n_ugl_median,tp_ugl_median)%>%
  drop_na(no2no3n_ugl_median, tp_ugl_median) %>%
  summarize(n=length(unique(lagoslakeid))) %>%
  pull()


#How many lakes have long-term data on TP?
LT_master %>%
  dplyr::select(lagoslakeid,tp_ugl_median)%>%
  drop_na(tp_ugl_median) %>%
  summarize(n=length(unique(lagoslakeid))) %>%
  pull()


#How many lakes have long-term data on DOC?
LT_master %>%
  dplyr::select(lagoslakeid,doc_mgl_median)%>%
  drop_na(doc_mgl_median) %>%
  summarize(n=length(unique(lagoslakeid))) %>%
  pull()

#How many lakes have long-term data on DOC, secchi?
LT_master %>%
  dplyr::select(lagoslakeid,doc_mgl_median,secchi_m_median)%>%
  drop_na(doc_mgl_median,secchi_m_median) %>%
  summarize(n=length(unique(lagoslakeid))) %>%
  pull()

#How many lakes have long-term data on TP, secchi?
LT_master %>%
  dplyr::select(lagoslakeid,tp_ugl_median,secchi_m_median)%>%
  drop_na(tp_ugl_median,secchi_m_median) %>%
  summarize(n=length(unique(lagoslakeid))) %>%
  pull()

#How many lakes have long-term data on TP, secchi, NO3?
LT_master %>%
  dplyr::select(lagoslakeid,tp_ugl_median,secchi_m_median,no2no3n_ugl_median)%>%
  drop_na(tp_ugl_median,secchi_m_median,no2no3n_ugl_median) %>%
  summarize(n=length(unique(lagoslakeid))) %>%
  pull()

#How many lakes have long-term data on TP, temp, NO3?
LT_master %>%
  dplyr::select(lagoslakeid,tp_ugl_median,temp_degc_median,no2no3n_ugl_median)%>%
  drop_na(tp_ugl_median,temp_degc_median,no2no3n_ugl_median) %>%
  summarize(n=length(unique(lagoslakeid))) %>%
  pull()

#How many lakes have long-term data on NO3, secchi?
LT_master %>%
  dplyr::select(lagoslakeid,secchi_m_median,no2no3n_ugl_median)%>%
  drop_na(secchi_m_median,no2no3n_ugl_median) %>%
  summarize(n=length(unique(lagoslakeid))) %>%
  pull()



LT_master_DOCsecchi<- LT_master %>%
  drop_na(doc_mgl_median,secchi_m_median)
```

#### Map of sites
```{r}

  ggplot()+
    geom_sf(data = us,color = "black")+
      geom_polygon(data=states, aes(x=long, y=lat, group=group),
               fill=NA, color="black",
               linetype="dashed")+
    # geom_sf(data=rivers50, color="lightblue")+  
  annotation_scale(location = "bl", width_hint = 0.2) +
    coord_sf(xlim = c(-130, -100), ylim = c(32, 49), expand=TRUE)+
  geom_point(data=LT_master_long, aes(lake_lon_decdeg, lake_lat_decdeg, fill=name, shape=lake_rsvr_class),
             size=2.5, alpha=0.6)+
  scale_shape_manual(values=c(21,25))+
  # scale_fill_continuous_diverging(palette = "Blue-Red",
  #                                 name="log10(TP)")+
  # ggtitle("TP")+
  theme_classic() +
  facet_wrap(~name)

  ggplot()+
    geom_sf(data = us,color = "black")+
      geom_polygon(data=states, aes(x=long, y=lat, group=group),
               fill=NA, color="black",
               linetype="dashed")+
    geom_sf(data=rivers50, color="lightblue")+
  annotation_scale(location = "bl", width_hint = 0.2) +
    coord_sf(xlim = c(-130, -100), ylim = c(32, 49), expand=TRUE)+
  geom_point(data=LT_master %>%
               drop_na(temp_degc_median), aes(lake_lon_decdeg, lake_lat_decdeg, shape=lake_rsvr_class),
             size=2.5, alpha=0.6, fill="grey50")+
  scale_shape_manual(values=c(21,25))+
  # scale_fill_continuous_diverging(palette = "Blue-Red",
  #                                 name="log10(TP)")+
  ggtitle("Water temperature")+
  theme_classic() 
```

#### Temperature/DO profiles
```{r}

profiles<-read.csv(here("data/CL_LAGOSUS_exports/LAGOSUS_LIMNO/US/LIMNO_v2.1/Final_exports/site_profiles_all.csv")) %>%
    mutate(event_date=lubridate::ymd(event_date),
         year=lubridate::year(event_date),
         year=factor(year),
         lagoslakeid=factor(lagoslakeid))

profiles_summary <- profiles %>%
  group_by(lagoslakeid) %>%
  summarize(n_profiles=length(unique(event_date)))



reservoirsWithProfileData <- left_join(nObs,profiles_summary,by="lagoslakeid") %>%
  drop_na(n_profiles)

#For the purpose of Laura Soares' project it probably makes more sense to look at all of the RSVRs in the US,
#then join it with the profile_summary dataset.
reservoirOnly<-reservoir %>%
  filter(lake_rsvr_class=="RSVR") %>%
  dplyr::select(lagoslakeid, lake_rsvr_class) %>%
  pivot_wider(names_from=lagoslakeid, values_from=lake_rsvr_class) %>%
  names()

profiles_summary_reservoir <- profiles_summary %>%
  filter(lagoslakeid %in% reservoirOnly)

multProfilesReservoirs<-profiles_summary_reservoir %>%
  filter(n_profiles>10) %>%
  pivot_wider(names_from=lagoslakeid, values_from=n_profiles) %>%
  names()

profiles_summary_annual <- profiles %>%
  group_by(lagoslakeid,year) %>%
  summarize(n_profiles=length(unique(event_date))) %>%
  filter(lagoslakeid %in% multProfilesReservoirs)

manyObsProfilesNames<-profiles_summary_annual %>%
  dplyr::select(-year)%>%
  pivot_wider(names_from=lagoslakeid, values_from=n_profiles, values_fn=mean) %>%
  names()

profiles_trim<-profiles %>%
  filter(lagoslakeid %in% manyObsProfilesNames)


##Plots...
profiles_trim %>%
  mutate(doy=yday(event_date))%>%
  filter(analyte_name=="temp_degc")%>%
  ggplot(aes(x=analyte_value, y=event_depth_m, color=year))+
  geom_point()+
  scale_y_reverse()+
  labs(x="Temperature (Celcius)",
       y="Depth (m)")+
  facet_wrap(~lagoslakeid, scales="free")

```

### Totals by parameter
```{r}

#Number of non-NAs per parameter
nonNAs<-dt1_western %>%
  dplyr::select((-contains("detectionlimit")))%>%
  dplyr::select((-contains("lake_nets")))%>%
  dplyr::select((-contains("_id")))%>%
  dplyr::select((-contains("lake")))%>%
  dplyr::select((-contains("code")))%>%
  dplyr::select((-contains("zone")))%>%
    dplyr::select((-contains("ws_")))%>%
    dplyr::select((-contains("nws_")))%>%
  # dplyr::select(everything()) %>%  # replace to your needs
  dplyr::select(-c(1:7))%>%
  dplyr::select(-"has_limno")%>%
  # group_by(connectivity_type)%>%
  summarise_all(funs(sum(!is.na(.)))) %>%
  rownames_to_column() %>%
  pivot_longer(-1) %>%
  dplyr::select(-rowname) %>%
  rename(parameter=name,
         count=value) %>%
  filter(grepl('median', parameter))%>% #filter by string, only include median values
  arrange(desc(count))


#How many lakes have both TP and no2_no3?
nonNAs_TPNO3<-dt1_western %>%
  dplyr::select(lagoslakeid, tp_ugl_median, no2no3n_ugl_median)%>%
  drop_na(tp_ugl_median,no2no3n_ugl_median) %>%
  summarise_all(funs(sum(!is.na(.)))) %>%
  rownames_to_column() %>%
  pivot_longer(-1) %>%
  dplyr::select(-rowname) %>%
  rename(parameter=name,
         count=value) %>%
  filter(grepl('median', parameter))%>% #filter by string, only include median values
  arrange(desc(count))


nonNAs_TPNO3secchi<-dt1_western %>%
  dplyr::select(lagoslakeid, tp_ugl_median, no2no3n_ugl_median,secchi_m_median)%>%
  drop_na(tp_ugl_median,no2no3n_ugl_median,secchi_m_median) %>%
  summarise_all(funs(sum(!is.na(.)))) %>%
  rownames_to_column() %>%
  pivot_longer(-1) %>%
  dplyr::select(-rowname) %>%
  rename(parameter=name,
         count=value) %>%
  filter(grepl('median', parameter))%>% #filter by string, only include median values
  arrange(desc(count))

nonNAs_TPNO3NH<-dt1_western %>%
  dplyr::select(lagoslakeid, tp_ugl_median, no2no3n_ugl_median,nh4n_ugl_median)%>%
  drop_na(tp_ugl_median,no2no3n_ugl_median,nh4n_ugl_median) %>%
  summarise_all(funs(sum(!is.na(.)))) %>%
  rownames_to_column() %>%
  pivot_longer(-1) %>%
  dplyr::select(-rowname) %>%
  rename(parameter=name,
         count=value) %>%
  filter(grepl('median', parameter))%>% #filter by string, only include median values
  arrange(desc(count))

```

#### no2no3n_ugl 
```{r}
#Map them
ggplot()+
  geom_sf(data = us,color = "black")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -100), ylim = c(30, 49))+
  geom_point(data=dt1_western %>%
               filter(!no2no3n_ugl=="NA"), aes(site_lon_decdeg, site_lat_decdeg, fill=log10(no2no3n_ugl), shape=connectivity_type))+
  scale_fill_viridis_c()+
  scale_shape_manual(values=c(21,25))

#When were they sampled? 
dt1_western %>%
  dplyr::select(lagoslakeid,connectivity_type, year, no2no3n_ugl) %>%
  group_by(connectivity_type, year)%>%
  summarize(n=length(unique(lagoslakeid)))%>%
    drop_na(year)%>%
  ggplot(aes(x=connectivity_type, y=n, fill=connectivity_type))+
  geom_bar(stat="identity",  color="black")+
  scale_fill_viridis_d()+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=6))+
  facet_wrap(~year, scales="free")+
  ggtitle("Number of lakes sampled for no2no3n_ugL per year, connectivity type")



#Which lakes have > 10 years of no2no3n_ugl data?
no2no3n_ugl_LT_lakes<-dt1_western%>%
  dplyr::select(lagoslakeid, no2no3n_ugl_median, year)%>%
  drop_na(no2no3n_ugl_median) %>%
  group_by(lagoslakeid) %>%
  summarize(n_years_sampled=length(unique(year))) %>%
  arrange(desc(n_years_sampled)) %>%
  filter(n_years_sampled>=10) %>%
  pivot_wider(names_from=lagoslakeid, values_from=n_years_sampled) %>%
  names()

#Any changes through time? 
dt1_western %>% 
  dplyr::select(hu4_zoneid,net_id,lake_centroidstate,lagoslakeid, year, no2no3n_ugl_median) %>%
  filter(lagoslakeid %in% no2no3n_ugl_LT_lakes) %>% 
  ggplot(aes(x=as.numeric(as.character(year)),y=log10(no2no3n_ugl_median),
             fill=net_id, group=lagoslakeid, color=net_id)) +
  geom_point(shape=21,size=2.5)+
  geom_smooth(method="lm", se=FALSE)+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  facet_wrap(~hu4_zoneid, scales="free")

#Any changes through time? 
dt1_western %>% 
  filter(lagoslakeid %in% no2no3n_ugl_LT_lakes) %>% 
  ggplot(aes(x=as.numeric(as.character(year)),y=log10(no2no3n_ugl_median),
             fill=lake_elevation_m, color=lake_elevation_m,
             group=lagoslakeid)) +
  geom_point(shape=21,size=2.5)+
  geom_smooth(method="lm", se=FALSE)+
  scale_fill_viridis_c()+
  scale_color_viridis_c() +
  facet_wrap(~hu4_zoneid, scales="free_y")

#Create dataframe with a sen slope for each lake
no2no3n_long<-dt1_western %>% 
  filter(lagoslakeid %in% no2no3n_ugl_LT_lakes) %>%
  dplyr::select(lagoslakeid, year, no2no3n_ugl_median) %>%
  mutate(year=as.numeric(as.character(year))) 

#**Runs Theil Sen's slopes on each variable####
#Includes summary stats of significant slopes
NO2NO3N.SensSlopeSummary<-
  no2no3n_long%>%
  group_by(lagoslakeid)%>%
  summarize(Sens_Slope=sensSlope(x=year,y=no2no3n_ugl_median)$coefficients["year"],
            Sens_Intercept=sensSlope(x=year,y=no2no3n_ugl_median)$coefficients["Intercept"],
            Sens_pval=sensSlope(x=year,y=no2no3n_ugl_median)$pval,
            Sens_z_stat=sensSlope(x=year,y=no2no3n_ugl_median)$z_stat,
            Sens_n=sensSlope(x=year,y=no2no3n_ugl_median)$n)%>%
  mutate(Significance=ifelse(Sens_pval<0.05,"*","NS")) %>%
  mutate(variable="no2no3n_ugl_median")

NO2NO3N.SensSlopeSummary
#Welp, despite how it looks, there is only one site where this trend is significant. 
Trending_NO2NO3N_lakes<-NO2NO3N.SensSlopeSummary %>%
  filter(Significance=="*") %>%
  dplyr::select(lagoslakeid, Sens_Slope) %>%
  pivot_wider(names_from=lagoslakeid, values_from=Sens_Slope) %>%
  names()

#Plot only the lakes with a statistically significant sen slope
dt1_western %>% 
  filter(lagoslakeid %in% Trending_NO2NO3N_lakes) %>% 
  ggplot(aes(x=as.numeric(as.character(year)),y=(no2no3n_ugl),
             fill=lagoslakeid, group=lagoslakeid, color=lagoslakeid)) +
  geom_point(shape=21,size=2.5)+
  geom_smooth(method="lm", se=FALSE)+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  facet_wrap(~lagoslakeid, scales="free")

```


#### tp_ugl 
```{r}
#Map them
ggplot()+
  geom_sf(data = us,color = "black")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -100), ylim = c(30, 49))+
  geom_point(data=dt1_western %>%
               filter(!tp_ugl=="NA"), aes(site_lon_decdeg, site_lat_decdeg, fill=log10(tp_ugl), shape=connectivity_type))+
  scale_fill_viridis_c()+
  scale_shape_manual(values=c(21,25))

#When were they sampled? 
dt1_western %>%
  dplyr::select(lagoslakeid,connectivity_type, year, tp_ugl) %>%
  group_by(connectivity_type, year)%>%
  summarize(n=length(unique(lagoslakeid)))%>%
  drop_na(year)%>%
  ggplot(aes(x=connectivity_type, y=n, fill=connectivity_type))+
  geom_bar(stat="identity",  color="black")+
  scale_fill_viridis_d()+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=6))+
  facet_wrap(~year, scales="free")+
  ggtitle("Number of lakes sampled for tp_ugl per year, connectivity type")


#Which lakes have > 10 years of tp data?
tp_ugl_LT_lakes<-nutrientsalgae%>%
  dplyr::select(lagoslakeid, tp_ugl_median, year)%>%
  drop_na(tp_ugl_median) %>%
  group_by(lagoslakeid) %>%
  summarize(n_years_sampled=length(unique(year))) %>%
  arrange(desc(n_years_sampled)) %>%
  filter(n_years_sampled>=10) %>%
  pivot_wider(names_from=lagoslakeid, values_from=n_years_sampled) %>%
  names()

#Any changes through time? 
dt1_western %>% 
  # dplyr::select(hu4_zoneid,net_id,lake_centroidstate,lagoslakeid, year, no2no3n_ugl) %>%
  filter(lagoslakeid %in% tp_ugl_LT_lakes) %>% 
  ggplot(aes(x=as.numeric(as.character(year)),y=log10(tp_ugl_median),
             fill=net_id, group=lagoslakeid, color=net_id)) +
  geom_point(shape=21,size=2.5)+
  geom_smooth(method="lm", se=FALSE)+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  facet_wrap(~hu4_zoneid, scales="free")


#Create dataframe with a sen slope for each lake
TP_long<-dt1_western %>% 
  filter(lagoslakeid %in% tp_ugl_LT_lakes) %>%
  dplyr::select(lagoslakeid, year, tp_ugl_median) %>%
  mutate(year=as.numeric(as.character(year))) 

#**Runs Theil Sen's slopes on each variable####
#Includes summary stats of significant slopes
TP.SensSlopeSummary<-
  TP_long%>%
  group_by(lagoslakeid)%>%
  summarize(Sens_Slope=sensSlope(x=year,y=tp_ugl_median)$coefficients["year"],
            Sens_Intercept=sensSlope(x=year,y=tp_ugl_median)$coefficients["Intercept"],
            Sens_pval=sensSlope(x=year,y=tp_ugl_median)$pval,
            Sens_z_stat=sensSlope(x=year,y=tp_ugl_median)$z_stat,
            Sens_n=sensSlope(x=year,y=tp_ugl_median)$n)%>%
  mutate(Significance=ifelse(Sens_pval<0.05,"*","NS")) %>%
  mutate(variable="tp_ugl_median")

TP.SensSlopeSummary %>%
  filter(Significance=="*")

```



#### nh4n_ugl 
```{r}
#Map them
ggplot()+
  geom_sf(data = us,color = "black")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -100), ylim = c(30, 49))+
  geom_point(data=dt1_western %>%
               filter(!nh4n_ugl=="NA"), aes(site_lon_decdeg, site_lat_decdeg, fill=log10(nh4n_ugl), shape=connectivity_type))+
  scale_fill_viridis_c()+
  scale_shape_manual(values=c(21,25))

#When were they sampled? 
dt1_western %>%
  dplyr::select(lagoslakeid,connectivity_type, year, nh4n_ugl) %>%
  group_by(connectivity_type, year)%>%
  summarize(n=length(unique(lagoslakeid)))%>%
  drop_na(year)%>%
  ggplot(aes(x=connectivity_type, y=n, fill=connectivity_type))+
  geom_bar(stat="identity",  color="black")+
  scale_fill_viridis_d()+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=6))+
  facet_wrap(~year, scales="free")+
  ggtitle("Number of lakes sampled for nh4n_ugl per year, connectivity type")


#Which lakes have > 10 years of no2no3n_ugl data?
nh4n_ugl_LT_lakes<-dt1_western%>%
  dplyr::select(lagoslakeid, nh4n_ugl_median, year)%>%
  drop_na(nh4n_ugl_median) %>%
  group_by(lagoslakeid) %>%
  summarize(n_years_sampled=length(unique(year))) %>%
  arrange(desc(n_years_sampled)) %>%
  filter(n_years_sampled>=10) %>%
  pivot_wider(names_from=lagoslakeid, values_from=n_years_sampled) %>%
  names()


#Any changes through time? 
dt1_western %>% 
  filter(lagoslakeid %in% nh4n_ugl_LT_lakes) %>% 
  ggplot(aes(x=as.numeric(as.character(year)),y=log10(nh4n_ugl),
             fill=lake_elevation_m, color=lake_elevation_m,
             group=lagoslakeid)) +
  geom_point(shape=21,size=2.5)+
  geom_smooth(method="lm", se=FALSE)+
  scale_fill_viridis_c()+
  scale_color_viridis_c() +
  facet_wrap(~hu4_zoneid, scales="free_y")


#Create dataframe with a sen slope for each lake
NH4_long<-dt1_western %>% 
  filter(lagoslakeid %in% nh4n_ugl_LT_lakes) %>%
  dplyr::select(lagoslakeid, year, nh4n_ugl) %>%
  mutate(year=as.numeric(as.character(year))) 

#**Runs Theil Sen's slopes on each variable####
#Includes summary stats of significant slopes
NH4.SensSlopeSummary<-
  NH4_long%>%
  group_by(lagoslakeid)%>%
  summarize(Sens_Slope=sensSlope(x=year,y=nh4n_ugl)$coefficients["year"],
            Sens_Intercept=sensSlope(x=year,y=nh4n_ugl)$coefficients["Intercept"],
            Sens_pval=sensSlope(x=year,y=nh4n_ugl)$pval,
            Sens_z_stat=sensSlope(x=year,y=nh4n_ugl)$z_stat,
            Sens_n=sensSlope(x=year,y=nh4n_ugl)$n)%>%
  mutate(Significance=ifelse(Sens_pval<0.05,"*","NS")) %>%
  mutate(variable="nh4n_ugl")

NH4.SensSlopeSummary %>%
  filter(Significance=="*")

```



#### chla_ugl 
```{r}
#Map them
ggplot()+
  geom_sf(data = us,color = "black")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -100), ylim = c(30, 49))+
  geom_point(data=dt1_western %>%
               filter(!chla_ugl=="NA"), aes(site_lon_decdeg, site_lat_decdeg, fill=log10(chla_ugl), shape=connectivity_type))+
  scale_fill_gradientn(colors=c("red","green"))+
  scale_shape_manual(values=c(21,25))

#When were they sampled? 
dt1_western %>%
  dplyr::select(lagoslakeid,connectivity_type, year, chla_ugl) %>%
  group_by(connectivity_type, year)%>%
  summarize(n=length(unique(lagoslakeid)))%>%
  drop_na(year)%>%
  ggplot(aes(x=connectivity_type, y=n, fill=connectivity_type))+
  geom_bar(stat="identity",  color="black")+
  scale_fill_viridis_d()+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=6))+
  facet_wrap(~year, scales="free")+
  ggtitle("Number of lakes sampled for chla_ugl per year, connectivity type")


#Which lakes have > 10 years of chla_ugl data?
chla_ugl_LT_lakes<-dt1_western%>%
  dplyr::select(lagoslakeid, chla_ugl_median, year)%>%
  drop_na(chla_ugl_median) %>%
  group_by(lagoslakeid) %>%
  summarize(n_years_sampled=length(unique(year))) %>%
  arrange(desc(n_years_sampled)) %>%
  filter(n_years_sampled>=10) %>%
  pivot_wider(names_from=lagoslakeid, values_from=n_years_sampled) %>%
  names()

#Any changes through time? 
dt1_western %>% 
  # dplyr::select(hu4_zoneid,net_id,lake_centroidstate,lagoslakeid, year, no2no3n_ugl) %>%
  filter(lagoslakeid %in% chla_ugl_LT_lakes) %>% 
  ggplot(aes(x=as.numeric(as.character(year)),y=chla_ugl,fill=lagoslakeid,
             group=lagoslakeid)) +
  geom_point(shape=21,size=2.5)+
  geom_smooth(method="lm", se=FALSE)+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  facet_wrap(~lagoslakeid, scales="free")


#Which lakes have > 5 years of chla_ugl data?
chla_ugl_LT_5years_lakes<-nutrientsalgae%>%
  dplyr::select(lagoslakeid, chla_ugl, year)%>%
  drop_na(chla_ugl) %>%
  group_by(lagoslakeid) %>%
  summarize(n_years_sampled=length(unique(year))) %>%
  arrange(desc(n_years_sampled)) %>%
  filter(n_years_sampled>=5) %>%
  pivot_wider(names_from=lagoslakeid, values_from=n_years_sampled) %>%
  names()

dt1_western %>% 
  # dplyr::select(hu4_zoneid,net_id,lake_centroidstate,lagoslakeid, year, no2no3n_ugl) %>%
  filter(lagoslakeid %in% chla_ugl_LT_5years_lakes) %>% 
  ggplot(aes(x=as.numeric(as.character(year)),y=chla_ugl,fill=lagoslakeid,
             group=lagoslakeid)) +
  geom_point(shape=21,size=2.5)+
  geom_smooth(method="lm", se=FALSE)+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  facet_wrap(~lake_centroidstate, scales="free")

#Which lakes have been sampled in the last 20 years?
chla_20years_data<-nutrientsalgae%>%
  dplyr::select(lagoslakeid, chla_ugl, year)%>%
  drop_na(chla_ugl) %>%
  mutate(year2=as.numeric(as.character(year)))%>%
  filter(year2>=2000)%>%
  group_by(year) %>%
  summarize(n_lakes_sampled=length(unique(lagoslakeid))) %>%
  arrange(desc(n_lakes_sampled)) 

#Graph number of lakes sampled per year
chla_20years_data %>%
  # dplyr::select(lagoslakeid,connectivity_type, year, chla_ugl) %>%
  # group_by(connectivity_type, year)%>%
  # summarize(n=length(unique(lagoslakeid)))%>%
  # drop_na(year)%>%
  ggplot(aes(x=year, y=n_lakes_sampled))+
  geom_bar(stat="identity",  color="black")+
  # scale_fill_viridis_d()+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=9))+
  geom_text(aes(label = n_lakes_sampled),
              position = position_stack(vjust = .5))

#Wow. For the whole western US it's only something like < 50 lakes a year sampled for chlorophyll a?!? Insane. 

#Create dataframe with a sen slope for each lake
CHL_long<-dt1_western %>% 
  filter(lagoslakeid %in% chla_ugl_LT_lakes) %>%
  dplyr::select(lagoslakeid, year, chla_ugl) %>%
  mutate(year=as.numeric(as.character(year))) 

#**Runs Theil Sen's slopes on each variable####
#Includes summary stats of significant slopes
CHL.SensSlopeSummary<-
  CHL_long%>%
  group_by(lagoslakeid)%>%
  summarize(Sens_Slope=sensSlope(x=year,y=chla_ugl)$coefficients["year"],
            Sens_Intercept=sensSlope(x=year,y=chla_ugl)$coefficients["Intercept"],
            Sens_pval=sensSlope(x=year,y=chla_ugl)$pval,
            Sens_z_stat=sensSlope(x=year,y=chla_ugl)$z_stat,
            Sens_n=sensSlope(x=year,y=chla_ugl)$n)%>%
  mutate(Significance=ifelse(Sens_pval<0.05,"*","NS")) %>%
  mutate(variable="chla_ugl")

CHL.SensSlopeSummary


#Pull out the lakes that were sampled in EPA NLA 2007 and 2012. Are any of them sampled in other years?



```


#### doc_mgl
```{r}
#Map them
ggplot()+
  geom_sf(data = us,color = "black")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -100), ylim = c(30, 49))+
  geom_point(data=dt1_western %>%
               filter(!doc_mgl=="NA"), aes(site_lon_decdeg, site_lat_decdeg, fill=log10(doc_mgl), shape=connectivity_type))+
  scale_fill_gradientn(colors=c("white","brown"))+
  scale_shape_manual(values=c(21,25))

#When were they sampled? 
dt1_western %>%
  dplyr::select(lagoslakeid,connectivity_type, year, doc_mgl) %>%
  group_by(connectivity_type, year)%>%
  summarize(n=length(unique(lagoslakeid)))%>%
  drop_na(year)%>%
  ggplot(aes(x=connectivity_type, y=n, fill=connectivity_type))+
  geom_bar(stat="identity",  color="black")+
  scale_fill_viridis_d()+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=6))+
  facet_wrap(~year, scales="free")+
  ggtitle("Number of lakes sampled for doc_mgl per year, connectivity type")


#Which lakes have > 10 years of chla_ugl data?
doc_mgl_LT_lakes<-dt1_western%>%
  dplyr::select(lagoslakeid, doc_mgl_median, year)%>%
  drop_na(doc_mgl_median) %>%
  group_by(lagoslakeid) %>%
  summarize(n_years_sampled=length(unique(year))) %>%
  arrange(desc(n_years_sampled)) %>%
  filter(n_years_sampled>=10) %>%
  pivot_wider(names_from=lagoslakeid, values_from=n_years_sampled) %>%
  names()

#Any changes through time? 
dt1_western %>% 
  # dplyr::select(hu4_zoneid,net_id,lake_centroidstate,lagoslakeid, year, no2no3n_ugl) %>%
  filter(lagoslakeid %in% doc_mgl_LT_lakes) %>% 
  ggplot(aes(x=as.numeric(as.character(year)),y=doc_mgl,fill=lake_namegnis,
             group=lake_namegnis)) +
  geom_point(shape=21,size=2.5)+
  geom_smooth(method="lm", se=FALSE)+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  facet_wrap(~lake_states, scales="free_y")
#Wow. All the longterm DOC data except one is in Colorado. And nearly every lake is seeing in increase in DOC.
#I also think they are all reservoirs 

#Where are those lakes? Pull out lagoslakeid
CO_DOC<-dt1_western %>% 
  # dplyr::select(hu4_zoneid,net_id,lake_centroidstate,lagoslakeid, year, no2no3n_ugl) %>%
  filter(lagoslakeid %in% doc_mgl_LT_lakes) %>%
  filter(lake_states=="CO")%>%
  dplyr::select(lagoslakeid, lake_lon_decdeg) %>% 
  pivot_wider(names_from=lagoslakeid, values_from=lake_lon_decdeg,
              values_fn = mean) %>%
  names()

#Map em -- Commented out because it's not mapping all the lakes correctly
# ws_CO_DOC<-query_gis(layer = "nws", 
#                       id_name = "lagoslakeid",
#                       ids = CO_DOC)
# lakes_CO_DOC<-query_gis(layer = "lake", 
#                       id_name = "lagoslakeid",
#                       ids = CO_DOC)
# 
# mapview(ws_CO_DOC, color = "black", col.regions = "green") + mapview(lakes_CO_DOC, color = "black", col.regions = "blue")


dt1_western %>% 
  filter(lagoslakeid %in% doc_mgl_LT_lakes) %>%
  filter(lake_states=="CO")%>%
  ggplot(aes(x=as.numeric(as.character(year)),y=doc_mgl,fill=temp_degc,
             group=lagoslakeid)) +
  geom_point(shape=21,size=2.5)+
  geom_smooth(method="lm", se=FALSE)+
  scale_fill_viridis_c()+
  scale_color_viridis_c()
  # facet_wrap(~lagoslakeid, scales="free_y")

#Create dataframe with a sen slope for each lake
DOC_long<-dt1_western %>% 
  filter(lagoslakeid %in% doc_mgl_LT_lakes) %>%
  filter(lake_states=="CO") %>%
  dplyr::select(lagoslakeid, year, doc_mgl) %>%
  mutate(year=as.numeric(as.character(year))) %>%
  drop_na()

#**Runs Theil Sen's slopes on each variable####
#Includes summary stats of significant slopes
DOC.SensSlopeSummary<-
  DOC_long%>%
  group_by(lagoslakeid)%>%
  summarize(Sens_Slope=sensSlope(x=year,y=doc_mgl)$coefficients["year"],
            Sens_Intercept=sensSlope(x=year,y=doc_mgl)$coefficients["Intercept"],
            Sens_pval=sensSlope(x=year,y=doc_mgl)$pval,
            Sens_z_stat=sensSlope(x=year,y=doc_mgl)$z_stat,
            Sens_n=sensSlope(x=year,y=doc_mgl)$n)%>%
  mutate(Significance=ifelse(Sens_pval<0.05,"*","NS")) %>%
  mutate(variable="doc_mgl")

DOC.SensSlopeSummary
#Welp, despite how it looks, there is only one site where this trend is significant. 

```


#### secchi_m
```{r}
#Map them
ggplot()+
  geom_sf(data = us,color = "black")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -100), ylim = c(30, 49))+
  geom_point(data=dt1_western %>%
               filter(!secchi_m=="NA"), aes(site_lon_decdeg, site_lat_decdeg, fill=secchi_m, shape=connectivity_type))+
  scale_fill_gradientn(colors=c("white","brown"))+
  scale_shape_manual(values=c(21,25))

#When were they sampled? 
dt1_western %>%
  dplyr::select(lagoslakeid,connectivity_type, year, secchi_m) %>%
  group_by(connectivity_type, year)%>%
  summarize(n=length(unique(lagoslakeid)))%>%
  drop_na(year)%>%
  ggplot(aes(x=connectivity_type, y=n, fill=connectivity_type))+
  geom_bar(stat="identity",  color="black")+
  scale_fill_viridis_d()+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=6))+
  facet_wrap(~year, scales="free")+
  ggtitle("Number of lakes sampled for secchi_m per year, connectivity type")


#Which lakes have > 10 years of chla_ugl data?
secchi_m_LT_lakes<-dt1_western%>%
  dplyr::select(lagoslakeid, secchi_m_median, year)%>%
  drop_na(secchi_m_median) %>%
  group_by(lagoslakeid) %>%
  summarize(n_years_sampled=length(unique(year))) %>%
  arrange(desc(n_years_sampled)) %>%
  filter(n_years_sampled>=10) %>%
  pivot_wider(names_from=lagoslakeid, values_from=n_years_sampled) %>%
  names()

#Any changes through time? 
dt1_western %>% 
  # dplyr::select(hu4_zoneid,net_id,lake_centroidstate,lagoslakeid, year, no2no3n_ugl) %>%
  filter(lagoslakeid %in% secchi_m_LT_lakes) %>% 
  ggplot(aes(x=as.numeric(as.character(year)),
             y=secchi_m,fill=lagoslakeid,
             color=lagoslakeid,
             group=lagoslakeid)) +
  geom_point(shape=21,size=2.5)+
  geom_smooth(method="lm", se=FALSE, size=0.5)+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  facet_wrap(~lake_states, scales="free_y")+
  theme(legend.position="none")
#Vast majortiy of the lakes are in UT, CO, WA. May be a product of where all the lakes actaully are (Something to also look into)


#Create dataframe with a sen slope for each lake
Secchi_long<-dt1_western %>% 
  filter(lagoslakeid %in% secchi_m_LT_lakes) %>%
  dplyr::select(lagoslakeid, year, secchi_m) %>%
  mutate(year=as.numeric(as.character(year))) %>%
  drop_na()

#**Runs Theil Sen's slopes on each variable####
#Includes summary stats of significant slopes
Secchi.SensSlopeSummary<-
  Secchi_long%>%
  group_by(lagoslakeid)%>%
  summarize(Sens_Slope=sensSlope(x=year,y=secchi_m)$coefficients["year"],
            Sens_Intercept=sensSlope(x=year,y=secchi_m)$coefficients["Intercept"],
            Sens_pval=sensSlope(x=year,y=secchi_m)$pval,
            Sens_z_stat=sensSlope(x=year,y=secchi_m)$z_stat,
            Sens_n=sensSlope(x=year,y=secchi_m)$n)%>%
  mutate(Significance=ifelse(Sens_pval<0.05,"*","NS")) %>%
  mutate(variable="secchi_m")

Secchi.SensSlopeSummary
#No trend in most lakes. Which lakes do have a trend? 


Trending_secchi_lakes<-Secchi.SensSlopeSummary %>%
  filter(Significance=="*") %>%
  dplyr::select(lagoslakeid, Sens_Slope) %>%
  pivot_wider(names_from=lagoslakeid, values_from=Sens_Slope) %>%
  names()
#Proportion of lakes with a trend
length(Trending_secchi_lakes)/length(secchi_m_LT_lakes)

#Plot only the lakes with a statistically significant sen slope
dt1_western %>% 
  filter(lagoslakeid %in% Trending_secchi_lakes) %>% 
  ggplot(aes(x=as.numeric(as.character(year)),y=(secchi_m),
             fill=lagoslakeid, group=lagoslakeid, color=lagoslakeid)) +
  geom_point(shape=21,size=2.5)+
  geom_smooth(method="lm", se=FALSE)+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  facet_wrap(~lagoslakeid, scales="free")


#Where are they? 
secchi_LT_lakes_WS<-query_gis(layer = "ws", 
                      id_name = "lagoslakeid",
                      ids = Trending_secchi_lakes)
secchi_LT_lakes_points<-query_gis(layer = "lake", 
                      id_name = "lagoslakeid",
                      ids = Trending_secchi_lakes)

mapview(secchi_LT_lakes_WS, color = "black", col.regions = "green") + mapview(secchi_LT_lakes_points, color = "black", col.regions = "blue") 
```


#### temp_degc
```{r}
#Because temperature is so dependent on the timing of sampling, I was to use a different dataframe for this.

#Which lakes have > 10 years of temperature data?
temp_LT_lakes<-dt1_western%>%
  dplyr::select(lagoslakeid, temp_degc_median, year)%>%
  drop_na(temp_degc_median) %>%
  group_by(lagoslakeid) %>%
  summarize(n_years_sampled=length(unique(year))) %>%
  arrange(desc(n_years_sampled)) %>%
  filter(n_years_sampled>=10) %>%
  pivot_wider(names_from=lagoslakeid, values_from=n_years_sampled) %>%
  names()
```

## Summarize LT trends
```{r}

MASTER.SenSlopeSummary<-bind_rows(Secchi.SensSlopeSummary,
          NH4.SensSlopeSummary,
          TP.SensSlopeSummary,
          CHL.SensSlopeSummary,
          NO2NO3N.SensSlopeSummary,
          DOC.SensSlopeSummary)

#Visualize which lakes have trends on multiple variables

MASTER.SenSlopeSummary %>%
  filter(Significance=="*") %>%
  ggplot(aes(x=lagoslakeid, y=Sens_Slope, fill=lagoslakeid))+
  geom_bar(stat="identity",  color="black")+
  scale_fill_viridis_d()+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=6))+
  facet_wrap(~variable, scales="free")+
  geom_text(aes(label = Sens_n),
              position = position_stack(vjust = .5))+
  ggtitle("Lakes with Sens_pval < 0.05; y-axis is the Sens slope and the number printed is the number of years each lake was sampled")

#For each variable, show the trends by lake. 
MASTER.SenSlopeSummary %>%
  ggplot(aes(x=lagoslakeid, y=Sens_Slope, fill=Significance))+
  geom_bar(stat="identity",  color="black")+
  scale_fill_manual(values=c("blue","white"))+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=6))+
  facet_wrap(~variable, scales="free_y", nrow=6)
  # ggtitle("Lakes with Sens_pval < 0.05; y-axis is the Sens slope and the number printed is the number of years each lake was sampled")



```

#### Export tables
```{r}
SenSlope_Table<-MASTER.SenSlopeSummary %>%
  dplyr::select(variable, lagoslakeid, Sens_Slope, Sens_pval, Significance) %>%
  arrange(lagoslakeid, variable, Significance) %>%
  mutate(Sens_Slope=round(Sens_Slope,2),
         Sens_pval=round(Sens_pval,2))



no2no3n_summary<-data.frame(
  variable="no2no3n_ugL",
  total_lakes=length(no2no3n_ugl_LT_lakes),
  trending_lakes=NH4.SensSlopeSummary %>%
                  filter(Significance=="*") %>%
                  nrow(.)) %>%
  mutate(perc_trending=round((trending_lakes/total_lakes)*100))

tp_summary<-data.frame(
  variable="tp_ugL",
  total_lakes=length(tp_ugl_LT_lakes),
  trending_lakes=TP.SensSlopeSummary %>%
                  filter(Significance=="*") %>%
                  nrow(.)) %>%
  mutate(perc_trending=round((trending_lakes/total_lakes)*100))

nh4n_summary<-data.frame(
  variable="nh4n_ugL",
  total_lakes=length(nh4n_ugl_LT_lakes),
  trending_lakes=NH4.SensSlopeSummary %>%
                  filter(Significance=="*") %>%
                  nrow(.)) %>%
  mutate(perc_trending=round((trending_lakes/total_lakes)*100))

chla_summary<-data.frame(
  variable="chla_ugL",
  total_lakes=length(chla_ugl_LT_lakes),
  trending_lakes=CHL.SensSlopeSummary %>%
                  filter(Significance=="*") %>%
                  nrow(.)) %>%
  mutate(perc_trending=round((trending_lakes/total_lakes)*100))

doc_summary<-data.frame(
  variable="doc_mgl",
  total_lakes=length(doc_mgl_LT_lakes),
  trending_lakes=DOC.SensSlopeSummary %>%
                  filter(Significance=="*") %>%
                  nrow(.)) %>%
  mutate(perc_trending=round((trending_lakes/total_lakes)*100))
   
secchi_summary<-data.frame(
  variable="secchi_m",
  total_lakes=length(secchi_m_LT_lakes),
  trending_lakes=Secchi.SensSlopeSummary %>%
                  filter(Significance=="*") %>%
                  length(.)) %>%
  mutate(perc_trending=round((trending_lakes/total_lakes)*100))
   
LT_data_summary_Table<-bind_rows(no2no3n_summary,
                                 tp_summary,
                                 nh4n_summary,
                                 chla_summary,
                                 doc_summary,
                                 secchi_summary)

library(huxtable)

SenSlope_Table_hux<-  hux(SenSlope_Table) %>% 
  # add_colnames() %>%
  set_bold(row = 1, col = everywhere, value = TRUE) %>% 
  set_all_borders(TRUE) %>%
          set_font_size(8) %>% 
      set_lr_padding(2) %>% 
      set_position("left")
SenSlope_Table_hux

LT_data_summary_Table_hux<-  hux(LT_data_summary_Table) %>% 
  # add_colnames() %>%
  set_bold(row = 1, col = everywhere, value = TRUE) %>% 
  set_all_borders(TRUE) %>%
          set_font_size(8) %>% 
      set_lr_padding(2) %>% 
      set_position("left")
LT_data_summary_Table_hux

  #export as Excel sheet
library(openxlsx)
# multiple sheets in a single workbook:
wb <- openxlsx::createWorkbook()
wb <- as_Workbook(LT_data_summary_Table_hux,
      Workbook = wb, sheet = "sheet1")
wb <- as_Workbook(
      hux(SenSlope_Table_hux),
      Workbook = wb,
      sheet = "sheet2")

saveWorkbook(wb, "tables/longterm_lagosWesternUS_summary.xlsx", overwrite = TRUE)


```

# Spatial patterns

## What exists?
```{r}
#Number of non-NAs per parameter
nonNAs_spatial<-dt1_western_summary %>%
  dplyr::select((-contains("detectionlimit")))%>%
  dplyr::select((-contains("lake_nets")))%>%
  dplyr::select((-contains("_id")))%>%
  dplyr::select((-contains("lake")))%>%
  dplyr::select((-contains("code")))%>%
  dplyr::select((-contains("zone")))%>%
    dplyr::select((-contains("ws_")))%>%
    dplyr::select((-contains("nws_")))%>%
  # dplyr::select(everything()) %>%  # replace to your needs
  dplyr::select(-c(1:5))%>%
  # dplyr::select(-c("has_limno","decade_sampled"))%>%
  # group_by(connectivity_type)%>%
  summarise_all(funs(sum(!is.na(.)))) %>%
  rownames_to_column() %>%
  pivot_longer(-1) %>%
  dplyr::select(-rowname) %>%
  rename(parameter=name,
         count=value) %>%
  arrange(desc(count))

#Top 10 parameters
nonNAs_spatial[1:10,]

```

### Chl - by decade
```{r}
# library(basemaps)
# library(mapedit)
# get_maptypes()
# 
# set_defaults(map_service = "esri", map_type = "world_shaded_relief")
# set_defaults(map_service = "mapbox", map_type = "satellite",
#              map_token ="pk.eyJ1IjoiYmVsbGFvbGVrc3kiLCJhIjoiY2tydjY1Ym96MDNqNTJvcjBqcnc3MDhsayJ9.UBpnik4qT7GJQt8-h2aKqQ")
# ext<-draw_ext() #manually draw on map
# 
# ggplot() + 
#   basemap_gglayer(ext) + 
#   coord_sf() +
#   scale_fill_identity() 


ggplot()+
  geom_sf(data = us,color = "black")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -100), ylim = c(32, 49), expand=TRUE)+
  geom_point(data=dt1_western_summary %>%
               drop_na(chla_ugl)%>%
               drop_na(decade_sampled), aes(lake_lon_decdeg, lake_lat_decdeg, fill=decade_sampled),
             shape=21, size=2.5)+
  scale_fill_manual(values=c("#ffbe0b","#fb5607","#ff006e","#8338ec","#3a86ff"))+
  ggtitle("All sites with chlorophyll data - fill is median decade sampled ")+
  theme_classic()

dt1_western_summary%>%
  drop_na(decade_sampled)%>%
  drop_na(chla_ugl)%>%
  group_by(decade_sampled) %>%
  summarize(n=length(unique(lagoslakeid)))%>%
  ggplot(aes(x=decade_sampled, y=n, fill=decade_sampled))+
  geom_bar(stat="identity",  color="black")+
  scale_fill_manual(values=c("#ffbe0b","#fb5607","#ff006e","#8338ec","#3a86ff"))+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=10))+
    geom_text(aes(label = n),
              position = position_stack(vjust = .5))+
  ggtitle("For all the lakes sampled for chlorophyll a, grouped by when most of their samples were taken")
```

### Chl - by HUC4
```{r}
dt1_western_summary%>%
  drop_na(decade_sampled)%>%
  drop_na(chla_ugl_median)%>%
  group_by(hu4_zoneid) %>%
  summarize(n=length(unique(lagoslakeid)))%>%
  ggplot(aes(x=reorder(hu4_zoneid, n), y=n, fill=hu4_zoneid))+
  geom_bar(stat="identity",  color="black")+
  # scale_fill_manual(values=c("#ffbe0b","#fb5607","#ff006e","#8338ec","#3a86ff"))+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=10))+
    geom_text(aes(label = n),
              position = position_stack(vjust = .5))+
  ggtitle("Number of lakes sampled for chlorophyll in each HU4 unit")

#Are there differences by HU4 region? Say we pick only the regions with > 10 samples 
dt1_western_summary%>%
  drop_na(decade_sampled)%>%
  drop_na(chla_ugl_median)%>%
  group_by(hu4_zoneid) %>%
  mutate(n=length(unique(lagoslakeid))) %>%
  filter(n>10) %>%
  ggplot(aes(x=reorder(hu4_zoneid, chla_ugl_median, FUN=median), y=log10(chla_ugl_median), fill=hu4_zoneid)) +
  geom_boxplot(outlier.shape = NA)

#Where are they

#Western US
library(nhdplusTools)
# co<-sf::st_as_sf(maps::map("state","colorado", fill=TRUE,plot=FALSE))
us_huc8<-nhdplusTools::get_huc8(us)

co_huc4<- co_huc8 %>%
  mutate(huc4=stringr::str_sub(huc8, 1, 4)) %>%
  group_by(huc4) %>%
  summarize()
ggplot()+
  geom_sf(data=co, fill=NA)+
  geom_sf(data=co_huc4, fill=NA, color="red") +
  theme_void()
```

### TP - spatial gradients
```{r}
ggplot()+
  geom_polygon(data=states, aes(x=long, y=lat, group=group),
               fill=NA, color="black",
               linetype="dashed")+
    geom_sf(data = us,color = "black")+
    geom_sf(data=rivers50, color="lightblue")+  
  annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -100), ylim = c(32, 49), expand=TRUE)+
  geom_point(data=dt1_western_summary %>%
               drop_na(tp_ugl_median), aes(lake_lon_decdeg, lake_lat_decdeg, fill=log10(tp_ugl_median)),
             shape=21, size=2.5, alpha=0.6)+
  scale_fill_continuous_diverging(palette = "Blue-Red")+
  ggtitle("All sites with TP data")+
  theme_classic()


#Watershed with fire in the catchment
ggplot()+
  geom_sf(data=rivers50, color="lightblue")+
  geom_polygon(data=states, aes(x=long, y=lat, group=group),
               fill=NA, color="black",
               linetype="dashed")+
    geom_sf(data = us,color = "black")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -100), ylim = c(32, 49), expand=TRUE)+
  geom_point(data=dt1_western_summary %>%
               drop_na(tp_ugl_median), aes(lake_lon_decdeg, lake_lat_decdeg, fill=log10(PctFire2010Cat)),
             shape=21, size=2.5, alpha=0.6)+
  scale_fill_continuous_diverging(palette = "Blue-Red")+
  ggtitle("All sites with TP data")+
  theme_classic()

```

### TP - by decade
```{r}
# library(basemaps)
# library(mapedit)
# get_maptypes()
# 
# set_defaults(map_service = "esri", map_type = "world_shaded_relief")
# set_defaults(map_service = "mapbox", map_type = "satellite",
#              map_token ="pk.eyJ1IjoiYmVsbGFvbGVrc3kiLCJhIjoiY2tydjY1Ym96MDNqNTJvcjBqcnc3MDhsayJ9.UBpnik4qT7GJQt8-h2aKqQ")
# ext<-draw_ext() #manually draw on map
# 
# ggplot() + 
#   basemap_gglayer(ext) + 
#   coord_sf() +
#   scale_fill_identity() 


ggplot()+
  geom_sf(data = us,color = "black")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -100), ylim = c(32, 49), expand=TRUE)+
  geom_point(data=dt1_western_summary %>%
               drop_na(tp_ugl_median)%>%
               drop_na(decade_sampled), aes(lake_lon_decdeg, lake_lat_decdeg, fill=decade_sampled),
             shape=21, size=2.5)+
  scale_fill_manual(values=c("#ffbe0b","#fb5607","#ff006e","#8338ec","#3a86ff"))+
  ggtitle("All sites with TP data - fill is decade of the median year sampled ")+
  theme_classic()

dt1_western_summary%>%
  drop_na(decade_sampled)%>%
  drop_na(tp_ugl_median)%>%
  group_by(decade_sampled) %>%
  summarize(n=length(unique(lagoslakeid)))%>%
  ggplot(aes(x=decade_sampled, y=n, fill=decade_sampled))+
  geom_bar(stat="identity",  color="black")+
  scale_fill_manual(values=c("#ffbe0b","#fb5607","#ff006e","#8338ec","#3a86ff"))+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=10))+
    geom_text(aes(label = n),
              position = position_stack(vjust = .5))+
  ggtitle("For all the lakes sampled for TP, grouped by when most of their samples were taken")
```

### TP - by HUC4
```{r}
dt1_western_summary%>%
  drop_na(decade_sampled)%>%
  drop_na(tp_ugl_median)%>%
  group_by(hu4_zoneid) %>%
  summarize(n=length(unique(lagoslakeid)))%>%
  ggplot(aes(x=reorder(hu4_zoneid, n), y=n, fill=hu4_zoneid))+
  geom_bar(stat="identity",  color="black")+
  # scale_fill_manual(values=c("#ffbe0b","#fb5607","#ff006e","#8338ec","#3a86ff"))+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=10))+
    geom_text(aes(label = n),
              position = position_stack(vjust = .5))+
  ggtitle("Number of lakes sampled for TP in each HU4 unit")

#Are there differences by HU4 region? Say we pick only the regions with > 10 samples 
dt1_western_summary%>%
  drop_na(decade_sampled)%>%
  drop_na(tp_ugl_median)%>%
  group_by(hu4_zoneid) %>%
  mutate(n=length(unique(lagoslakeid))) %>%
  filter(n>10) %>%
  ggplot(aes(x=reorder(hu4_zoneid, tp_ugl_median, FUN=mean), y=log10(tp_ugl_median), fill=hu4_zoneid)) +
  geom_boxplot(outlier.shape = NA)
```

### TP - by EPA zone ID, WWF, bailey
```{r}

##EPA 
dt1_western_summary%>%
  drop_na(decade_sampled)%>%
  drop_na(tp_ugl_median)%>%
  group_by(epanutr_zoneid) %>%
  summarize(n=length(unique(lagoslakeid)))%>%
  ggplot(aes(x=reorder(epanutr_zoneid, n), y=n, fill=epanutr_zoneid))+
  geom_bar(stat="identity",  color="black")+
  # scale_fill_manual(values=c("#ffbe0b","#fb5607","#ff006e","#8338ec","#3a86ff"))+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=10))+
    geom_text(aes(label = n),
              position = position_stack(vjust = .5))+
  ggtitle("Number of lakes sampled for TP in each EPA zone")

ggplot()+
    geom_sf(data = us,color = "black")+
      geom_polygon(data=states, aes(x=long, y=lat, group=group),
               fill=NA, color="black",
               linetype="dashed")+
    geom_sf(data=rivers50, color="lightblue")+  
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -100), ylim = c(32, 49), expand=TRUE)+
  geom_point(data=dt1_western_summary %>%
               drop_na(tp_ugl_median), aes(lake_lon_decdeg, lake_lat_decdeg, fill=epanutr_zoneid),
             shape=21, size=2.5)+
  scale_fill_manual(values=c("#7f4f24","#b6ad90","#606c38","#dda15e"),
                    labels=c("N. Plains","S. Plains","Western Mtns","Xeric"),
                    name="EPA zone ID")+
  ggtitle("All sites with TP data - EPA zone")+
  theme_classic()

#Are there differences by HU4 region? Say we pick only the regions with > 10 samples 
dt1_western_summary%>%
  drop_na(decade_sampled)%>%
  drop_na(tp_ugl_median)%>%
  group_by(epanutr_zoneid) %>%
  ggplot(aes(x=reorder(epanutr_zoneid, tp_ugl_median, FUN=mean), y=log10(tp_ugl_median), fill=epanutr_zoneid)) +
  scale_fill_manual(values=c("#7f4f24","#b6ad90","#606c38","#dda15e"),
                    labels=c("N. Plains","S. Plains","Western Mtns","Xeric"),
                    name="EPA zone ID")+
  geom_boxplot(outlier.shape = NA)+
  theme(axis.title.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())



##bailey_zoneid 
ggplot()+
    geom_sf(data = us,color = "black")+
      geom_polygon(data=states, aes(x=long, y=lat, group=group),
               fill=NA, color="black",
               linetype="dashed")+
    geom_sf(data=rivers50, color="lightblue")+  
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -100), ylim = c(32, 49), expand=TRUE)+
  geom_point(data=dt1_western_summary %>%
               drop_na(tp_ugl_median), aes(lake_lon_decdeg, lake_lat_decdeg, fill=bailey_zoneid),
             shape=21, size=2.5)+
  # scale_fill_manual(values=c("#ffbe0b","#fb5607","#ff006e","#8338ec","#3a86ff"))+
  ggtitle("All sites with TP data - Bailey zone")+
  theme_classic()+
  theme(legend.position="none")

#Are there differences by HU4 region? Say we pick only the regions with > 10 samples 
dt1_western_summary%>%
  drop_na(decade_sampled)%>%
  drop_na(tp_ugl_median)%>%
  group_by(bailey_zoneid) %>%
  ggplot(aes(x=reorder(bailey_zoneid, tp_ugl_median, FUN=mean), y=log10(tp_ugl_median), fill=bailey_zoneid)) +
  geom_boxplot(outlier.shape = NA)+
    theme_classic()+
  theme(legend.position="none")



##bailey_zoneid 
ggplot()+
    geom_sf(data = us,color = "black")+
      geom_polygon(data=states, aes(x=long, y=lat, group=group),
               fill=NA, color="black",
               linetype="dashed")+
    geom_sf(data=rivers50, color="lightblue")+  
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -100), ylim = c(32, 49), expand=TRUE)+
  geom_point(data=dt1_western_summary %>%
               drop_na(tp_ugl_median), aes(lake_lon_decdeg, lake_lat_decdeg, fill=wwf_zoneid),
             shape=21, size=2.5)+
  # scale_fill_manual(values=c("#ffbe0b","#fb5607","#ff006e","#8338ec","#3a86ff"))+
  ggtitle("All sites with TP data - WWF zone")+
  theme_classic()+
  theme(legend.position="none")

#Are there differences by HU4 region? Say we pick only the regions with > 10 samples 
dt1_western_summary%>%
  drop_na(decade_sampled)%>%
  drop_na(tp_ugl_median)%>%
  group_by(wwf_zoneid) %>%
  ggplot(aes(x=reorder(wwf_zoneid, tp_ugl_median, FUN=mean), y=log10(tp_ugl_median), fill=wwf_zoneid)) +
  geom_boxplot(outlier.shape = NA)+
    theme_classic()+
  theme(legend.position="none")
```



### TP - connectivity patterns
```{r}


#Interesting that you see to have pretty high TP concentrations at high elevations, in all lake classes

dt1_western_summary %>%
  ggplot(aes(x=lake_elevation_m, y=log10(tp_ugl_median), color=lake_connectivity_class,
               fill=lake_connectivity_class))+
  geom_point(size=2.5, shape=21, alpha=0.5)+
  facet_wrap(~lake_connectivity_class)+
  geom_smooth(method="lm",se=F,size=0.5)

dt1_western_summary %>% 
  dplyr::select(tp_ugl_median, lake_lakes1ha_upstream_ha,
                lake_lakes4ha_upstream_ha, lake_lakes10ha_upstream_ha) %>%
  pivot_longer(-1)%>%
  ggplot(aes(x=log10(value), y=log10(tp_ugl_median)))+
  geom_point(size=2.5, shape=21, fill="grey50", alpha=0.5)+
  facet_wrap(~name)+
  geom_smooth(method="lm",se=F, color="black")

#The more upstream lakes there are, the lower the TP concentration of the lake. Makes sense to me. 

dt1_western_summary %>% 
  dplyr::select(tp_ugl_median, lake_lakes1ha_upstream_n,
                lake_lakes4ha_upstream_n, lake_lakes10ha_upstream_n) %>%
  pivot_longer(-1)%>%
  ggplot(aes(x=log10(value), y=log10(tp_ugl_median)))+
  geom_point(size=2.5, shape=21, fill="grey50", alpha=0.5)+
  facet_wrap(~name)+
  geom_smooth(method="lm",se=F, color="black")
#The more upstream lakes there are, the lower the TP concentration of the lake. Makes sense to me. 


#More connectivity patterns
#Isolated lakes lack both inflows and outflows; Headwater lakes have an outflow but no inflow; Drainage lakes have both inflow(s) and outflow(s) and lack upstream connected lake 10 ha in area; DrainageLk lakes have inflow(s) and outflow(s) and have upstream connected lake(s) 10 ha; Terminal lakes have inflows but no outflows and lack an upstream connected lake 10 ha in area; and TerminalLk lakes have inflow(s) but no outflow(s) and have an upstream connected lake(s) 10 ha

dt1_western_summary %>%
  ggplot(aes(x=lake_connectivity_class, y=log10(tp_ugl_median)))+
  geom_boxplot(outlier.shape=NA)

dt1_western_summary %>%
  ggplot(aes(x=lake_connectivity_fluctuates, y=log10(tp_ugl_median)))+
  geom_boxplot(outlier.shape=NA)

#Any scaling relationships between lake connectivity class and lake size, watershed area?
dt1_western_summary %>%
  dplyr::select(lake_connectivity_class, ws_area_ha,
                lake_totalarea_ha) %>%
  pivot_longer(-1)%>%
  ggplot(aes(x=lake_connectivity_class, y=log10(value), fill=name))+
  geom_boxplot(outlier.shape=NA)+
  facet_wrap(~name)
#DrainageLks and TerminalLks have bigger watersheds and are larger in surface area than other lakes
#By definition, they also have a lake >= 10 ha upstream of it. 

#Do we see the same thing if we only include lakes with TP observations? 
dt1_western_summary %>%
  drop_na(tp_ugl_median)%>%
  dplyr::select(lake_connectivity_class, ws_area_ha,
                lake_totalarea_ha) %>%
  pivot_longer(-1)%>%
  ggplot(aes(x=lake_connectivity_class, y=log10(value), fill=name))+
  geom_boxplot(outlier.shape=NA)+
  facet_wrap(~name)
#Yes

#Any relationship between connectivity class and distance to dams?
  ggplot()+
  geom_boxplot(data=dt1_western_summary , aes(x=lake_connectivity_class, y=lake_elevation_m),
               outlier.shape=NA)+
  geom_jitter(data=dt1_western_summary, aes(x=lake_connectivity_class,y=lake_elevation_m,
                                            fill=log10(tp_ugl_median)), alpha=0.5, shape=21)

#Do we see the same thing if we only include lakes with TP observations? 
dt1_western_summary %>%
  dplyr::select(lake_connectivity_class, lake_elevation_m) %>%
  pivot_longer(-1)%>%
  ggplot(aes(y=value, x=lake_connectivity_class, fill=name))+
  geom_boxplot(outlier.shape=NA)+
  geom_jitter(alpha=0.2)+
  facet_wrap(~name)

```

### TP - correlations
```{r}
names(dt1_western_summary)

dt1_western_summary %>%
  dplyr::select(tp_ugl_median, lake_elevation_m, temp_degc_median, do_mgl_median, 
                ws_area_ha, microcystin_ugl_median,  doc_mgl_median, lake_nets_nearestdamup_km) %>%
  mutate(tp_ugl_median=log10(tp_ugl_median),
         ws_area_ha=log10(ws_area_ha),
         doc_mgl_median=log10(doc_mgl_median)) %>%
  ggpairs()

dt1_western_summary %>%
  dplyr::select(tp_ugl_median, lake_elevation_m, temp_degc_median, do_mgl_median, 
                ws_area_ha, microcystin_ugl_median,  doc_mgl_median, lake_nets_nearestdamup_km) %>%
  mutate(tp_ugl_median=log10(tp_ugl_median),
         ws_area_ha=log10(ws_area_ha),
         doc_mgl_median=log10(doc_mgl_median)) %>%
  ggpairs()

dt1_western_summary_numeric<-dplyr::select_if(dt1_western_summary, is.numeric) %>%
  drop_na(tp_ugl_median)

cor<-cor(dt1_western_summary_numeric) %>%
  as.data.frame() %>%
  # rownames_to_column() %>%
  dplyr::select(tp_ugl_median)
```

### DOC - spatial gradients
```{r}

ggplot()+
  geom_sf(data = us,color = "black")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -100), ylim = c(32, 49), expand=TRUE)+
  geom_point(data=dt1_western_summary %>%
               drop_na(doc_mgl), aes(lake_lon_decdeg, lake_lat_decdeg, fill=log10(doc_mgl)),
             shape=21, size=2.5, alpha=0.6)+
  scale_fill_continuous_diverging(palette = "Purple-Green")+
  ggtitle("All sites with DOC data")+
  theme_classic()

test<-dt1_western_summary %>%
  drop_na(doc_mgl)

```

### DOC - by decade
```{r}
# library(basemaps)
# library(mapedit)
# get_maptypes()
# 
# set_defaults(map_service = "esri", map_type = "world_shaded_relief")
# set_defaults(map_service = "mapbox", map_type = "satellite",
#              map_token ="pk.eyJ1IjoiYmVsbGFvbGVrc3kiLCJhIjoiY2tydjY1Ym96MDNqNTJvcjBqcnc3MDhsayJ9.UBpnik4qT7GJQt8-h2aKqQ")
# ext<-draw_ext() #manually draw on map
# 
# ggplot() + 
#   basemap_gglayer(ext) + 
#   coord_sf() +
#   scale_fill_identity() 





ggplot()+
  geom_sf(data = us,color = "black")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -100), ylim = c(32, 49), expand=TRUE)+
  geom_point(data=dt1_western_summary %>%
               drop_na(doc_mgl_median)%>%
               drop_na(decade_sampled), aes(lake_lon_decdeg, lake_lat_decdeg, fill=decade_sampled),
             shape=21, size=2.5)+
  scale_fill_manual(values=c("#ffbe0b","#fb5607","#ff006e","#8338ec","#3a86ff"))+
  ggtitle("All sites with DOC data - fill is median decade sampled ")+
  theme_classic()

dt1_western_summary%>%
  drop_na(decade_sampled)%>%
  drop_na(doc_mgl)%>%
  group_by(decade_sampled) %>%
  summarize(n=length(unique(lagoslakeid)))%>%
  ggplot(aes(x=decade_sampled, y=n, fill=decade_sampled))+
  geom_bar(stat="identity",  color="black")+
  scale_fill_manual(values=c("#ffbe0b","#fb5607","#ff006e","#8338ec","#3a86ff"))+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=10))+
    geom_text(aes(label = n),
              position = position_stack(vjust = .5))+
  ggtitle("For all the lakes sampled for doc, grouped by when most of their samples were taken")
```

### DOC - by HUC4
```{r}
dt1_western_summary%>%
  drop_na(decade_sampled)%>%
  drop_na(doc_mgl)%>%
  group_by(hu4_zoneid) %>%
  summarize(n=length(unique(lagoslakeid)))%>%
  ggplot(aes(x=reorder(hu4_zoneid, n), y=n, fill=hu4_zoneid))+
  geom_bar(stat="identity",  color="black")+
  # scale_fill_manual(values=c("#ffbe0b","#fb5607","#ff006e","#8338ec","#3a86ff"))+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=10))+
    geom_text(aes(label = n),
              position = position_stack(vjust = .5))+
  ggtitle("Number of lakes sampled for doc in each HU4 unit")

#Are there differences by HU4 region? Say we pick only the regions with > 10 samples 
dt1_western_summary%>%
  # drop_na(decade_sampled)%>%
  drop_na(doc_mgl)%>%
  group_by(hu4_zoneid) %>%
  mutate(n=length(unique(lagoslakeid))) %>%
  filter(n>10) %>%
  ggplot(aes(x=reorder(hu4_zoneid, doc_mgl, FUN=median), y=log10(doc_mgl), fill=hu4_zoneid)) +
  geom_boxplot(outlier.shape = NA)
```


### Microcystin - by decade
```{r}
# library(basemaps)
# library(mapedit)
# get_maptypes()
# 
# set_defaults(map_service = "esri", map_type = "world_shaded_relief")
# set_defaults(map_service = "mapbox", map_type = "satellite",
#              map_token ="pk.eyJ1IjoiYmVsbGFvbGVrc3kiLCJhIjoiY2tydjY1Ym96MDNqNTJvcjBqcnc3MDhsayJ9.UBpnik4qT7GJQt8-h2aKqQ")
# ext<-draw_ext() #manually draw on map
# 
# ggplot() + 
#   basemap_gglayer(ext) + 
#   coord_sf() +
#   scale_fill_identity() 


ggplot()+
  geom_sf(data = us,color = "black")+
  geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(-130, -100), ylim = c(32, 49), expand=TRUE)+
  geom_point(data=dt1_western_summary %>%
               drop_na(microcystin_ugl)%>%
               drop_na(decade_sampled), aes(lake_lon_decdeg, lake_lat_decdeg, fill=decade_sampled),
             shape=21, size=2.5)+
  scale_fill_manual(values=c("#ffbe0b","#fb5607","#ff006e","#8338ec","#3a86ff"))+
  ggtitle("All sites with microcystin_ugl data - fill is decade of the median year sampled ")+
  theme_classic()

dt1_western_summary%>%
  drop_na(decade_sampled)%>%
  drop_na(microcystin_ugl)%>%
  group_by(decade_sampled) %>%
  summarize(n=length(unique(lagoslakeid)))%>%
  ggplot(aes(x=decade_sampled, y=n, fill=decade_sampled))+
  geom_bar(stat="identity",  color="black")+
  scale_fill_manual(values=c("#ffbe0b","#fb5607","#ff006e","#8338ec","#3a86ff"))+
    theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle = 45, hjust = 1, size=10))+
    geom_text(aes(label = n),
              position = position_stack(vjust = .5))+
  ggtitle("For all the lakes sampled for microcystin_ugl, grouped by when most of their samples were taken")
```

## Extract clim/elev/spatial data
```{### Feeling cute, might make a global precip map    
```{r}
library(rasterVis)
precip=raster::getData('worldclim', var='prec', res=10)
elev1=raster::getData('SRTM', lon=-110, lat=32)
elev2=raster::getData('SRTM', lon=-120, lat=32)


#Mosaic/merge srtm tiles
elev_mosaic <- mosaic(elev1, elev2, elev3, fun=mean)

#CROP to the extent of the Western US
precip_crop<-crop(precip,us_crop)
elev_crop<-crop(elev_mosaic,us_crop)

#downloaded
elev4<-raster('data/srtm_14_04/srtm_14_04.tif')
elev5<-raster('data/cut_n30w150.tif')

gplot(precip_crop[[1:3]])+geom_raster(aes(fill=value))+
  facet_wrap(~variable)+
  scale_fill_gradientn(colours=c("brown","red","yellow","darkgreen","green"),trans="log10")+
    coord_equal()

gplot(elev_crop)+geom_raster(aes(fill=value))+
  facet_wrap(~variable)+
    scale_fill_gradientn(colours=c("lightgreen","darkgreen","yellow","red","brown","white"))+
    coord_sf(xlim = c(-125, -100), ylim = c(32, 49))+
    geom_point(data=dt1_western %>%
                 drop_na(tp_ugl_median), aes(lake_lon_decdeg, lake_lat_decdeg),
               shape=21, fill="white", alpha=0.3)


gplot(elev5)+geom_raster(aes(fill=value))+
  facet_wrap(~variable)+
    scale_fill_gradientn(colours=c("lightgreen","darkgreen","yellow","red","brown","white"))+
    coord_sf(xlim = c(-130, -100), ylim = c(32, 49))

```

# XG Boost for TP
```{r}

#make this example reproducible
set.seed(0)

#split into training (70%) and testing set (30%)
parts = createDataPartition(dt1_western_summary$tp_ugl_median, p = .7, list = F) #tp 
train = lagos_ne_NAfree_noOutliers[parts, ]
test = lagos_ne_NAfree_noOutliers[-parts, ]

#define predictor and response variables in training set
train_x = data.matrix(train[, -c(1:4)])
train_y = log10(train[,2])#the response variable is chla

#define predictor and response variables in testing set
test_x = data.matrix(test[, -c(1:4)])
test_y = log10(test[, 2]) #the response variable is chla

#fit XGBoost model to training set
xgb_train = xgb.DMatrix(data = train_x, label = train_y)
xgb_test = xgb.DMatrix(data = test_x, label = test_y)

#define watchlist
watchlist = list(train=xgb_train, test=xgb_test)

#fit XGBoost model and display training and testing data at each round
model = xgb.train(data = xgb_train, max.depth = 3, watchlist=watchlist, nrounds = 70)

#define final model
final = xgboost(data = xgb_train, max.depth = 3, nrounds = 56, verbose = 0)

#use model to make predictions on test data
pred_y = predict(final, xgb_test)

#measure prediction accuracy
mean((test_y - pred_y)^2) #mse
caret::MAE(test_y, pred_y) #mae
caret::RMSE(test_y, pred_y) #rmse
rsq_xgboost_chl<-caret::R2(test_y, pred_y) #R2



# size of the prediction vector
# print(length(pred_y))
# limit display of predictions to the first 10
# print(head(pred_y))

#some more metrics from: https://cran.r-project.org/web/packages/xgboost/vignettes/xgboostPresentation.html
importance_matrix <- xgb.importance(model = final)
importance_matrix_top10<- importance_matrix[1:10,]
xgb.plot.importance(importance_matrix = importance_matrix_top10, xlab = "Feature's importance relative to the most importance feature", main="XGBoost top 10 predictors for Chlorophyll a")
xgboost_predictors_chla<-as.character(importance_matrix_top10 %>%select(Feature))

```
